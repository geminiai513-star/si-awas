<!DOCTYPE html>
<html lang="id">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<title>ASISTEN</title>
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="default">
	<meta name="theme-color" content="#ffffff">
	<meta name="apple-mobile-web-app-title" content="ASISTEN">
	<link rel="apple-touch-icon" href="icon/icon-512.png">
	<link rel="icon" type="image/png" href="icon/icon-512.png">

	<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
	<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
	<script src="https://cdn.tailwindcss.com"></script>
	<script src="https://unpkg.com/lucide@latest"></script>
	<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
	<link
		href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono&display=swap"
		rel="stylesheet">
	<style>
		/* CSS ASLI DARI FILE ANDA */
		html,
		body {
			margin: 0;
			padding: 0;
			height: 100%;
			height: 100dvh;
			width: 100vw;
			overflow: hidden !important;
			background-color: #ffffff;
			font-family: 'Inter', sans-serif;
			position: fixed;
			top: 0;
			left: 0;
			overscroll-behavior: none !important;
			touch-action: manipulation;
			touch-action: pan-x pan-y;
   			 -webkit-text-size-adjust: 100%;
		}
		
		*, *::before, *::after {
		    -webkit-user-select: none;
		    user-select: none;
		    -webkit-touch-callout: none;
		    -webkit-tap-highlight-color: transparent;
		}
		
		.prose, .prose * {
		    -webkit-user-select: text !important;
		    user-select: text !important;
		    cursor: text;
		}
		
		input, textarea {
		    -webkit-user-select: text !important;
		    user-select: text !important;
		    -webkit-touch-callout: default;
		}
		
		img {
		    -webkit-user-drag: none;
		    pointer-events: none;
		}
		
		.prose img {
		    pointer-events: auto;
		}

		#appInterface {
			width: 100%;
			height: 100dvh;
			height: 100%;
			display: none;
			flex-direction: column;
			background-color: #ffffff;
			position: absolute;
		}

		#mainSidebar {
			display: flex;
			flex-direction: column;
			overscroll-behavior: contain;
		}

		.sidebar-bottom-controls {
			flex: 0 0 auto;
			background-color: #ffffff;
			border-top: 1px solid #f8fafc;
			padding: 12px 1rem 24px;
		}

		#historyList {
			flex: 1 1 auto;
			overflow-y: auto;
			padding-bottom: 32px;
		}

		.history-item-container {
			position: relative;
			overflow: hidden;
			border-radius: 8px;
			margin-bottom: 2px;
			background-color: transparent;
		}

		.history-item-delete {
			position: absolute;
			right: 0;
			top: 0;
			bottom: 0;
			width: 50px;
			background-color: #fef2f2;
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 1;
			opacity: 0;
			transition: opacity 0.2s ease;
			border-radius: 0 8px 8px 0;
		}

		.history-item-delete i,
		.history-item-delete svg {
			width: 14px !important;
			height: 14px !important;
			color: #ef4444 !important;
		}

		.history-item-content {
			position: relative;
			z-index: 2;
			background-color: #ffffff;
			border-radius: 8px;
			transition: transform 0.15s ease-out;
			will-change: transform;
			border: 0.5px solid #f1f5f9;
		}

		.swiped-left .history-item-delete {
			opacity: 1;
		}

		.swiped-left .history-item-content {
			transform: translateX(-50px);
			border-top-right-radius: 0;
			border-bottom-right-radius: 0;
		}

		header {
			flex: 0 0 auto;
			background: white;
			border-bottom: 1px solid #f8fafc;
			z-index: 100;
		}

		main {
			flex: 1 1 auto;
			overflow-y: auto;
			background-color: #ffffff;
			position: relative;
			overscroll-behavior: contain;
		}

		footer {
			flex: 0 0 auto;
			background-color: #ffffff;
			z-index: 100;
			padding-top: 16px;
			padding-bottom: 20px;
			border-top: 1px solid #ffffff;
			margin-top: -1px;
		}

		.content-width {
			width: 100%;
			max-width: 48rem;
			margin: 0 auto;
			padding: 0 1rem;
		}



		.prose pre {
			background: #f3f4f6 !important;
			padding: 1rem !important;
			border-radius: 1rem !important;
			margin: 0.75rem 0;
			overflow-x: auto;
		}

		.prose code {
			background-color: #f1f5f9 !important;
			padding: 2px 5px !important;
			border-radius: 4px !important;
			font-family: 'JetBrains Mono', monospace !important;
			font-size: 0.875rem;
		}

		.prose ul {
			list-style-type: disc;
			padding-left: 1.25rem;
			margin: 0.5rem 0;
		}

		.prose ol {
			list-style-type: decimal;
			padding-left: 1.25rem;
			margin: 0.5rem 0;
		}

		.prose li {
			margin: 0.25rem 0;
		}

		.prose table {
			width: 100%;
			border-collapse: collapse;
			margin: 1rem 0;
			font-size: 0.875rem;
			border: 1px solid #e2e8f0;
			border-radius: 0.5rem;
			overflow: hidden;
		}

		.prose th,
		.prose td {
			border: 1px solid #e2e8f0;
			padding: 0.75rem;
			text-align: left;
		}

		.prose th {
			background-color: #f8fafc;
			font-weight: 600;
			color: #475569;
		}

		.prose blockquote {
			border-left: 4px solid #e2e8f0;
			padding-left: 1rem;
			color: #64748b;
			font-style: italic;
			margin: 1rem 0;
		}

		.prose p {
			margin-bottom: 0.75rem;
			line-height: 1.6;
		}

		.prose strong {
			font-weight: 700;
			color: #1e293b;
		}

		.prose a {
			color: #2563eb;
			text-decoration: underline;
			font-weight: 500;
		}

		::-webkit-scrollbar {
			display: none;
		}

		.typing-indicator {
			display: flex;
			align-items: center;
			gap: 4px;
			height: 22px;
		}

		.typing-dot {
			width: 3px;
			height: 3px;
			background-color: #94a3b8;
			border-radius: 50%;
			animation: dot-sequence 1.5s infinite ease-in-out;
			opacity: 0;
		}

		.typing-dot:nth-child(1) {
			animation-delay: 0s;
		}

		.typing-dot:nth-child(2) {
			animation-delay: 0.2s;
		}

		.typing-dot:nth-child(3) {
			animation-delay: 0.4s;
		}

		@keyframes dot-sequence {

			0%,
			100% {
				opacity: 0.2;
				transform: scale(0.8);
			}

			50% {
				opacity: 1;
				transform: scale(1.2);
			}
		}
	</style>
</head>

<body class="text-slate-900">
	<div id="sidebarOverlay"
		class="fixed inset-0 bg-black/20 z-[150] hidden backdrop-blur-sm transition-opacity opacity-0"></div>
	<div id="mainSidebar"
		class="fixed inset-y-0 left-0 w-[280px] bg-white z-[160] transform -translate-x-full flex flex-col border-r border-slate-100 shadow-2xl">
		<div class="h-16 flex items-center px-4 border-b border-slate-50 shrink-0">
			<div class="flex items-center gap-3 w-full">
				<div
					class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-600 font-bold shadow-sm shrink-0">
					<i data-lucide="user" class="w-5 h-5"></i>
				</div>
				<div class="flex-1 min-w-0">
					<p id="sidebarEmail" class="text-[14px] font-bold text-slate-600 truncate font-sans">
						user@example.com</p>
				</div>
			</div>
		</div>
		<div class="flex-1 overflow-y-auto px-3 pt-4 pb-2" id="historyList"></div>
		<div class="sidebar-bottom-controls">
			<div class="space-y-2">
				<button id="newChatSidebarBtn"
					class="w-full flex items-center gap-3 px-4 py-3 text-slate-700 bg-slate-50 rounded-xl font-bold text-sm">
					<i data-lucide="plus" class="w-[18px] h-[18px]"></i> Percakapan Baru
				</button>
				<button id="sidebarLogoutBtn"
					class="w-full flex items-center gap-3 px-4 py-3 text-slate-500 bg-slate-50 rounded-xl font-bold text-sm hover:text-red-600">
					<i data-lucide="log-out" class="w-[18px] h-[18px]"></i> Keluar
				</button>
			</div>
		</div>
	</div>

	<div id="loginScreen" class="fixed inset-0 bg-white z-[100] flex items-center justify-center p-6"
		style="display: none;">
		<div class="w-full max-w-[360px] bg-white rounded-[32px] px-8 py-8 flex flex-col items-center shadow-lg">
			<img src="icon/icon.png" alt="Logo" class="w-16 h-16 mb-8 object-contain">
			<form id="loginForm" class="w-full space-y-4">
				<input type="email" id="emailInput" placeholder="Email" required
					class="w-full px-5 py-4 bg-gray-50 rounded-2xl text-sm font-semibold border-none outline-none">
				<input type="password" id="passwordInput" placeholder="Password" required
					class="w-full px-5 py-4 bg-gray-50 rounded-2xl text-sm font-semibold border-none outline-none">
				<button type="submit" id="loginBtn"
					class="w-full py-4 bg-black text-white rounded-2xl font-bold text-sm uppercase">Masuk</button>
				<div id="loginError"
					class="text-red-500 text-[11px] font-bold hidden text-center uppercase mt-2 tracking-widest"></div>
			</form>
		</div>
	</div>

	<div id="appInterface" style="display: none;">
		<header class="h-16 px-4 md:px-8 flex items-center">
			<div class="w-full flex justify-between items-center">
				<div class="flex items-center">
					<img src="icon/icon.png" alt="Logo" class="h-8 w-auto object-contain">
				</div>
				<div class="flex items-center gap-1">
					<button id="settingsBtn" class="p-2.5 text-slate-400 rounded-xl active:scale-95"><i
							data-lucide="settings-2" class="w-6 h-6"></i></button>
					<button id="menuBtn" class="p-2.5 text-slate-400 rounded-xl active:scale-95 -mr-2.5"><i
							data-lucide="menu" class="w-6 h-6"></i></button>
				</div>
			</div>
		</header>

		<main id="chatContainer" class="custom-scroll">
			<div class="content-width pt-4 pb-8">
				<div id="messagesArea" class="space-y-4"></div>
			</div>
		</main>

		<footer>
			<div class="footer-content content-width">
				<div id="file-preview-container" class="grid grid-cols-2 md:grid-cols-4 gap-2 empty:hidden mb-4"></div>
				<form id="chatForm" class="w-full">
					<div id="inputWrapper"
						class="relative flex items-end gap-1 bg-slate-50 rounded-[28px] p-1.5 border border-slate-100 transition-all duration-200">
						<input type="file" id="file-input" multiple
							accept="image/*,application/pdf,.docx,.xlsx,.xls,.pptx,.js,.css,.java,.html,.xml,.py,.sql,.ts,.cpp,.h,.hpp,.lua,.swift"
							class="hidden" onchange="handleFileSelect(event)">

						<button type="button" id="uploadBtn" onclick="document.getElementById('file-input').click()"
							class="w-10 h-10 flex items-center justify-center text-slate-400 hover:text-slate-600 shrink-0 transition-colors">
							<i data-lucide="plus" class="w-6 h-6"></i>
						</button>

						<textarea id="userInput" placeholder="Tulis pesan..." rows="1"
							class="flex-1 min-h-[40px] max-h-[150px] py-2.5 px-2 bg-transparent border-none outline-none resize-none text-[15px] font-medium text-slate-700 placeholder:text-slate-400 leading-tight"></textarea>

						<button type="submit" id="sendBtn" ontouchstart="sendMessage(event)"
						    class="w-10 h-10 flex items-center justify-center bg-transparent text-black shrink-0 active:scale-90 transition-transform">
						    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="currentColor">
						        <path d="M21.66,12a2,2,0,0,1-1.14,1.81L5.87,20.75A2.08,2.08,0,0,1,5,21a2,2,0,0,1-1.82-2.82L5.46,13H11a1,1,0,0,0,0-2H5.46L3.18,5.87A2,2,0,0,1,5.86,3.25h0l14.65,6.94A2,2,0,0,1,21.66,12Z"></path>
						    </svg>
						</button>
					</div>
				</form>
			</div>
		</footer>
	</div>

	<div id="adminScreen" class="fixed inset-0 bg-white z-[200] hidden flex-col">
		<header class="h-16 px-4 md:px-8 flex items-center border-b border-slate-100 shrink-0 relative">
			<div class="flex items-center z-10">
				<button id="backFromAdmin" class="p-2 -ml-2 text-slate-400 active:scale-90">
					<i data-lucide="chevron-left" class="w-6 h-6"></i>
				</button>
			</div>
			<div class="absolute inset-0 flex items-center justify-center pointer-events-none">
				<h2 class="text-sm font-black text-slate-800 uppercase tracking-widest">Admin Control</h2>
			</div>
		</header>

		<main class="flex-1 overflow-y-auto bg-white">
			<div class="content-width pt-4 pb-10 space-y-4">
				<div class="w-full bg-slate-50 rounded-2xl p-5 shadow-sm">
					<div class="mb-4">
						<span class="text-xs font-black text-slate-500 uppercase tracking-widest">Model AI</span>
					</div>
					<div class="space-y-4">
						<div class="relative" id="model-dropdown">
							<button type="button" id="dropdown-trigger"
								class="w-full bg-gray-100 rounded-xl px-5 py-3 text-[15px] font-bold text-slate-700 flex items-center justify-between outline-none">
								<span id="selected-model-text">Gemini 3 Flash</span>
								<i data-lucide="chevron-down"
									class="w-4 h-4 text-slate-400 transition-transform duration-200"
									id="dropdown-icon"></i>
							</button>
							<div id="dropdown-menu"
								class="hidden absolute left-0 right-0 mt-2 bg-white rounded-2xl shadow-xl border border-slate-100 p-2 z-[210]">
								<div class="flex flex-col">
									<div class="dropdown-option py-3 px-4 rounded-xl hover:bg-slate-50 cursor-pointer text-sm font-medium text-slate-800"
										data-value="gemini-2.5-pro">Gemini 2.5 Pro</div>
									<div class="dropdown-option py-3 px-4 rounded-xl hover:bg-slate-50 cursor-pointer text-sm font-medium text-slate-800"
										data-value="gemini-2.5-flash">Gemini 2.5 Flash</div>
									<div class="dropdown-option py-3 px-4 rounded-xl hover:bg-slate-50 cursor-pointer text-sm font-medium text-slate-800"
										data-value="gemini-3-flash-preview">Gemini 3 Flash</div>
									<div class="dropdown-option py-3 px-4 rounded-xl hover:bg-slate-50 cursor-pointer text-sm font-medium text-slate-800"
										data-value="gemini-3-pro-preview">Gemini 3 Pro</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="w-full bg-slate-50 rounded-2xl p-5 shadow-sm">
					<div class="mb-4">
						<span class="text-xs font-black text-slate-500 uppercase tracking-widest">Sumber Data</span>
					</div>
					<div class="space-y-4">
						<div
							class="flex items-center justify-center justify-between bg-white p-3 rounded-xl border border-slate-100">
							<div class="flex items-center gap-3">
								<div
									class="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center text-blue-600">
									<i data-lucide="globe" class="w-4 h-4"></i>
								</div>
								<span class="text-sm font-bold text-slate-700">Google Search</span>
							</div>
							<label class="relative inline-flex items-center cursor-pointer">
								<input type="checkbox" id="google-search-toggle" class="sr-only peer" checked>
								<div
									class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
								</div>
							</label>
						</div>

						<div class="flex items-center justify-between bg-white p-3 rounded-xl border border-slate-100">
							<div class="flex items-center gap-3">
								<div
									class="w-8 h-8 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-600">
									<i data-lucide="database" class="w-4 h-4"></i>
								</div>
								<span class="text-sm font-bold text-slate-700">Knowledge Base</span>
							</div>
							<label class="relative inline-flex items-center cursor-pointer">
								<input type="checkbox" id="kb-search-toggle" class="sr-only peer">
								<div
									class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-600">
								</div>
							</label>
						</div>
						<div class="mt-2">
							<input type="file" id="kb-file-upload" accept=".txt,.md" class="hidden"
								onchange="handleKbUpload(event)">
							<button onclick="document.getElementById('kb-file-upload').click()"
							    class="w-full border border-dashed border-slate-300 hover:border-emerald-500 hover:bg-emerald-50/30 transition-colors rounded-2xl py-4 flex items-center justify-center gap-2 group">
							    <i data-lucide="upload-cloud" class="w-5 h-5 text-slate-400 group-hover:text-emerald-600 transition-colors"></i>
							    <span class="text-sm font-bold text-slate-500 group-hover:text-emerald-700 tracking-wide">Upload Knowledge Base</span>
							</button>
							<div id="kb-upload-status" class="hidden mt-3 text-center">
								<div class="w-full bg-slate-200 rounded-full h-1.5 mb-2 overflow-hidden">
									<div id="kb-progress-bar" class="bg-emerald-500 h-1.5 rounded-full"
										style="width: 0%"></div>
								</div>
								<span id="kb-status-text"
									class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Memproses...</span>
							</div>
						</div>
					</div>
				</div>

				<div class="w-full bg-slate-50 rounded-2xl p-5 shadow-sm">
					<div class="mb-6">
						<span class="text-xs font-black text-slate-500 uppercase tracking-widest">Parameter AI</span>
					</div>
					<div class="space-y-6">
						<div>
							<div class="flex justify-between items-center mb-2">
								<span
									class="text-[11px] font-bold text-slate-400 uppercase tracking-wider">Temperature</span>
								<span id="label-temp" class="text-[11px] font-black text-slate-600">1.0</span>
							</div>
							<input type="range" id="settings-temp" min="0" max="2" step="0.1"
								class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-600">
						</div>

						<div>
							<div class="flex justify-between items-center mb-2">
								<span class="text-[11px] font-bold text-slate-400 uppercase tracking-wider">Max
									Tokens</span>
								<span id="label-tokens" class="text-[11px] font-black text-slate-600">65536</span>
							</div>
							<input type="range" id="settings-tokens" min="1024" max="128000" step="1024"
								class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-600">
						</div>

						<div>
							<div class="flex justify-between items-center mb-2">
								<span class="text-[11px] font-bold text-slate-400 uppercase tracking-wider">Thinking
									Budget</span>
								<span id="label-thinking" class="text-[11px] font-black text-slate-600">MEDIUM</span>
							</div>
							<input type="range" id="settings-thinking" min="1" max="3" step="1"
								class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-600">
						</div>
					</div>
				</div>

				<div class="w-full bg-slate-50 rounded-2xl p-5 shadow-sm">
					<div class="mb-4">
						<span class="text-xs font-black text-slate-500 uppercase tracking-widest">System Prompt</span>
					</div>
					<textarea id="systemPromptInput" rows="4"
						class="w-full bg-gray-100 rounded-xl px-4 py-3 text-[15px] font-medium text-slate-600 outline-none resize-none"></textarea>
				</div>

				<!-- MANAJEMEN USER SECTION -->
				<div class="w-full bg-slate-50 rounded-2xl p-5 shadow-sm">
					<div class="flex justify-between items-center mb-4">
						<span class="text-xs font-black text-slate-500 uppercase tracking-widest">Manajemen User</span>
						<button onclick="toggleAddUserForm()"
							class="text-xs font-bold text-blue-600 hover:text-blue-700 bg-blue-50 px-3 py-1.5 rounded-lg transition-colors">
							+ Add User
						</button>
					</div>

					<!-- Form Add User -->
					<div id="addUserForm" class="hidden mb-6 bg-white p-5 rounded-3xl border border-slate-100 space-y-4 shadow-sm">
					    <div class="space-y-3">
					        <input type="email" id="newUserEmail" placeholder="Email User Baru" required
					            class="w-full px-5 py-4 bg-slate-50 rounded-2xl text-sm font-semibold border-none outline-none text-slate-700 placeholder:text-slate-400">
					        
					        <input type="password" id="newUserPassword" placeholder="Password User Baru" required
					            class="w-full px-5 py-4 bg-slate-50 rounded-2xl text-sm font-semibold border-none outline-none text-slate-700 placeholder:text-slate-400">
					    </div>
					
					    <div class="pt-2">
					        <button onclick="createNewUser()"
					            class="w-full py-4 bg-blue-50 text-blue-600 rounded-2xl font-bold text-sm uppercase hover:bg-blue-100 active:scale-95 transition-all">
					            TAMBAH
					        </button>
					    </div>
					</div>

					<div id="userListContainer" class="space-y-3">
						<!-- User Items will be injected here -->
						<div class="text-center py-4">
							<span class="text-xs font-medium text-slate-400">Memuat data user...</span>
						</div>
					</div>
				</div>
			</div>
		</main>
		<footer class="flex-none bg-white p-4 pb-8 z-10">
        </footer>
	</div>

	<script>
		const SUPABASE_URL = "https://wddsihtjvntvipswmbtp.supabase.co";
		const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndkZHNpaHRqdm50dmlwc3dtYnRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMjg2NDMsImV4cCI6MjA4NDYwNDY0M30.fyz5Uv7eOUb9zQIbH2OBuZbGu1FZ1_2aYT6deOmojrY";
		const PROXY_URL = `${SUPABASE_URL}/functions/v1/gemini-proxy`;
		const EMBEDDING_URL = `${SUPABASE_URL}/functions/v1/gemini-embedding`;
		const USER_MGMT_URL = `${SUPABASE_URL}/functions/v1/user-management`;
		const SELECTED_MODEL = "gemini-3-flash-preview";
		const SYSTEM_PROMPT = "Kamu adalah Asisten Virtual yang Ramah, Profesional, dan Sangat Membantu.";
		const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

		let chatHistory = [];
		let currentSessionId = null;
		let isGenerating = false;
		let typingBubble = null;
		let pendingFiles = [];

		let currentSelectedModel = localStorage.getItem('awas_model') || "gemini-3-flash-preview";
		const thinkingMap = { "1": 4000, "2": 16000, "3": 32000 };

		function saveAdminSettings() {
			localStorage.setItem('awas_model', currentSelectedModel);
			localStorage.setItem('awas_temp', document.getElementById('settings-temp').value);
			localStorage.setItem('awas_tokens', document.getElementById('settings-tokens').value);
			localStorage.setItem('awas_thinking', document.getElementById('settings-thinking').value);
			localStorage.setItem('awas_prompt', document.getElementById('systemPromptInput').value);
			localStorage.setItem('awas_google_search', document.getElementById('google-search-toggle').checked);
			localStorage.setItem('awas_kb_search', document.getElementById('kb-search-toggle').checked);
		}

		function loadAdminSettings() {
			const savedModel = localStorage.getItem('awas_model') || "gemini-3-flash-preview";
			const savedTemp = localStorage.getItem('awas_temp') || "1.0";
			const savedTokens = localStorage.getItem('awas_tokens') || "65536";
			const savedThinking = localStorage.getItem('awas_thinking') || "2";
			const savedPrompt = localStorage.getItem('awas_prompt') || SYSTEM_PROMPT;
			const savedGoogle = localStorage.getItem('awas_google_search') === 'true';
			const savedKb = localStorage.getItem('awas_kb_search') === 'true';

			currentSelectedModel = savedModel;
			const modelLabels = {
				"gemini-2.5-pro": "Gemini 2.5 Pro",
				"gemini-2.5-flash": "Gemini 2.5 Flash",
				"gemini-3-flash-preview": "Gemini 3 Flash",
				"gemini-3-pro-preview": "Gemini 3 Pro"
			};
			document.getElementById('selected-model-text').innerText = modelLabels[savedModel] || "Gemini 3 Flash";
			document.getElementById('settings-temp').value = savedTemp;
			document.getElementById('label-temp').innerText = savedTemp;
			document.getElementById('settings-tokens').value = savedTokens;
			document.getElementById('label-tokens').innerText = savedTokens;
			document.getElementById('settings-thinking').value = savedThinking;
			document.getElementById('label-thinking').innerText = ["LOW", "MEDIUM", "HIGH"][savedThinking - 1];
			document.getElementById('systemPromptInput').value = savedPrompt;
			document.getElementById('google-search-toggle').checked = savedGoogle;

			const kbToggle = document.getElementById('kb-search-toggle');
			if (kbToggle) kbToggle.checked = savedKb;
		}

		async function handleKbUpload(event) {
			const file = event.target.files[0];
			if (!file) return;

			const statusDiv = document.getElementById('kb-upload-status');
			const progressBar = document.getElementById('kb-progress-bar');
			const statusText = document.getElementById('kb-status-text');

			statusDiv.classList.remove('hidden');
			progressBar.style.width = '5%';
			statusText.innerText = "MEMBACA FILE...";
			statusText.classList.remove('text-red-500', 'text-emerald-600');

			try {
				const text = await file.text();
				const chunks = splitTextIdeally(text, 1000, 200);

				statusText.innerText = `MEMPROSES ${chunks.length} POTONGAN...`;

				let successCount = 0;
				const { data: { session } } = await _supabase.auth.getSession();
				const token = session?.access_token;

				for (let i = 0; i < chunks.length; i++) {
					const chunkContent = chunks[i];

					const res = await fetch(EMBEDDING_URL, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
							'Authorization': `Bearer ${token}`
						},
						body: JSON.stringify({
							action: 'embed',
							text: chunkContent
						})
					});

					if (!res.ok) {
						console.error("Gagal embed chunk ke-", i);
						continue;
					}

					const { embedding } = await res.json();

					const { error } = await _supabase.from('documents').insert({
						content: chunkContent,
						embedding: embedding,
						metadata: {
							source: file.name,
							chunk_index: i,
							type: "text_upload"
						}
					});

					if (!error) successCount++;

					const percent = Math.floor(((i + 1) / chunks.length) * 100);
					progressBar.style.width = `${percent}%`;
					statusText.innerText = `UPLOAD: ${percent}%`;
				}

				statusText.innerText = "SELESAI!";
				statusText.classList.add('text-emerald-600');
				setTimeout(() => {
					statusDiv.classList.add('hidden');
					event.target.value = '';
					alert(`Sukses! ${successCount} data masuk ke Knowledge Base.`);
				}, 1000);

			} catch (e) {
				console.error(e);
				statusText.innerText = "ERROR KONEKSI";
				statusText.classList.add('text-red-500');
			}
		}

		function splitTextIdeally(text, maxLength, overlap) {
			const chunks = [];
			let startIndex = 0;

			while (startIndex < text.length) {
				let endIndex = startIndex + maxLength;

				if (endIndex >= text.length) {
					chunks.push(text.substring(startIndex).trim());
					break;
				}

				const windowText = text.substring(startIndex, endIndex);
				let splitIndex = -1;

				const lastParagraph = windowText.lastIndexOf('\n\n');
				if (lastParagraph > maxLength * 0.7) {
					splitIndex = lastParagraph;
				}

				if (splitIndex === -1) {
					const sentenceEnd = Math.max(
						windowText.lastIndexOf('. '),
						windowText.lastIndexOf('? '),
						windowText.lastIndexOf('! '),
						windowText.lastIndexOf('.\n')
					);
					if (sentenceEnd > maxLength * 0.5) {
						splitIndex = sentenceEnd + 1;
					}
				}

				if (splitIndex === -1) {
					const lastEnter = windowText.lastIndexOf('\n');
					if (lastEnter > maxLength * 0.5) {
						splitIndex = lastEnter;
					}
				}

				if (splitIndex === -1) {
					const lastSpace = windowText.lastIndexOf(' ');
					if (lastSpace > maxLength * 0.3) {
						splitIndex = lastSpace;
					}
				}

				if (splitIndex === -1) {
					splitIndex = maxLength;
				}

				let realEndIndex = startIndex + splitIndex;

				const chunk = text.substring(startIndex, realEndIndex).trim();
				if (chunk.length > 0) {
					chunks.push(chunk);
				}

				let nextStart = realEndIndex - overlap;

				if (nextStart > 0 && nextStart < text.length) {
					const spaceBefore = text.lastIndexOf(' ', nextStart);
					const enterBefore = text.lastIndexOf('\n', nextStart);
					const safeStart = Math.max(spaceBefore, enterBefore);

					if (safeStart !== -1) {
						nextStart = safeStart + 1;
					}
				}

				if (nextStart <= startIndex) {
					nextStart = realEndIndex;
				}

				startIndex = nextStart;
			}

			return chunks;
		}

		document.getElementById('settings-tokens').oninput = function () {
			document.getElementById('label-tokens').innerText = this.value;
			saveAdminSettings();
		};

		document.getElementById('settings-temp').oninput = function () {
			document.getElementById('label-temp').innerText = this.value;
			saveAdminSettings();
		};

		document.getElementById('settings-thinking').oninput = function () {
			const labels = ["LOW", "MEDIUM", "HIGH"];
			document.getElementById('label-thinking').innerText = labels[this.value - 1];
			saveAdminSettings();
		};

		const dropdownTrigger = document.getElementById('dropdown-trigger');
		const dropdownMenu = document.getElementById('dropdown-menu');
		const dropdownIcon = document.getElementById('dropdown-icon');
		const dropdownOptions = document.querySelectorAll('.dropdown-option');

		dropdownTrigger.onclick = (e) => {
			e.stopPropagation();
			dropdownMenu.classList.toggle('hidden');
			dropdownIcon.style.transform = dropdownMenu.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
		};

		document.addEventListener('click', (e) => {
			if (!dropdownTrigger.contains(e.target) && !dropdownMenu.contains(e.target)) {
				dropdownMenu.classList.add('hidden');
				if (dropdownIcon) dropdownIcon.style.transform = 'rotate(0deg)';
			}
		});

		dropdownOptions.forEach(option => {
			option.onclick = () => {
				const value = option.getAttribute('data-value');
				const text = option.innerText;

				currentSelectedModel = value;
				document.getElementById('selected-model-text').innerText = text;

				dropdownMenu.classList.add('hidden');
				dropdownIcon.style.transform = 'rotate(0deg)';

				saveAdminSettings();
			};
		});

		document.getElementById('google-search-toggle').onchange = () => {
			saveAdminSettings();
		};
		const kbSearchToggle = document.getElementById('kb-search-toggle');
		if (kbSearchToggle) {
			kbSearchToggle.onchange = () => {
				saveAdminSettings();
			};
		}
		
		document.addEventListener('touchmove', function(event) {
		    if (event.scale !== 1) {
		        event.preventDefault();
		    }
		}, { passive: false });
		
		let lastTouchEnd = 0;
		document.addEventListener('touchend', function(event) {
		    const now = (new Date()).getTime();
		    if (now - lastTouchEnd <= 300) {
		        event.preventDefault();
		    }
		    lastTouchEnd = now;
		}, false);
		
		const metaViewport = document.querySelector('meta[name=viewport]');
		document.addEventListener('focus', function(event) {
		    if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
		        metaViewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
		    }
		}, true);
		
		document.addEventListener('blur', function(event) {
		    if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
		        metaViewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
		    }
		}, true);


		function formatBytes(bytes, decimals = 2) {
			if (bytes === 0) return '0 Bytes';
			const k = 1024;
			const dm = decimals < 0 ? 0 : decimals;
			const sizes = ['Bytes', 'KB', 'MB', 'GB'];
			const i = Math.floor(Math.log(bytes) / Math.log(k));
			return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
		}

		function getFileIcon(extension) {
			const icons = {
				'pdf': 'pdf-file-icon.svg',
				'docx': 'docx-file-icon.svg',
				'xlsx': 'excel-file-icon.svg',
				'xls': 'excel-file-icon.svg',
				'pptx': 'ppt-file-icon.svg',
				'js': 'javascript-file-icon.svg',
				'css': 'css-file-icon.svg',
				'java': 'java-file-icon.svg',
				'html': 'html-file-icon.svg',
				'xml': 'xml-file-icon.svg',
				'py': 'python-file-icon.svg',
				'sql': 'sql-file-icon.svg',
				'ts': 'typescript-file-icon.svg',
				'lua': 'lua-file-icon.svg',
				'cpp': 'cpp-file-icon.svg',
				'h': 'cpp-file-icon.svg',
				'hpp': 'cpp-file-icon.svg',
				'swift': 'swift-file-icon.svg',
				'jpg': 'image-file-icon.svg',
				'jpeg': 'image-file-icon.svg',
				'png': 'image-file-icon.svg',
				'gif': 'image-file-icon.svg',
				'webp': 'image-file-icon.svg',
				'heic': 'image-file-icon.svg',
				'heif': 'image-file-icon.svg'
			};
			const iconFile = icons[extension] || 'default-file-icon.svg';
			return `<img src="icon/${iconFile}" class="w-7 h-7 object-contain">`;
		}

		function convertToBase64(file) {
			return new Promise((resolve, reject) => {
				const reader = new FileReader();
				reader.readAsDataURL(file);
				reader.onload = () => resolve(reader.result);
				reader.onerror = error => reject(error);
			});
		}

		async function extractTextFromOffice(file) {
			const ext = file.name.split('.').pop().toLowerCase();
			try {
				if (ext === 'docx') {
					const ab = await file.rawFile.arrayBuffer();
					const res = await mammoth.extractRawText({ arrayBuffer: ab });
					return `\n[FILE WORD: ${file.name}]\n${res.value}\n`;
				}
				if (['xlsx', 'xls'].includes(ext)) {
					const ab = await file.rawFile.arrayBuffer();
					const wb = XLSX.read(ab, { type: 'array' });
					const text = wb.SheetNames.map(n => `\n-- Sheet: ${n} --\n${XLSX.utils.sheet_to_csv(wb.Sheets[n])}`).join('');
					return `\n[FILE EXCEL: ${file.name}]\n${text}\n`;
				}
				if (ext === 'pptx') {
					const zip = new JSZip();
					const content = await zip.loadAsync(file.rawFile);
					let text = `\n[FILE POWERPOINT: ${file.name}]\n`;
					const slides = Object.keys(content.files).filter(n => n.startsWith("ppt/slides/slide") && n.endsWith(".xml")).sort();
					for (const f of slides) {
						const xml = await content.files[f].async("text");
						const nodes = new DOMParser().parseFromString(xml, "text/xml").getElementsByTagName("a:t");
						text += `\n[SLIDE]\n${Array.from(nodes).map(n => n.textContent).join(" ")}\n`;
					}
					return text;
				}
			} catch (e) { return `\n[Gagal membaca ${file.name}]\n`; }
			return '';
		}

		async function readCodeFile(file) {
			try {
				const text = await file.rawFile.text();
				return `\n[ISI FILE ${file.name.toUpperCase()}]:\n${text}\n`;
			} catch (e) { return `\n[Gagal membaca isi file ${file.name}]\n`; }
		}

		function getFileCardHTML(name, size) {
			const ext = name.split('.').pop().toLowerCase();
			const visual = getFileIcon(ext);
			return `
		        <div class="bg-gray-100 rounded-2xl p-3 flex items-center gap-2 relative w-full min-h-[64px] border-none animate-in fade-in slide-in-from-bottom-1">
		            <div class="w-10 h-10 flex-none flex items-center justify-center overflow-hidden shrink-0">${visual}</div>
		            <div class="flex-1 flex flex-col justify-center min-w-0 h-10">
		                <p class="text-[12px] font-bold text-gray-700 truncate leading-none mb-1 m-0 p-0">${name}</p>
		                <p class="text-[10px] text-gray-400 font-medium leading-none m-0 p-0">${size}</p>
		            </div>
		        </div>`;
		}

		async function handleFileSelect(event) {
			const files = Array.from(event.target.files);
			if (!files.length) return;
			if (pendingFiles.length + files.length > 4) {
				alert("Maksimal 4 file dalam satu pengiriman.");
				event.target.value = '';
				return;
			}
			try {
				for (const file of files) {
					const base64 = await convertToBase64(file);
					let mimeType = file.type || '';
					const ext = file.name ? file.name.split('.').pop().toLowerCase() : '';
					if (!mimeType && ['jpg', 'jpeg', 'png', 'gif', 'webp', 'heic', 'heif'].includes(ext)) {
						mimeType = 'image/jpeg';
					}
					pendingFiles.push({
						name: file.name || "File",
						size: formatBytes(file.size),
						type: mimeType,
						base64: base64.split(',')[1],
						mime: mimeType,
						rawFile: file
					});
				}
			} catch (e) {
				console.error(e);
			} finally {
				renderPreviews();
				event.target.value = '';
			}
		}

		function renderPreviews() {
			const container = document.getElementById('file-preview-container');
			if (!container) return;
			container.innerHTML = '';
			pendingFiles.forEach((file, index) => {
				const ext = file.name ? file.name.split('.').pop().toLowerCase() : '';
				const isImage = (file.type && typeof file.type === 'string' && file.type.startsWith('image/')) ||
					['jpg', 'jpeg', 'png', 'gif', 'webp', 'heic', 'heif'].includes(ext);
				const visual = isImage
					? `<img src="data:${file.mime || 'image/jpeg'};base64,${file.base64}" class="w-full h-full object-cover rounded-lg">`
					: getFileIcon(ext);
				const card = document.createElement('div');
				card.className = "bg-gray-100 rounded-2xl p-3 flex items-center gap-2 relative w-full min-h-[64px] border-none";
				card.innerHTML = `
		            <div class="w-10 h-10 flex-none flex items-center justify-center overflow-hidden shrink-0">${visual}</div>
		            <div class="flex-1 flex flex-col justify-center min-w-0 h-10">
		                <p class="text-[12px] font-bold text-gray-700 truncate leading-none mb-1 m-0 p-0">${file.name}</p>
		                <p class="text-[10px] text-gray-400 font-medium leading-none m-0 p-0">${file.size}</p>
		            </div>
		            <button onclick="removeFile(${index})" class="absolute -top-3 -right-3 w-7 h-7 flex items-center justify-center border-none p-0 cursor-pointer outline-none bg-transparent">
		                <svg fill="#d1d5db" viewBox="0 0 24 24" class="w-full h-full"><path d="M12 4c-4.419 0-8 3.582-8 8s3.581 8 8 8 8-3.582 8-8-3.581-8-8-8zm3.707 10.293c.391.391.391 1.023 0 1.414-.195.195-.451.293-.707.293s-.512-.098-.707-.293l-2.293-2.293-2.293 2.293c-.195.195-.451.293-.707.293s-.512-.098-.707-.293c-.391-.391-.391-1.023 0-1.414l2.293-2.293-2.293-2.293c-.391-.391-.391-1.023 0-1.414s1.023-.391 1.414 0l2.293 2.293 2.293-2.293c.391-.391 1.023-.391 1.414 0s.391 1.023 0 1.414l-2.293 2.293 2.293 2.293z"></path></svg>
		            </button>`;
				container.appendChild(card);
			});
		}

		function removeFile(index) {
			pendingFiles.splice(index, 1);
			renderPreviews();
		}

		async function sendMessage(e) {
		    if (e && e.type === 'submit') e.preventDefault(); 
		    
		    const input = document.getElementById('userInput');
		    const rawInput = input.value.trim();
		    
		    if (!rawInput && pendingFiles.length === 0 || isGenerating) return;
		    input.blur();
    
			const currentTemp = parseFloat(document.getElementById('settings-temp').value) || 1.0;
			const currentMaxTokens = parseInt(document.getElementById('settings-tokens').value) || 65536;
			const sliderVal = document.getElementById('settings-thinking').value;
			const currentBudget = thinkingMap[sliderVal] || 16000;
			const useGoogleSearch = document.getElementById('google-search-toggle').checked;
			const useKbSearch = document.getElementById('kb-search-toggle') ? document.getElementById('kb-search-toggle').checked : false;
			let customSystemPrompt = document.getElementById('systemPromptInput').value || SYSTEM_PROMPT;

			input.value = '';
			input.style.height = 'auto';
			inputWrapper.classList.add('rounded-[28px]');
			inputWrapper.classList.remove('rounded-[22px]');
			setGeneratingState(true);

			let fileCardsHTML = "";
			const filesToProcess = [...pendingFiles];
			filesToProcess.forEach(f => {
				fileCardsHTML += getFileCardHTML(f.name, f.size);
			});

			appendMsg('user', rawInput, null, fileCardsHTML);
			const loadingMsgId = appendTypingBubble();

			let textContext = "";
			let kbContext = "";
			let apiParts = [];
			pendingFiles = [];
			renderPreviews();

			for (const f of filesToProcess) {
				if (f.mime.startsWith('image/') || f.mime === 'application/pdf') {
					apiParts.push({ inline_data: { mime_type: f.mime, data: f.base64 } });
				} else {
					const ext = f.name.split('.').pop().toLowerCase();
					textContext += await (['docx', 'xlsx', 'xls', 'pptx'].includes(ext) ? extractTextFromOffice(f) : readCodeFile(f));
				}
			}

			try {
				const { data: { session } } = await _supabase.auth.getSession();
				const userToken = session.access_token;

				if (useKbSearch && rawInput.length > 0) {
					const embedRes = await fetch(EMBEDDING_URL, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
							'Authorization': `Bearer ${userToken}`
						},
						body: JSON.stringify({ action: 'embed', text: rawInput })
					});

					if (embedRes.ok) {
						const { embedding: queryVector } = await embedRes.json();

						const { data: documents, error: searchError } = await _supabase.rpc('match_documents', {
							query_embedding: queryVector,
							match_threshold: 0.5,
							match_count: 5
						});
						console.log("ðŸ” HASIL RAG (CHUNKS):", documents);

						if (documents && documents.length > 0) {
							kbContext = "\n\n[INFORMASI DARI KNOWLEDGE BASE]:\n" +
								documents.map((d, i) => `Dokumen ${i + 1} (${d.metadata?.source || 'Unknown'}):\n${d.content}`).join("\n---\n");
						}
					}
				}

				const fullPrompt = `
				${customSystemPrompt}
				
				[INSTRUKSI PENTING UNTUK AI]
				1. Data di bawah label "KNOWLEDGE BASE (INGATAN)" adalah pengetahuan utamamu. ANGGAP INI ADALAH PENGETAHUAN MURNIMU SENDIRI.
				2. JANGAN PERNAH mengawali jawaban dengan "Berdasarkan informasi yang diberikan..." atau "Menurut dokumen...". Langsung jawab intinya dengan percaya diri.
				3. Jika jawaban ada di Knowledge Base, gunakan itu sebagai fakta mutlak.
				4. Jika Knowledge Base tidak membahasnya, barulah gunakan pengetahuan umummu atau cari di Google (jika diizinkan), tapi jangan mengeluh data tidak lengkap.
				
				[KNOWLEDGE BASE (INGATAN)]
				${kbContext || "Tidak ada ingatan spesifik tentang topik ini, gunakan pengetahuan umum."}
				
				[FILE LAMPIRAN USER (JIKA ADA)]
				${textContext}
				
				PERTANYAAN USER:
				${rawInput}
				`;

				const payload = {
					contents: [
						...chatHistory,
						{ role: "user", parts: [...apiParts, { text: fullPrompt }] }
					],
					generationConfig: {
						temperature: currentTemp,
						max_output_tokens: currentMaxTokens
					}
				};

				if (useGoogleSearch) {
					payload.tools = [{ google_search: {} }];
				}

				if (currentSelectedModel.includes('think')) {
					payload.thinking_config = {
						include_thoughts: true,
						thinking_budget_tokens: currentBudget
					};
				}

				const res = await fetch(`${PROXY_URL}?model=${currentSelectedModel}&action=generateContent`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${userToken}`,
						'apikey': SUPABASE_KEY
					},
					body: JSON.stringify(payload)
				});

				const data = await res.json();
				const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Gagal memproses jawaban.";

				await typeWriter(loadingMsgId, aiText);

				chatHistory.push(
					{ role: "user", parts: [{ text: rawInput }] },
					{ role: "model", parts: [{ text: aiText }] }
				);

				await saveMsg(session.user.id, rawInput, aiText);

			} catch (err) {
				console.error(err);
				const el = document.getElementById(loadingMsgId);
				if (el) el.innerHTML = "Terjadi kesalahan koneksi atau limit API.";
			} finally {
				setGeneratingState(false);
			}
		}

		function appendMsg(role, text, timestamp, fileCardsHTML = "") {
			const area = document.getElementById('messagesArea');
			const isUser = role === 'user';
			const div = document.createElement('div');
			div.className = "w-full animate-in fade-in slide-in-from-bottom-2 duration-300 mb-2";

			const timeStr = timestamp
				? new Date(timestamp).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })
				: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

			const label = isUser ? 'ANDA' : `<div class="w-5 h-5 bg-gradient-to-r from-blue-600 to-cyan-400" style="-webkit-mask: url('icon/icon.png') no-repeat center; mask: url('icon/icon.png') no-repeat center; -webkit-mask-size: contain; mask-size: contain;"></div>`;

			div.innerHTML = `
		        <div class="w-full bg-slate-50 rounded-2xl p-4 shadow-sm group relative">
		            <div class="flex justify-between items-center border-b border-slate-100 pb-1 mb-1">
		                <span class="text-xs font-black uppercase tracking-widest ${isUser ? 'text-slate-600' : 'text-blue-600'}">${label}</span>
		                <span class="text-xs font-medium text-slate-400">${timeStr}</span>
		            </div>
		            <div class="prose max-w-none text-slate-600 text-[15px] font-medium">${marked.parse(text)}</div>
		            <div class="user-file-cards grid grid-cols-2 md:grid-cols-4 gap-2 empty:hidden mt-3">${fileCardsHTML}</div>
		        </div>`;
			area.appendChild(div);
		}

		function appendTypingBubble() {
			const area = document.getElementById('messagesArea');
			const msgId = `msg-${Date.now()}`;
			const timeStr = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
			const div = document.createElement('div');
			div.className = "w-full animate-in fade-in slide-in-from-bottom-2 duration-300 mb-2";
			div.innerHTML = `
		        <div class="w-full bg-slate-50 rounded-2xl p-4 shadow-sm group relative">
		            <div class="flex justify-between items-center border-b border-slate-100 pb-1 mb-1">
		                <span class="text-xs font-black uppercase tracking-widest">
		                    <div class="w-5 h-5 bg-gradient-to-r from-blue-600 to-cyan-400" style="-webkit-mask: url('icon/icon.png') no-repeat center; mask: url('icon/icon.png') no-repeat center; -webkit-mask-size: contain; mask-size: contain;"></div>
		                </span>
		                <span class="text-xs font-medium text-slate-400">${timeStr}</span>
		            </div>
		            <div id="${msgId}" class="prose max-w-none text-slate-600 text-[15px] font-medium min-h-[24px]">
		                <div class="flex items-baseline gap-1 text-[14px] text-slate-400">
		                    Thinking
		                    <div class="flex gap-1 translate-y-[1px]">
		                        <div class="typing-dot"></div>
		                        <div class="typing-dot"></div>
		                        <div class="typing-dot"></div>
		                    </div>
		                </div>
		            </div>
		        </div>`;
			area.appendChild(div);

			const container = document.getElementById('chatContainer');
			container.scrollTop = container.scrollHeight;
			return msgId;
		}

		async function saveMsg(uid, uText, aText) {
			const payload = { id: currentSessionId, user_id: uid, timestamp: Date.now() };
			if (chatHistory.length <= 2) {
				let cleanTitle = aText.split('\n')[0].replace(/[*#_`]/g, '').trim();
				if (cleanTitle.length > 45) cleanTitle = cleanTitle.substring(0, 45).trim() + '...';
				payload.title = cleanTitle;
			}

			const { data: s } = await _supabase.from('chat_sessions').upsert(payload).select().single();
			await _supabase.from('chat_messages').insert([{ session_id: currentSessionId, role: 'user', content: uText, timestamp: Date.now() }, { session_id: currentSessionId, role: 'model', content: aText, timestamp: Date.now() }]);
			loadHistory();
		}

		async function loadHistory() {
			const { data: { session } } = await _supabase.auth.getSession();
			if (!session) return;
			const { data: sessions } = await _supabase.from('chat_sessions').select('*').eq('user_id', session.user.id).order('timestamp', { ascending: false });
			const list = document.getElementById('historyList');
			list.innerHTML = '';

			sessions?.forEach(s => {
				const isActive = s.id === currentSessionId;
				const container = document.createElement('div');
				container.className = 'history-item-container';

				const delBtn = document.createElement('div');
				delBtn.className = 'history-item-delete';
				delBtn.innerHTML = '<i data-lucide="trash-2"></i>';
				delBtn.onclick = (e) => {
					e.stopPropagation();
					handleDeleteClick(s.id);
				};

				const item = document.createElement('div');
				item.className = `history-item-content w-full py-2.5 px-4 text-[13px] font-semibold select-none cursor-pointer ${isActive ? 'bg-blue-50/50 text-blue-600 border-blue-100' : 'bg-white text-slate-500'}`;

				const title = document.createElement('div');
				title.className = "w-full truncate";
				title.innerText = s.title || "Percakapan Baru";
				item.appendChild(title);

				let touchStartX = 0;
				let isSwiping = false;

				// Touch Events
				item.addEventListener('touchstart', (e) => {
					touchStartX = e.touches[0].clientX;
					isSwiping = false;
				}, { passive: true });

				item.addEventListener('touchend', (e) => {
					const touchEndX = e.changedTouches[0].clientX;
					const diff = touchStartX - touchEndX;

					if (Math.abs(diff) > 30) {
						isSwiping = true;
						if (diff > 30) { // Swipe Left
							document.querySelectorAll('.history-item-container').forEach(c => c.classList.remove('swiped-left'));
							container.classList.add('swiped-left');
						} else { // Swipe Right
							container.classList.remove('swiped-left');
						}
					}
				}, { passive: true });

				// Mouse Events for Desktop "Swipe"
				item.addEventListener('mousedown', (e) => {
					touchStartX = e.clientX;
					isSwiping = false;
				});

				item.addEventListener('mouseup', (e) => {
					const touchEndX = e.clientX;
					const diff = touchStartX - touchEndX;

					if (Math.abs(diff) > 30) {
						isSwiping = true;
						if (diff > 30) {
							document.querySelectorAll('.history-item-container').forEach(c => c.classList.remove('swiped-left'));
							container.classList.add('swiped-left');
						} else {
							container.classList.remove('swiped-left');
						}
					}
				});

				item.onclick = (e) => {
					// Ensure we don't open chat if user was just selecting text or swiping
					const selection = window.getSelection().toString();
					if (!isSwiping && selection.length === 0) {
						loadSession(s.id);
					}
				};

				container.appendChild(delBtn);
				container.appendChild(item);
				list.appendChild(container);
			});
			lucide.createIcons();
		}

		async function handleDeleteClick(id) {
			await _supabase.from('chat_messages').delete().eq('session_id', id);
			await _supabase.from('chat_sessions').delete().eq('id', id);

			if (currentSessionId === id) {
				currentSessionId = null;
				document.getElementById('messagesArea').innerHTML = '';
				chatHistory = [];
			}
			loadHistory();
		}

		async function loadSession(id) {
			currentSessionId = id;
			const { data: msgs } = await _supabase.from('chat_messages').select('*').eq('session_id', id).order('timestamp', { ascending: true });
			document.getElementById('messagesArea').innerHTML = '';
			chatHistory = msgs.map(m => ({ role: m.role, parts: [{ text: m.content }] }));
			msgs.forEach(m => appendMsg(m.role, m.content));
			loadHistory();
			toggleSidebar(false);
		}

		function typeWriter(elementId, text) {
			return new Promise(resolve => {
				const element = document.getElementById(elementId);
				if (!element) { resolve(); return; }

				element.innerHTML = '';
				let index = 0;
				const speed = 8;
				const charsPerTick = 8;

				const interval = setInterval(() => {
					if (index >= text.length) {
						clearInterval(interval);
						element.innerHTML = marked.parse(text);
						resolve();
						return;
					}

					const chunk = text.substring(0, index + charsPerTick);
					element.innerHTML = marked.parse(chunk);

					const container = document.getElementById('chatContainer');
					container.scrollTop = container.scrollHeight;

					index += charsPerTick;
				}, speed);
			});
		}

		function setGeneratingState(s) {
			isGenerating = s;
			const sendBtn = document.getElementById('sendBtn');
			if (s) {
				sendBtn.innerHTML = '<i data-lucide="square" class="w-4 h-4 text-red-500" fill="currentColor"></i>';
				sendBtn.classList.add('opacity-50');
			} else {
				sendBtn.innerHTML = '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 translate-x-0.5" fill="currentColor"><path d="M21.66,12a2,2,0,0,1-1.14,1.81L5.87,20.75A2.08,2.08,0,0,1,5,21a2,2,0,0,1-1.82-2.82L5.46,13H11a1,1,0,0,0,0-2H5.46L3.18,5.87A2,2,0,0,1,5.86,3.25h0l14.65,6.94A2,2,0,0,1,21.66,12Z"></path></svg>';
				sendBtn.classList.remove('opacity-50');
			}
			lucide.createIcons();
		}

		function toggleSidebar(s) {
			const sb = document.getElementById('mainSidebar');
			const ov = document.getElementById('sidebarOverlay');
			if (s) {
				sb.classList.remove('-translate-x-full');
				ov.classList.remove('hidden');
				setTimeout(() => ov.classList.remove('opacity-0'), 10);
			} else {
				sb.classList.add('-translate-x-full');
				ov.classList.add('opacity-0');
				setTimeout(() => ov.classList.add('hidden'), 300);
			}
		}

		document.getElementById('menuBtn').onclick = () => toggleSidebar(true);

		document.getElementById('sidebarOverlay').onclick = () => toggleSidebar(false);

		document.getElementById('settingsBtn').onclick = () => {
			document.getElementById('adminScreen').classList.replace('hidden', 'flex');
			fetchUsers();
		};

		document.getElementById('backFromAdmin').onclick = () => {
			document.getElementById('adminScreen').classList.replace('flex', 'hidden');
		};

		document.getElementById('newChatSidebarBtn').onclick = () => {
			currentSessionId = Date.now().toString();
			document.getElementById('messagesArea').innerHTML = '';
			chatHistory = [];
			toggleSidebar(false);
		};

		document.getElementById('sidebarLogoutBtn').onclick = () => {
			_supabase.auth.signOut().then(() => location.reload());
		};

		document.getElementById('loginForm').onsubmit = async (e) => {
			e.preventDefault();
			const { error } = await _supabase.auth.signInWithPassword({ email: emailInput.value, password: passwordInput.value });
			if (error) alert("Login Gagal"); else location.reload();
		};

		async function init() {
			const { data: { session } } = await _supabase.auth.getSession();
			if (session) {
				document.getElementById('loginScreen').style.display = 'none';
				document.getElementById('appInterface').style.display = 'flex';
				document.getElementById('sidebarEmail').innerText = session.user.email;

				loadAdminSettings();

				const { data: sessions } = await _supabase.from('chat_sessions').select('*').eq('user_id', session.user.id).order('timestamp', { ascending: false }).limit(1);
				if (sessions && sessions.length > 0) {
					loadSession(sessions[0].id);
				} else {
					currentSessionId = Date.now().toString();
					loadHistory();
				}
				lucide.createIcons();
			} else {
				document.getElementById('loginScreen').style.display = 'flex';
				document.getElementById('appInterface').style.display = 'none';
			}
			applyNativeKeyboardFix();
		}

		document.addEventListener('click', (e) => {
			if (!e.target.closest('.history-item-container')) {
				document.querySelectorAll('.history-item-container.swiped-left').forEach(c => {
					c.classList.remove('swiped-left');
				});
			}
		});

		const userInput = document.getElementById('userInput');
		const inputWrapper = document.getElementById('inputWrapper');

		userInput.addEventListener('input', function () {
			this.style.height = 'auto';
			this.style.height = this.scrollHeight + 'px';

			const isLongText = this.scrollHeight > 45;
			if (isLongText) {
				inputWrapper.classList.remove('rounded-[28px]');
				inputWrapper.classList.add('rounded-[22px]');
			} else {
				inputWrapper.classList.add('rounded-[28px]');
				inputWrapper.classList.remove('rounded-[22px]');
			}
		});

		document.getElementById('chatForm').onsubmit = sendMessage;
		init();
		function toggleAddUserForm() {
			const form = document.getElementById('addUserForm');
			form.classList.toggle('hidden');
			if (!form.classList.contains('hidden')) {
				document.getElementById('newUserEmail').focus();
			}
		}
		
		function applyNativeKeyboardFix() {
		    const inputs = document.querySelectorAll('input[type="text"], input[type="email"], input[type="password"], textarea');
		
		    inputs.forEach(el => {
		        el.required = true;
		        el.addEventListener('blur', () => {
		            window.scrollTo(0, 0);
		        });
		    });
		}

		async function fetchUsers() {
			const container = document.getElementById('userListContainer');
			container.innerHTML = `<div class="text-center py-4"><span class="text-xs font-medium text-slate-400">Memuat data user...</span></div>`;

			const { data: { session } } = await _supabase.auth.getSession();
			if (!session) {
				container.innerHTML = `<div class="text-center py-4 text-red-500 font-bold text-xs">Sesi Habis, Silakan Login Ulang</div>`;
				return;
			}

			try {
				const res = await fetch(USER_MGMT_URL, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${session.access_token}`
					},
					body: JSON.stringify({ action: 'list_users' })
				});

				const data = await res.json();
				if (data.error) throw new Error(data.error);

				container.innerHTML = '';
				if (!data.users || data.users.length === 0) {
					container.innerHTML = `<div class="text-center py-4"><span class="text-xs font-medium text-slate-400">Tidak ada user lain.</span></div>`;
					return;
				}

				data.users.forEach(u => {
				    const isBanned = u.banned_until && new Date(u.banned_until) > new Date();
				    const isMe = u.id === session.user.id;
				
				    const div = document.createElement('div');
				    div.className = "bg-white p-3 rounded-xl border border-slate-100 flex items-center justify-between";
					div.innerHTML = `
					    <div class="flex items-center gap-3 overflow-hidden">
					        <div class="w-8 h-8 rounded-full ${isBanned ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600'} flex items-center justify-center shrink-0">
					            <i data-lucide="${isBanned ? 'lock' : 'user'}" class="w-4 h-4"></i>
					        </div>
					        <div class="min-w-0 flex-1">
					            <p class="text-sm font-bold text-slate-700 truncate">${u.email}</p>
					            <p class="text-[10px] font-medium text-slate-400 truncate">ID: ${u.id}</p>
					        </div>
					    </div>
					    <div class="flex gap-2 shrink-0 ml-2">
					        ${!isMe ? `
					        <button onclick="toggleBanUser('${u.id}', ${isBanned})" class="p-2 rounded-lg ${isBanned ? 'bg-green-50 text-green-600 hover:bg-green-100' : 'bg-orange-50 text-orange-600 hover:bg-orange-100'} transition-colors" title="${isBanned ? 'Unfreeze' : 'Freeze'}">
					            <i data-lucide="${isBanned ? 'unlock' : 'lock'}" class="w-4 h-4"></i>
					        </button>
					        <button onclick="deleteUser('${u.id}')" class="p-2 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 transition-colors" title="Delete">
					            <i data-lucide="trash-2" class="w-4 h-4"></i>
					        </button>
					        ` : ''}
					    </div>
					`;
				    container.appendChild(div);
				});
				lucide.createIcons();

			} catch (e) {
				console.error(e);
				container.innerHTML = `<div class="text-center py-4 text-red-500 font-bold text-xs">Gagal memuat user: ${e.message}</div>`;
			}
		}

		async function createNewUser() {
			const email = document.getElementById('newUserEmail').value;
			const password = document.getElementById('newUserPassword').value;

			if (!email || !password) return alert("Email dan Password harus diisi!");

			const btn = event.target;
			const originalText = btn.innerText;
			btn.innerText = "PROSES...";
			btn.disabled = true;

			try {
				const { data: { session } } = await _supabase.auth.getSession();
				const res = await fetch(USER_MGMT_URL, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${session.access_token}`
					},
					body: JSON.stringify({ action: 'create_user', email, password })
				});

				const data = await res.json();
				if (data.error) throw new Error(data.error);

				alert("User berhasil dibuat!");
				document.getElementById('newUserEmail').value = '';
				document.getElementById('newUserPassword').value = '';
				toggleAddUserForm();
				fetchUsers();

			} catch (e) {
				alert("Gagal membuat user: " + e.message);
			} finally {
				btn.innerText = originalText;
				btn.disabled = false;
			}
		}

		async function deleteUser(userId) {
			if (!confirm("Yakin ingin menghapus user ini?")) return;

			try {
				const { data: { session } } = await _supabase.auth.getSession();
				const res = await fetch(USER_MGMT_URL, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${session.access_token}`
					},
					body: JSON.stringify({ action: 'delete_user', userId })
				});

				const data = await res.json();
				if (data.error) throw new Error(data.error);

				fetchUsers();
			} catch (e) {
				alert("Gagal menghapus: " + e.message);
			}
		}

		async function toggleBanUser(userId, iscurrentlyBanned) {
			const action = iscurrentlyBanned ? "unfreeze" : "freeze";
			const duration = iscurrentlyBanned ? '0s' : '876600h';

			if (!confirm(`Yakin ingin ${action} user ini?`)) return;

			try {
				const { data: { session } } = await _supabase.auth.getSession();
				const res = await fetch(USER_MGMT_URL, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${session.access_token}`
					},
					body: JSON.stringify({ action: 'toggle_ban_user', userId, banDuration: duration })
				});

				const data = await res.json();
				if (data.error) throw new Error(data.error);

				fetchUsers();
			} catch (e) {
				alert(`Gagal ${action}: ` + e.message);
			}
		}
	</script>
</body>


</html>
