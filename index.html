<!DOCTYPE html>
<html lang="id">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<title>ASISTEN</title>
	<meta name="mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="default">
	<meta name="theme-color" content="#ffffff">
	<meta name="apple-mobile-web-app-title" content="ASISTEN">
	<link rel="apple-touch-icon" href="icon/icon-512.png">
	<link rel="icon" type="image/png" href="icon/icon-512.png">
	<link rel="manifest" href="manifest.json">

	<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
	<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
	<script src="https://cdn.tailwindcss.com"></script>
	<script src="https://unpkg.com/lucide@latest"></script>
	<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
	<link
		href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono&display=swap"
		rel="stylesheet">
	<style>
		html,
		body {
			margin: 0;
			padding: 0;
			height: 100%;
			height: 100dvh;
			width: 100vw;
			overflow: hidden !important;
			background-color: #ffffff;
			font-family: 'Inter', sans-serif;
			position: fixed;
			top: 0;
			left: 0;
			overscroll-behavior: none !important;
			touch-action: pan-x pan-y;
			-webkit-text-size-adjust: 100%;
		}

		*,
		*::before,
		*::after {
			-webkit-user-select: none;
			user-select: none;
			-webkit-touch-callout: none;
			-webkit-tap-highlight-color: transparent;
		}

		.prose,
		.prose * {
			-webkit-user-select: text !important;
			user-select: text !important;
			cursor: text;
		}

		input,
		textarea {
			-webkit-user-select: text !important;
			user-select: text !important;
			-webkit-touch-callout: default;
		}

		img {
			-webkit-user-drag: none;
			pointer-events: none;
		}

		.prose img {
			pointer-events: auto;
		}

		#appInterface {
			width: 100%;
			height: 100dvh;
			height: 100%;
			display: none;
			flex-direction: column;
			background-color: #ffffff;
			position: absolute;
			overflow: hidden;
		}

		#mainSidebar {
			display: flex;
			flex-direction: column;
			overscroll-behavior: contain;
		}

		.sidebar-bottom-controls {
			flex: 0 0 auto;
			background-color: #ffffff;
			border-top: 1px solid #f8fafc;
			padding: 12px 1rem 24px;
		}

		#historyList {
			flex: 1 1 auto;
			overflow-y: auto;
			padding-bottom: 32px;
		}

		.history-item-container {
			position: relative;
			overflow: hidden;
			border-radius: 8px;
			margin-bottom: 2px;
			background-color: transparent;
		}

		.history-item-delete {
			position: absolute;
			right: 0;
			top: 0;
			bottom: 0;
			width: 50px;
			background-color: #fef2f2;
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 1;
			opacity: 0;
			transition: opacity 0.2s ease;
			border-radius: 0 8px 8px 0;
		}

		.history-item-delete i,
		.history-item-delete svg {
			width: 14px !important;
			height: 14px !important;
			color: #ef4444 !important;
		}

		.history-item-content {
			position: relative;
			z-index: 2;
			background-color: #ffffff;
			border-radius: 8px;
			transition: transform 0.15s ease-out;
			will-change: transform;
			border: 0.5px solid #f1f5f9;
		}

		.swiped-left .history-item-delete {
			opacity: 1;
		}

		.swiped-left .history-item-content {
			transform: translateX(-50px);
			border-top-right-radius: 0;
			border-bottom-right-radius: 0;
		}

		header {
			flex: 0 0 auto;
			background: white;
			border-bottom: 1px solid #f8fafc;
			z-index: 100;
		}

		main {
			flex: 1 1 auto;
			overflow-y: auto;
			background-color: #ffffff;
			position: relative;
			overscroll-behavior: contain;
			-webkit-overflow-scrolling: touch;
		}

		footer {
			flex: 0 0 auto;
			background-color: #ffffff;
			z-index: 100;
			padding-top: 16px;
			padding-bottom: 20px;
			border-top: 1px solid #ffffff;
			margin-top: -1px;
		}

		.content-width {
			width: 100%;
			max-width: 48rem;
			margin: 0 auto;
			padding: 0 1rem;
		}



		.prose pre {
			background: #f3f4f6 !important;
			padding: 1rem !important;
			border-radius: 1rem !important;
			margin: 0.75rem 0;
			overflow-x: auto;
		}

		.prose code {
			background-color: #f1f5f9 !important;
			padding: 2px 5px !important;
			border-radius: 4px !important;
			font-family: 'JetBrains Mono', monospace !important;
			font-size: 0.875rem;
		}

		.prose ul {
			list-style-type: disc;
			padding-left: 1.25rem;
			margin: 0.5rem 0;
		}

		.prose ol {
			list-style-type: decimal;
			padding-left: 1.25rem;
			margin: 0.5rem 0;
		}

		.prose li {
			margin: 0.25rem 0;
		}

		.prose table {
			width: 100%;
			border-collapse: separate;
			border-spacing: 0;
			margin: 1rem 0;
			font-size: 0.875rem;
			border: 1px solid #e2e8f0;
			border-radius: 0.5rem;
			overflow: hidden;
		}

		.prose th,
		.prose td {
			border-bottom: 1px solid #e2e8f0;
			border-right: 1px solid #e2e8f0;
			padding: 0.75rem;
			text-align: left;
		}

		.prose th:last-child,
		.prose td:last-child {
			border-right: none;
		}

		.prose tr:last-child td {
			border-bottom: none;
		}

		.prose th {
			background-color: #f8fafc;
			font-weight: 600;
			color: #475569;
		}

		.prose blockquote {
			border-left: 4px solid #e2e8f0;
			padding-left: 1rem;
			color: #64748b;
			font-style: italic;
			margin: 1rem 0;
		}

		.prose p {
			margin-bottom: 0.75rem;
			line-height: 1.6;
		}

		.prose strong {
			font-weight: 700;
			color: #1e293b;
		}

		.prose a {
			color: #2563eb;
			text-decoration: underline;
			font-weight: 500;
		}

		::-webkit-scrollbar {
			display: none;
		}

		.typing-indicator {
			display: flex;
			align-items: center;
			gap: 4px;
			height: 22px;
		}

		.typing-dot {
			width: 3px;
			height: 3px;
			background-color: #94a3b8;
			border-radius: 50%;
			animation: dot-sequence 1.5s infinite ease-in-out;
			opacity: 0;
		}

		.typing-dot:nth-child(1) {
			animation-delay: 0s;
		}

		.typing-dot:nth-child(2) {
			animation-delay: 0.2s;
		}

		.typing-dot:nth-child(3) {
			animation-delay: 0.4s;
		}

		@keyframes dot-sequence {

			0%,
			100% {
				opacity: 0.2;
				transform: scale(0.8);
			}

			50% {
				opacity: 1;
				transform: scale(1.2);
			}
		}

		@keyframes spin {
			to {
				transform: rotate(360deg);
			}
		}

		.btn-spinner {
			width: 18px;
			height: 18px;
			border: 2.5px solid rgba(255, 255, 255, 0.3);
			border-top-color: #fff;
			border-radius: 50%;
			animation: spin 0.6s linear infinite;
			display: inline-block;
		}

		.btn-spinner.dark {
			border-color: rgba(37, 99, 235, 0.2);
			border-top-color: #2563eb;
		}

		.toast-notification {
			position: fixed;
			bottom: 90px;
			left: 50%;
			transform: translateX(-50%) translateY(20px);
			background: #1e293b;
			color: #fff;
			padding: 12px 24px;
			border-radius: 16px;
			font-size: 13px;
			font-weight: 600;
			z-index: 9999;
			opacity: 0;
			transition: all 0.3s ease;
			pointer-events: none;
			max-width: 90vw;
			text-align: center;
			box-shadow: 0 8px 32px rgba(0, 0, 0, 0.18);
		}

		.toast-notification.toast-error {
			background: #dc2626;
		}

		.toast-notification.toast-success {
			background: #16a34a;
		}

		.toast-notification.show {
			opacity: 1;
			transform: translateX(-50%) translateY(0);
		}
	</style>
</head>

<body class="text-slate-900">
	<div id="sidebarOverlay"
		class="fixed inset-0 bg-black/20 z-[150] hidden backdrop-blur-sm transition-opacity duration-300 opacity-0 cursor-pointer">
	</div>
	<div id="mainSidebar" style="visibility: hidden; transform: translateX(-100%);"
		class="fixed inset-y-0 left-0 w-[280px] bg-white z-[160] transform -translate-x-full opacity-0 flex flex-col border-r border-slate-100 shadow-2xl">
		<div class="h-16 flex items-center px-4 border-b border-slate-50 shrink-0">
			<div class="flex items-center gap-3 w-full">
				<div
					class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-600 font-bold shadow-sm shrink-0">
					<i data-lucide="user" class="w-5 h-5"></i>
				</div>
				<div class="flex-1 min-w-0">
					<p id="sidebarEmail" class="text-[14px] font-bold text-slate-600 truncate font-sans">
						user@example.com</p>
				</div>
			</div>
		</div>
		<div class="flex-1 overflow-y-auto px-3 pt-4 pb-2" id="historyList"></div>
		<div class="sidebar-bottom-controls">
			<div class="space-y-2">
				<button id="newChatSidebarBtn"
					class="w-full flex items-center gap-3 px-4 py-3 text-slate-700 bg-slate-50 rounded-xl font-bold text-sm">
					<i data-lucide="plus" class="w-[18px] h-[18px]"></i> Percakapan Baru
				</button>
				<button id="sidebarLogoutBtn"
					class="w-full flex items-center gap-3 px-4 py-3 text-slate-500 bg-slate-50 rounded-xl font-bold text-sm hover:text-red-600">
					<i data-lucide="log-out" class="w-[18px] h-[18px]"></i> Keluar
				</button>
			</div>
		</div>
	</div>

	<div id="loginScreen" class="fixed inset-0 bg-white z-[100] flex items-center justify-center p-6"
		style="display: none;">
		<div class="w-full max-w-[360px] bg-white rounded-[32px] px-8 py-8 flex flex-col items-center shadow-lg">
			<img src="icon/icon.png" alt="Logo" class="w-16 h-16 mb-8 object-contain">
			<form id="loginForm" class="w-full space-y-4">
				<input type="email" id="emailInput" placeholder="Email" required
					class="w-full px-5 py-4 bg-gray-50 rounded-2xl text-sm font-semibold border-none outline-none">
				<input type="password" id="passwordInput" placeholder="Password" required
					class="w-full px-5 py-4 bg-gray-50 rounded-2xl text-sm font-semibold border-none outline-none">
				<button type="submit" id="loginBtn"
					class="w-full py-4 bg-black text-white rounded-2xl font-bold text-sm uppercase flex items-center justify-center gap-2 min-h-[52px]"><span
						id="loginBtnText">Masuk</span></button>
				<div id="loginError"
					class="text-red-500 text-[11px] font-bold hidden text-center uppercase mt-2 tracking-widest"></div>
			</form>
		</div>
	</div>

	<div id="appInterface" style="display: none;">
		<header class="h-16 px-4 md:px-8 flex items-center">
			<div class="w-full flex justify-between items-center">
				<div class="flex items-center">
					<img src="icon/icon.png" alt="Logo" class="h-8 w-auto object-contain">
				</div>
				<div class="flex items-center gap-1">
					<button id="settingsBtn" class="p-2.5 text-slate-400 rounded-xl active:scale-95"><i
							data-lucide="settings-2" class="w-6 h-6"></i></button>
					<button id="menuBtn" class="p-2.5 text-slate-400 rounded-xl active:scale-95 -mr-2.5"><i
							data-lucide="menu" class="w-6 h-6"></i></button>
				</div>
			</div>
		</header>

		<main id="chatContainer" class="custom-scroll">
			<div class="content-width pt-4 pb-8">
				<div id="messagesArea" class="space-y-4"></div>
			</div>
		</main>

		<footer>
			<div class="footer-content content-width">
				<div id="file-preview-container" class="grid grid-cols-2 md:grid-cols-4 gap-2 empty:hidden mb-4"></div>
				<form id="chatForm" class="w-full">
					<div id="inputWrapper"
						class="relative flex items-end gap-1 bg-slate-50 rounded-[28px] p-1.5 border border-slate-100 transition-all duration-200">
						<input type="file" id="file-input" multiple
							accept="image/*,application/pdf,.docx,.xlsx,.xls,.pptx,.js,.css,.java,.html,.xml,.py,.sql,.ts,.cpp,.h,.hpp,.lua,.swift"
							class="hidden" onchange="handleFileSelect(event)">

						<button type="button" id="uploadBtn" onclick="document.getElementById('file-input').click()"
							class="w-10 h-10 flex items-center justify-center text-slate-400 hover:text-slate-600 shrink-0 transition-colors">
							<i data-lucide="plus" class="w-6 h-6"></i>
						</button>

						<textarea id="userInput" placeholder="Tulis pesan..." rows="1"
							class="flex-1 min-h-[40px] max-h-[150px] py-2.5 px-2 bg-transparent border-none outline-none resize-none text-[15px] font-medium text-slate-700 placeholder:text-slate-400 leading-tight"></textarea>

						<button type="submit" id="sendBtn"
							class="w-10 h-10 flex items-center justify-center bg-transparent text-black shrink-0 active:scale-90 transition-transform">
							<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6"
								fill="currentColor">
								<path
									d="M21.66,12a2,2,0,0,1-1.14,1.81L5.87,20.75A2.08,2.08,0,0,1,5,21a2,2,0,0,1-1.82-2.82L5.46,13H11a1,1,0,0,0,0-2H5.46L3.18,5.87A2,2,0,0,1,5.86,3.25h0l14.65,6.94A2,2,0,0,1,21.66,12Z">
								</path>
							</svg>
						</button>
					</div>
				</form>
			</div>
		</footer>
	</div>

	<div id="adminScreen" class="fixed inset-0 bg-white z-[200] hidden flex-col">
		<header class="h-16 px-4 md:px-8 flex items-center border-b border-slate-100 shrink-0 relative">
			<div class="flex items-center z-10">
				<button id="backFromAdmin" class="p-2 -ml-2 text-slate-400 active:scale-90">
					<i data-lucide="chevron-left" class="w-6 h-6"></i>
				</button>
			</div>
			<div class="absolute inset-0 flex items-center justify-center pointer-events-none">
				<h2 class="text-sm font-black text-slate-800 uppercase tracking-widest">Admin Control</h2>
			</div>
		</header>

		<main class="flex-1 overflow-y-auto bg-white">
			<div class="content-width pt-4 pb-10 space-y-4">
				<div class="w-full bg-slate-50 rounded-2xl p-5 shadow-sm">
					<div class="mb-4">
						<span class="text-xs font-black text-slate-500 uppercase tracking-widest">Model AI</span>
					</div>
					<div class="space-y-4">
						<div class="relative" id="model-dropdown">
							<button type="button" id="dropdown-trigger"
								class="w-full bg-gray-100 rounded-xl px-5 py-3 text-[15px] font-bold text-slate-700 flex items-center justify-between outline-none">
								<span id="selected-model-text">Gemini 3 Flash</span>
								<i data-lucide="chevron-down"
									class="w-4 h-4 text-slate-400 transition-transform duration-200 transform"
									id="dropdown-icon"></i>
							</button>
							<div id="dropdown-menu"
								class="hidden absolute left-0 right-0 mt-2 bg-white rounded-2xl shadow-xl border border-slate-100 p-2 z-[210]">
								<div class="flex flex-col">
									<div class="dropdown-option py-3 px-4 rounded-xl hover:bg-slate-50 cursor-pointer text-sm font-medium text-slate-800"
										data-value="gemini-2.5-pro">Gemini 2.5 Pro</div>
									<div class="dropdown-option py-3 px-4 rounded-xl hover:bg-slate-50 cursor-pointer text-sm font-medium text-slate-800"
										data-value="gemini-2.5-flash">Gemini 2.5 Flash</div>
									<div class="dropdown-option py-3 px-4 rounded-xl hover:bg-slate-50 cursor-pointer text-sm font-medium text-slate-800"
										data-value="gemini-2.5-flash-lite">Gemini 2.5 Flash-Lite</div>
									<div class="dropdown-option py-3 px-4 rounded-xl hover:bg-slate-50 cursor-pointer text-sm font-medium text-slate-800"
										data-value="gemini-3-flash-preview">Gemini 3 Flash</div>
									<div class="dropdown-option py-3 px-4 rounded-xl hover:bg-slate-50 cursor-pointer text-sm font-medium text-slate-800"
										data-value="gemini-3-pro-preview">Gemini 3 Pro</div>
								</div>
							</div>
						</div>
					</div>
				</div>



				<div class="w-full bg-slate-50 rounded-2xl p-5 shadow-sm">
					<div class="mb-6">
						<span class="text-xs font-black text-slate-500 uppercase tracking-widest">Parameter AI</span>
					</div>
					<div class="space-y-6">
						<div>
							<div class="flex justify-between items-center mb-2">
								<span
									class="text-[11px] font-bold text-slate-400 uppercase tracking-wider">Temperature</span>
								<span id="label-temp" class="text-[11px] font-black text-slate-600">1.0</span>
							</div>
							<input type="range" id="settings-temp" min="0" max="2" step="0.1"
								class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-600">
						</div>

						<div>
							<div class="flex justify-between items-center mb-2">
								<span class="text-[11px] font-bold text-slate-400 uppercase tracking-wider">Max
									Tokens</span>
								<span id="label-tokens" class="text-[11px] font-black text-slate-600">65536</span>
							</div>
							<input type="range" id="settings-tokens" min="1024" max="65536" step="1024"
								class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-600">
						</div>

						<div>
							<div class="flex justify-between items-center mb-2">
								<span class="text-[11px] font-bold text-slate-400 uppercase tracking-wider">Thinking
									Budget</span>
								<span id="label-thinking" class="text-[11px] font-black text-slate-600">MEDIUM</span>
							</div>
							<input type="range" id="settings-thinking" min="1" max="3" step="1"
								class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-600">
						</div>
					</div>
				</div>

				<div class="w-full bg-slate-50 rounded-2xl p-5 shadow-sm">
					<div class="mb-4">
						<span class="text-xs font-black text-slate-500 uppercase tracking-widest">System Prompt</span>
					</div>
					<textarea id="systemPromptInput" rows="4"
						class="w-full bg-gray-100 rounded-xl px-4 py-3 text-[15px] font-medium text-slate-600 outline-none resize-none"></textarea>
				</div>

				<!-- KNOWLEDGE BASE SECTION -->
				<div class="w-full bg-slate-50 rounded-2xl p-5 shadow-sm">
					<div class="mb-4">
						<span class="text-xs font-black text-slate-500 uppercase tracking-widest">Knowledge Base</span>
					</div>
					<div class="space-y-4">


						<div class="flex gap-2">
							<input type="file" id="kb-file-input" accept=".txt" class="hidden">
							<button type="button" onclick="document.getElementById('kb-file-input').click()"
								class="flex-1 flex items-center justify-center gap-2 py-3 bg-white rounded-xl border border-slate-100 text-sm font-bold text-slate-600 hover:bg-slate-50 active:scale-95 transition-all">
								<i data-lucide="upload" class="w-4 h-4"></i>
								Upload Knowledge Base
							</button>
						</div>

						<div id="kb-upload-progress" class="hidden">
							<div class="bg-white p-3 rounded-xl border border-slate-100">
								<div class="flex items-center gap-2 mb-2">
									<div class="btn-spinner dark"></div>
									<span id="kb-progress-text"
										class="text-xs font-bold text-slate-500">Memproses...</span>
								</div>
								<div class="w-full bg-slate-100 rounded-full h-1.5">
									<div id="kb-progress-bar"
										class="bg-emerald-500 h-1.5 rounded-full transition-all duration-300"
										style="width: 0%"></div>
								</div>
							</div>
						</div>

						<div id="kb-doc-list" class="space-y-2"></div>
					</div>
				</div>

				<!-- MANAJEMEN USER SECTION -->
				<div class="w-full bg-slate-50 rounded-2xl p-5 shadow-sm">
					<div class="flex justify-between items-center mb-4">
						<span class="text-xs font-black text-slate-500 uppercase tracking-widest">Manajemen User</span>
						<button onclick="toggleAddUserForm()"
							class="text-xs font-bold text-blue-600 hover:text-blue-700 bg-blue-50 px-3 py-1.5 rounded-lg transition-colors">
							+ Add User
						</button>
					</div>

					<!-- Form Add User -->
					<div id="addUserForm"
						class="hidden mb-6 bg-white p-5 rounded-3xl border border-slate-100 space-y-4 shadow-sm">
						<div class="space-y-3">
							<input type="email" id="newUserEmail" placeholder="Email User Baru" required
								class="w-full px-5 py-4 bg-slate-50 rounded-2xl text-sm font-semibold border-none outline-none text-slate-700 placeholder:text-slate-400">

							<input type="password" id="newUserPassword" placeholder="Password User Baru" required
								class="w-full px-5 py-4 bg-slate-50 rounded-2xl text-sm font-semibold border-none outline-none text-slate-700 placeholder:text-slate-400">
						</div>

						<div class="pt-2">
							<button onclick="createNewUser(event)"
								class="w-full py-4 bg-blue-50 text-blue-600 rounded-2xl font-bold text-sm uppercase hover:bg-blue-100 active:scale-95 transition-all">
								TAMBAH
							</button>
						</div>
					</div>

					<div id="userListContainer" class="space-y-3">
						<!-- User Items will be injected here -->
						<div class="text-center py-4">
							<span class="text-xs font-medium text-slate-400">Memuat data user...</span>
						</div>
					</div>
				</div>
			</div>
		</main>
		<div class="flex-none w-full bg-white h-[20px] z-50 shrink-0"></div>
	</div>

	<template id="historyItemTemplate">
		<div
			class="history-item-root group relative flex items-center justify-between w-full rounded-xl mb-1 pr-1.5 transition-all">
			<button
				class="history-title-btn flex-1 text-left truncate py-2 pl-4 text-[13px] font-medium font-sans outline-none text-slate-600">
				Percakapan Baru
			</button>
			<div class="relative shrink-0">
				<button
					class="history-menu-btn p-1.5 rounded-lg text-slate-400 hover:text-slate-600 transition-all opacity-0 group-hover:opacity-100">
					<i data-lucide="more-vertical" class="w-4 h-4"></i>
				</button>
				<div
					class="history-dropdown hidden absolute right-0 top-10 w-36 bg-white rounded-xl shadow-xl border border-slate-100 z-50 flex-col p-1.5 animate-in fade-in zoom-in-95 duration-100 origin-top-right">
					<button
						class="history-rename-btn w-full text-left px-3 py-2.5 text-xs font-bold text-slate-600 hover:bg-slate-50 rounded-lg flex items-center gap-2 transition-colors">
						<i data-lucide="pencil" class="w-3.5 h-3.5 text-slate-400"></i> Ganti Nama
					</button>
					<div class="h-px bg-slate-100 my-1"></div>
					<button
						class="history-delete-btn w-full text-left px-3 py-2.5 text-xs font-bold text-red-600 hover:bg-red-50 rounded-lg flex items-center gap-2 transition-colors">
						<i data-lucide="trash-2" class="w-3.5 h-3.5 text-red-500"></i> Hapus
					</button>
				</div>
			</div>
		</div>
	</template>

	<!-- CUSTOM MODALS -->
	<!-- Rename Modal -->
	<div id="renameModal"
		class="fixed inset-0 w-full h-full bg-black/60 z-[9999] hidden flex items-center justify-center backdrop-blur-sm transition-opacity duration-200 opacity-0">
		<div class="bg-white w-[90%] max-w-[320px] rounded-2xl p-6 shadow-2xl transform scale-95 transition-transform duration-200 relative"
			id="renameModalContent">
			<h3 class="text-base font-bold text-slate-800 mb-1">Ganti nama chat ini</h3>
			<p class="text-xs text-slate-500 mb-4">Masukkan nama baru untuk percakapan ini.</p>

			<input type="text" id="renameInput" onblur="window.scrollTo(0,0)"
				class="w-full bg-slate-50 border-none rounded-2xl px-5 py-4 text-sm font-semibold text-slate-700 outline-none ring-0 focus:ring-0 transition-all mb-6 placeholder:text-slate-400"
				placeholder="Nama percakapan..." autocomplete="off">

			<div class="flex gap-2">
				<button onclick="closeRenameModal()"
					class="flex-1 py-2.5 bg-slate-100 text-slate-600 rounded-xl text-xs font-bold hover:bg-slate-200 transition-colors">
					Batal
				</button>
				<button onclick="submitRename()"
					class="flex-1 py-2.5 bg-blue-50 text-blue-600 rounded-xl text-xs font-bold hover:bg-blue-100 transition-colors">
					Ganti Nama
				</button>
			</div>
		</div>
	</div>

	<!-- User Action Modal (Delete/Freeze) -->
	<div id="userActionModal"
		class="fixed inset-0 w-full h-full bg-black/60 z-[9999] hidden flex items-center justify-center backdrop-blur-sm transition-opacity duration-200 opacity-0">
		<div class="bg-white w-[90%] max-w-[320px] rounded-2xl p-6 shadow-2xl transform scale-95 transition-transform duration-200 relative"
			id="userActionModalContent">
			<h3 id="userActionTitle" class="text-base font-bold text-slate-800 mb-2">Konfirmasi</h3>
			<p id="userActionMessage" class="text-[13px] text-slate-500 mb-6 leading-relaxed">Apakah Anda yakin?</p>

			<div class="flex gap-2">
				<button onclick="closeUserActionModal()"
					class="flex-1 py-2.5 bg-slate-100 text-slate-600 rounded-xl text-xs font-bold hover:bg-slate-200 transition-colors">
					Batal
				</button>
				<button id="userActionConfirmBtn" onclick="confirmUserAction()"
					class="flex-1 py-2.5 bg-red-50 text-red-600 rounded-xl text-xs font-bold hover:bg-red-100 transition-colors">
					Konfirmasi
				</button>
			</div>
		</div>
	</div>

	<!-- Delete Modal -->
	<div id="deleteModal"
		class="fixed inset-0 w-full h-full bg-black/60 z-[9999] hidden flex items-center justify-center backdrop-blur-sm transition-opacity duration-200 opacity-0">
		<div class="bg-white w-[90%] max-w-[320px] rounded-2xl p-6 shadow-2xl transform scale-95 transition-transform duration-200 relative"
			id="deleteModalContent">
			<h3 class="text-base font-bold text-slate-800 mb-2">Hapus chat?</h3>
			<p class="text-[13px] text-slate-500 mb-6 leading-relaxed">Tindakan ini akan menghapus perintah, respons,
				dan masukan serta konten apa pun yang Anda buat.</p>

			<div class="flex gap-2">
				<button onclick="closeDeleteModal()"
					class="flex-1 py-2.5 bg-slate-100 text-slate-600 rounded-xl text-xs font-bold hover:bg-slate-200 transition-colors">
					Batal
				</button>
				<button onclick="confirmDelete()"
					class="flex-1 py-2.5 bg-red-50 text-red-600 rounded-xl text-xs font-bold hover:bg-red-100 transition-colors">
					Hapus
				</button>
			</div>
		</div>
	</div>

	<script>
		const SUPABASE_URL = "https://wddsihtjvntvipswmbtp.supabase.co";
		const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndkZHNpaHRqdm50dmlwc3dtYnRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMjg2NDMsImV4cCI6MjA4NDYwNDY0M30.fyz5Uv7eOUb9zQIbH2OBuZbGu1FZ1_2aYT6deOmojrY";
		const PROXY_URL = `${SUPABASE_URL}/functions/v1/gemini-proxy`;

		const USER_MGMT_URL = `${SUPABASE_URL}/functions/v1/user-management`;
		const SELECTED_MODEL = "gemini-3-flash-preview";
		const SYSTEM_PROMPT = `Kamu adalah AI Asisten Inspektorat Provinsi Lampung yang Ramah, Profesional, dan Sangat Membantu. Tugas kamu adalah menjawab semua pertanyaan dengan baik dan akurat, serta menyajikan informasi pengawasan dan peraturan terbaru (gunakan Google Search untuk data terkini).`;
		const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
		const FILE_CARD_SEPARATOR = "|||FILE_CARDS|||";

		let chatHistory = [];
		let currentSessionId = null;
		let isGenerating = false;
		let typingBubble = null;
		let pendingFiles = [];
		let abortController = null;
		let typingInterval = null;
		let currentLoadingMsgId = null;
		let currentStreamedText = "";
		let typeWriterResolve = null;

		let currentSelectedModel = localStorage.getItem('awas_model') || "gemini-3-flash-preview";
		const thinkingMap = { "1": 4000, "2": 16000, "3": 32000 };

		function showToast(message, type = "info") {
			const existing = document.querySelector('.toast-notification');
			if (existing) existing.remove();

			const toast = document.createElement('div');
			toast.className = `toast-notification ${type === 'error' ? 'toast-error' : type === 'success' ? 'toast-success' : ''}`;
			toast.textContent = message;
			document.body.appendChild(toast);

			requestAnimationFrame(() => {
				requestAnimationFrame(() => toast.classList.add('show'));
			});

			setTimeout(() => {
				toast.classList.remove('show');
				setTimeout(() => toast.remove(), 300);
			}, 3000);
		}

		async function saveAdminSettings() {
			// HANYA SIMPAN SETTING GLOBAL (Model, Param, Prompt)
			// Setting User (Upload, KB, Search) disimpan per user via toggle di list user

			const settings = {
				model: currentSelectedModel,
				temperature: parseFloat(document.getElementById('settings-temp').value),
				max_tokens: parseInt(document.getElementById('settings-tokens').value),
				thinking_level: parseInt(document.getElementById('settings-thinking').value),
				system_prompt: document.getElementById('systemPromptInput').value,
				// use_google_search, kb, upload dihapus dari sini karena pindah ke per-user
				updated_at: new Date()
			};

			try {
				const { error } = await _supabase
					.from('app_settings')
					.update(settings)
					.eq('id', 1);

				if (error) throw error;
				// showToast("Pengaturan global disimpan", "success");
			} catch (e) {
				console.error(e);
			}
		}

		async function loadAdminSettings() {
			try {
				// 1. Load Global App Settings (Model, Prompt, etc)
				// Menggunakan try-catch/if terpisah agar jika gagal (misal RLS blocked),
				// settingan user (Step 2) tetap tereksekusi.
				const { data: globalData, error: globalError } = await _supabase
					.from('app_settings')
					.select('*')
					.eq('id', 1)
					.single();

				if (globalData && !globalError) {
					// Global Config
					currentSelectedModel = globalData.model;
					localStorage.setItem('awas_model', currentSelectedModel);
					// Hapus setting global upload/kb/g-search dari sini (pindah ke user profile)

					const elModel = document.getElementById('selected-model-text');
					if (elModel) {
						const modelLabels = {
							"gemini-2.5-pro": "Gemini 2.5 Pro",
							"gemini-2.5-flash": "Gemini 2.5 Flash",
							"gemini-2.5-flash-lite": "Gem Gemini 2.5 Flash-Lite",
							"gemini-3-flash-preview": "Gemini 3 Flash",
							"gemini-3-pro-preview": "Gemini 3 Pro"
						};
						elModel.innerText = modelLabels[globalData.model] || globalData.model;
					}

					const elTemp = document.getElementById('settings-temp');
					if (elTemp) {
						elTemp.value = globalData.temperature;
						document.getElementById('label-temp').innerText = globalData.temperature;
					}

					const elToken = document.getElementById('settings-tokens');
					if (elToken) {
						elToken.value = globalData.max_tokens;
						document.getElementById('label-tokens').innerText = globalData.max_tokens;
					}

					const elThink = document.getElementById('settings-thinking');
					if (elThink) {
						elThink.value = globalData.thinking_level;
						document.getElementById('label-thinking').innerText = ["LOW", "MEDIUM", "HIGH"][globalData.thinking_level - 1];
					}

					const elPrompt = document.getElementById('systemPromptInput');
					if (elPrompt) elPrompt.value = globalData.system_prompt;
				}

				const { data: { session } } = await _supabase.auth.getSession();
				if (session) {
					const { data: profile, error: profErr } = await _supabase.from('profiles').select('*').eq('id', session.user.id).maybeSingle();

					if (profErr) {
						console.error("Error loading profile:", profErr);
					}

					if (profile) {
						const useGoogle = profile.use_google_search === true;
						const useKB = profile.use_knowledge_base === true;
						const allowUpload = profile.allow_file_upload === true;

						console.log(`[PROFILE LOADED] User: ${profile.email}`);
						console.log(`[SETTINGS] Google: ${useGoogle}, KB: ${useKB}, Upload: ${allowUpload}`);

						// Update UI state based on permission


						localStorage.setItem('awas_settings_google', useGoogle ? 'true' : 'false');
						localStorage.setItem('awas_settings_kb', useKB ? 'true' : 'false');
						localStorage.setItem('awas_allow_upload', allowUpload ? 'true' : 'false');

						applyUploadUIState(allowUpload);

						if (useKB) {
							loadKBDocuments();
						} else {
							document.getElementById('kb-doc-list').innerHTML = '<p class="text-xs text-slate-400 text-center py-2">Fitur Knowledge Base dinonaktifkan untuk akun Anda.</p>';
						}
					} else {
						console.warn("Profile not found for user, defaulting to RESTRICTED.");
						localStorage.setItem('awas_settings_google', 'false');
						localStorage.setItem('awas_settings_kb', 'false');
						localStorage.setItem('awas_allow_upload', 'false');
						applyUploadUIState(false);
					}
				}

			} catch (e) {
				console.error("Error loading settings:", e);
			}
		}

		function applyUploadUIState(isEnabled) {
			const uploadBtn = document.getElementById('uploadBtn');
			const inputWrapper = document.getElementById('inputWrapper');

			if (isEnabled) {
				uploadBtn.style.display = 'flex';
				inputWrapper.style.paddingLeft = '6px';
			} else {
				uploadBtn.style.display = 'none';
				inputWrapper.style.paddingLeft = '16px';
			}
		}



		document.getElementById('settings-tokens').oninput = function () {
			document.getElementById('label-tokens').innerText = this.value;
		};
		document.getElementById('settings-temp').oninput = function () {
			document.getElementById('label-temp').innerText = this.value;
		};
		document.getElementById('settings-thinking').oninput = function () {
			const labels = ["LOW", "MEDIUM", "HIGH"];
			document.getElementById('label-thinking').innerText = labels[this.value - 1];
		};

		// --- LISTENERS ---
		document.getElementById('settings-tokens').onchange = saveAdminSettings;
		document.getElementById('settings-temp').onchange = saveAdminSettings;
		document.getElementById('settings-thinking').onchange = saveAdminSettings;
		document.getElementById('systemPromptInput').onchange = saveAdminSettings;

		const dropdownTrigger = document.getElementById('dropdown-trigger');
		const dropdownMenu = document.getElementById('dropdown-menu');
		const dropdownOptions = document.querySelectorAll('.dropdown-option');

		if (dropdownTrigger) {
			dropdownTrigger.onclick = (e) => {
				e.stopPropagation();
				const dropdownIcon = document.getElementById('dropdown-icon');
				dropdownMenu.classList.toggle('hidden');
				if (dropdownIcon) dropdownIcon.classList.toggle('rotate-180');
			};

			document.addEventListener('click', (e) => {
				if (!dropdownTrigger.contains(e.target) && !dropdownMenu.contains(e.target)) {
					const dropdownIcon = document.getElementById('dropdown-icon');
					dropdownMenu.classList.add('hidden');
					if (dropdownIcon) {
						dropdownIcon.classList.remove('rotate-180');
						dropdownIcon.style.transform = '';
					}
				}
			});

			dropdownOptions.forEach(option => {
				option.onclick = () => {
					const value = option.getAttribute('data-value');
					const text = option.innerText;
					const dropdownIcon = document.getElementById('dropdown-icon');

					currentSelectedModel = value;
					localStorage.setItem('awas_model', value);
					document.getElementById('selected-model-text').innerText = text;

					dropdownMenu.classList.add('hidden');
					if (dropdownIcon) {
						dropdownIcon.classList.remove('rotate-180');
						dropdownIcon.style.transform = '';
					}

					saveAdminSettings();
					showToast(`Model aktif: ${text}`, 'success');
				};
			});
		}


		document.getElementById('kb-file-input').onchange = (e) => uploadKnowledgeBase(e);


		function findScrollableParent(el, axis) {
			while (el && el !== document.body) {
				const style = window.getComputedStyle(el);
				const overflow = style.getPropertyValue(axis === 'x' ? 'overflow-x' : 'overflow-y');
				if (overflow === 'auto' || overflow === 'scroll') {
					const hasScroll = axis === 'x'
						? el.scrollWidth > el.clientWidth
						: el.scrollHeight > el.clientHeight;
					if (hasScroll) return el;
				}
				el = el.parentElement;
			}
			return null;
		}

		document.addEventListener('touchstart', function (event) {
			const touch = event.touches[0];
			const scrollY = findScrollableParent(event.target, 'y');
			const scrollX = findScrollableParent(event.target, 'x');
			if (scrollY) {
				scrollY._touchStartY = touch.clientY;
			}
			if (scrollX) {
				scrollX._touchStartX = touch.clientX;
			}
		}, { passive: true });

		document.addEventListener('touchmove', function (event) {
			if (event.scale !== 1) {
				event.preventDefault();
				return;
			}

			const touch = event.touches[0];
			const scrollX = findScrollableParent(event.target, 'x');
			const scrollY = findScrollableParent(event.target, 'y');

			if (scrollX && event.touches.length === 1) {
				const startX = scrollX._touchStartX || touch.clientX;
				const startY = (scrollY ? scrollY._touchStartY : null) || touch.clientY;
				const deltaX = Math.abs(touch.clientX - startX);
				const deltaY = Math.abs(touch.clientY - startY);

				if (deltaX > deltaY) {
					const atLeft = scrollX.scrollLeft <= 0;
					const atRight = scrollX.scrollLeft + scrollX.clientWidth >= scrollX.scrollWidth - 1;
					const movingRight = touch.clientX - startX > 0;
					const movingLeft = touch.clientX - startX < 0;

					if ((atLeft && movingRight) || (atRight && movingLeft)) {
						event.preventDefault();
					}
					return;
				}
			}

			if (!scrollY) {
				event.preventDefault();
				return;
			}

			const atTop = scrollY.scrollTop <= 0;
			const atBottom = scrollY.scrollTop + scrollY.clientHeight >= scrollY.scrollHeight - 1;

			if (event.touches.length === 1) {
				const startY = scrollY._touchStartY || touch.clientY;
				const deltaY = touch.clientY - startY;

				if ((atTop && deltaY > 0) || (atBottom && deltaY < 0)) {
					event.preventDefault();
				}
			}
		}, { passive: false });

		let lastTouchEnd = 0;

		document.addEventListener('touchend', function (event) {
			const now = (new Date()).getTime();
			if (now - lastTouchEnd <= 300) {
				event.preventDefault();
			}
			lastTouchEnd = now;
		}, false);

		const metaViewport = document.querySelector('meta[name=viewport]');
		document.addEventListener('focus', function (event) {
			if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
				metaViewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
			}
		}, true);



		function formatBytes(bytes, decimals = 2) {
			if (bytes === 0) return '0 Bytes';
			const k = 1024;
			const dm = decimals < 0 ? 0 : decimals;
			const sizes = ['Bytes', 'KB', 'MB', 'GB'];
			const i = Math.floor(Math.log(bytes) / Math.log(k));
			return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
		}

		function getFileIcon(extension) {
			const icons = {
				'pdf': 'pdf-file-icon.svg',
				'docx': 'docx-file-icon.svg',
				'xlsx': 'excel-file-icon.svg',
				'xls': 'excel-file-icon.svg',
				'pptx': 'ppt-file-icon.svg',
				'js': 'javascript-file-icon.svg',
				'css': 'css-file-icon.svg',
				'java': 'java-file-icon.svg',
				'html': 'html-file-icon.svg',
				'xml': 'xml-file-icon.svg',
				'py': 'python-file-icon.svg',
				'sql': 'sql-file-icon.svg',
				'ts': 'typescript-file-icon.svg',
				'lua': 'lua-file-icon.svg',
				'cpp': 'cpp-file-icon.svg',
				'h': 'cpp-file-icon.svg',
				'hpp': 'cpp-file-icon.svg',
				'swift': 'swift-file-icon.svg',
				'jpg': 'image-file-icon.svg',
				'jpeg': 'image-file-icon.svg',
				'png': 'image-file-icon.svg',
				'gif': 'image-file-icon.svg',
				'webp': 'image-file-icon.svg',
				'heic': 'image-file-icon.svg',
				'heif': 'image-file-icon.svg'
			};
			const iconFile = icons[extension] || 'default-file-icon.svg';
			return `<img src="icon/${iconFile}" class="w-7 h-7 object-contain">`;
		}

		function convertToBase64(file) {
			return new Promise((resolve, reject) => {
				const reader = new FileReader();
				reader.readAsDataURL(file);
				reader.onload = () => resolve(reader.result);
				reader.onerror = error => reject(error);
			});
		}

		async function extractTextFromOffice(file) {
			const ext = file.name.split('.').pop().toLowerCase();
			try {
				if (ext === 'docx') {
					const ab = await file.rawFile.arrayBuffer();
					const res = await mammoth.extractRawText({ arrayBuffer: ab });
					return `\n[FILE WORD: ${file.name}]\n${res.value}\n`;
				}
				if (['xlsx', 'xls'].includes(ext)) {
					const ab = await file.rawFile.arrayBuffer();
					const wb = XLSX.read(ab, { type: 'array' });
					const text = wb.SheetNames.map(n => `\n-- Sheet: ${n} --\n${XLSX.utils.sheet_to_csv(wb.Sheets[n])}`).join('');
					return `\n[FILE EXCEL: ${file.name}]\n${text}\n`;
				}
				if (ext === 'pptx') {
					const zip = new JSZip();
					const content = await zip.loadAsync(file.rawFile);
					let text = `\n[FILE POWERPOINT: ${file.name}]\n`;
					const slides = Object.keys(content.files).filter(n => n.startsWith("ppt/slides/slide") && n.endsWith(".xml")).sort();
					for (const f of slides) {
						const xml = await content.files[f].async("text");
						const nodes = new DOMParser().parseFromString(xml, "text/xml").getElementsByTagName("a:t");
						text += `\n[SLIDE]\n${Array.from(nodes).map(n => n.textContent).join(" ")}\n`;
					}
					return text;
				}
			} catch (e) { return `\n[Gagal membaca ${file.name}]\n`; }
			return '';
		}

		async function readCodeFile(file) {
			try {
				const text = await file.rawFile.text();
				return `\n[ISI FILE ${file.name.toUpperCase()}]:\n${text}\n`;
			} catch (e) { return `\n[Gagal membaca isi file ${file.name}]\n`; }
		}

		function getFileCardHTML(name, size) {
			const ext = name.split('.').pop().toLowerCase();
			const visual = getFileIcon(ext);
			return `
		        <div class="bg-gray-100 rounded-2xl p-3 flex items-center gap-2 relative w-full min-h-[64px] border-none animate-in fade-in slide-in-from-bottom-1">
		            <div class="w-10 h-10 flex-none flex items-center justify-center overflow-hidden shrink-0">${visual}</div>
		            <div class="flex-1 flex flex-col justify-center min-w-0 h-10">
		                <p class="text-[12px] font-bold text-gray-700 truncate leading-none mb-1 m-0 p-0">${name}</p>
		                <p class="text-[10px] text-gray-400 font-medium leading-none m-0 p-0">${size}</p>
		            </div>
		        </div>`;
		}

		async function handleFileSelect(event) {
			const files = Array.from(event.target.files);
			if (!files.length) return;
			if (pendingFiles.length + files.length > 4) {
				showToast("Maksimal 4 file dalam satu pengiriman.", "error");
				event.target.value = '';
				return;
			}
			try {
				for (const file of files) {
					const base64 = await convertToBase64(file);
					let mimeType = file.type || '';
					const ext = file.name ? file.name.split('.').pop().toLowerCase() : '';
					if (!mimeType && ['jpg', 'jpeg', 'png', 'gif', 'webp', 'heic', 'heif'].includes(ext)) {
						mimeType = 'image/jpeg';
					}
					pendingFiles.push({
						name: file.name || "File",
						size: formatBytes(file.size),
						type: mimeType,
						base64: base64.split(',')[1],
						mime: mimeType,
						rawFile: file
					});
				}
			} catch (e) {
				console.error(e);
			} finally {
				renderPreviews();
				event.target.value = '';
			}
		}

		function renderPreviews() {
			const container = document.getElementById('file-preview-container');
			if (!container) return;
			container.innerHTML = '';
			pendingFiles.forEach((file, index) => {
				const ext = file.name ? file.name.split('.').pop().toLowerCase() : '';
				const isImage = (file.type && typeof file.type === 'string' && file.type.startsWith('image/')) ||
					['jpg', 'jpeg', 'png', 'gif', 'webp', 'heic', 'heif'].includes(ext);
				const visual = isImage
					? `<img src="data:${file.mime || 'image/jpeg'};base64,${file.base64}" class="w-full h-full object-cover rounded-lg">`
					: getFileIcon(ext);
				const card = document.createElement('div');
				card.className = "bg-gray-100 rounded-2xl p-3 flex items-center gap-2 relative w-full min-h-[64px] border-none";
				card.innerHTML = `
		            <div class="w-10 h-10 flex-none flex items-center justify-center overflow-hidden shrink-0">${visual}</div>
		            <div class="flex-1 flex flex-col justify-center min-w-0 h-10">
		                <p class="text-[12px] font-bold text-gray-700 truncate leading-none mb-1 m-0 p-0">${file.name}</p>
		                <p class="text-[10px] text-gray-400 font-medium leading-none m-0 p-0">${file.size}</p>
		            </div>
		            <button onclick="removeFile(${index})" class="absolute -top-3 -right-3 w-7 h-7 flex items-center justify-center border-none p-0 cursor-pointer outline-none bg-transparent">
		                <svg fill="#d1d5db" viewBox="0 0 24 24" class="w-full h-full"><path d="M12 4c-4.419 0-8 3.582-8 8s3.581 8 8 8 8-3.582 8-8-3.581-8-8-8zm3.707 10.293c.391.391.391 1.023 0 1.414-.195.195-.451.293-.707.293s-.512-.098-.707-.293l-2.293-2.293-2.293 2.293c-.195.195-.451.293-.707.293s-.512-.098-.707-.293c-.391-.391-.391-1.023 0-1.414l2.293-2.293-2.293-2.293c-.391-.391-.391-1.023 0-1.414s1.023-.391 1.414 0l2.293 2.293 2.293-2.293c.391-.391 1.023-.391 1.414 0s.391 1.023 0 1.414l-2.293 2.293 2.293 2.293z"></path></svg>
		            </button>`;
				container.appendChild(card);
			});
		}

		function removeFile(index) {
			pendingFiles.splice(index, 1);
			renderPreviews();
		}

		function stopGeneration() {
			if (abortController) {
				abortController.abort();
				abortController = null;
			}

			if (typingInterval) {
				clearInterval(typingInterval);
				typingInterval = null;
			}

			setGeneratingState(false);

			const stopLabel = " <span class='text-red-500 italic'>Respon dihentikan.</span>";

			if (currentLoadingMsgId) {
				const el = document.getElementById(currentLoadingMsgId);
				if (el) {
					if (el.innerHTML.includes('Thinking')) {
						el.parentElement.parentElement.remove();
						currentStreamedText = "";
					} else {
						el.innerHTML += stopLabel;
						currentStreamedText += stopLabel;
					}
				}
			}

			if (typeWriterResolve) {
				typeWriterResolve(currentStreamedText);
				typeWriterResolve = null;
			}

			currentLoadingMsgId = null;
		}

		async function sendMessage(e) {
			if (e) e.preventDefault();

			if (isGenerating) {
				stopGeneration();
				return;
			}

			const input = document.getElementById('userInput');
			const rawInput = input.value.trim();

			if (!rawInput && pendingFiles.length === 0) return;
			input.blur();

			abortController = new AbortController();

			const currentTemp = parseFloat(document.getElementById('settings-temp').value) || 1.0;
			const currentMaxTokens = parseInt(document.getElementById('settings-tokens').value) || 8192;
			const sliderVal = document.getElementById('settings-thinking').value;
			const currentBudget = thinkingMap[sliderVal] || 16000;
			// const useGoogleSearch = ... (dipindah ke bawah, baca dari localStorage)

			let customSystemPrompt = document.getElementById('systemPromptInput').value || SYSTEM_PROMPT;

			input.value = '';
			input.style.height = 'auto';
			inputWrapper.classList.add('rounded-[28px]');
			inputWrapper.classList.remove('rounded-[22px]');

			setGeneratingState(true);

			let fileCardsHTML = "";
			const filesToProcess = [...pendingFiles];
			filesToProcess.forEach(f => {
				fileCardsHTML += getFileCardHTML(f.name, f.size);
			});

			appendMsg('user', rawInput, null, fileCardsHTML);

			currentLoadingMsgId = appendTypingBubble();
			currentStreamedText = "";

			let textContext = "";

			let apiParts = [];
			pendingFiles = [];
			renderPreviews();

			for (const f of filesToProcess) {
				if (f.mime.startsWith('image/') || f.mime === 'application/pdf') {
					apiParts.push({ inline_data: { mime_type: f.mime, data: f.base64 } });
				} else {
					const ext = f.name.split('.').pop().toLowerCase();
					textContext += await (['docx', 'xlsx', 'xls', 'pptx'].includes(ext) ? extractTextFromOffice(f) : readCodeFile(f));
				}
			}

			try {
				const { data: { session } } = await _supabase.auth.getSession();
				const userToken = session.access_token;

				const userMessage = textContext
					? `[FILE LAMPIRAN]\n${textContext}\n\nPERTANYAAN USER:\n${rawInput}`
					: rawInput;

				// RAG: Cari knowledge base jika aktif DAN relevan dengan SI-AWAS
				let finalMessage = userMessage;

				// --- UPDATED LOGIC: Baca dari Profile User (BUKAN DOM GLOBAL) ---
				// Kita asumsikan localStorage 'awas_settings_kb' diupdate saat load profil
				const useKB = (localStorage.getItem('awas_settings_kb') === 'true');
				const useGoogleSearch = (localStorage.getItem('awas_settings_google') === 'true');

				// TRIGGER WORDS: Hanya cari di KB jika ada kata kunci ini
				const kbKeywords = [
					// Identitas
					'si awas', 'siawas', 'aplikasi', 'sistem', 'web', 'inspektorat', 'lampung',
					// Role
					'admin', 'administrator', 'ketua', 'anggota', 'tim', 'dalnis', 'opd', 'operator', 'evalap', 'user', 'pengguna',
					// Dokumen & Audit
					'lhp', 'nhp', 'pka', 'kk', 'kertas kerja', 'dokumen', 'file', 'pdf', 'laporan', 'sk', 'spt',
					'audit', 'pemeriksaan', 'pengawasan', 'monev', 'temuan', 'sanggah', 'rekomendasi', 'saran', 'tindak lanjut', 'tl',
					// Program & Kegiatan
					'pkpt', 'program kerja', 'proker', 'rencana', 'jadwal', 'tahun', 'anggaran', 'kegiatan',
					// Fitur & Teknis
					'login', 'password', 'sandi', 'akun', 'reset', 'menu', 'tombol', 'ikon', 'icon', 'klik', 'simpan', 'edit', 'ubah', 'tambah', 'hapus', 'upload', 'unggah', 'download', 'bukti', 'evidence', 'feedback', 'jawab', 'validasi', 'verifikasi', 'setujui', 'tolak'
				];

				const lowerInput = rawInput.toLowerCase();
				const isRelevant = kbKeywords.some(keyword => lowerInput.includes(keyword));

				if (useKB && rawInput && isRelevant) {
					try {
						const kbContext = await searchKnowledgeBase(rawInput);
						if (kbContext) {
							finalMessage = `${userMessage}\n\n---\n[INFORMASI DARI KNOWLEDGE BASE SI-AWAS]\nGunakan informasi berikut HANYA jika relevan dengan pertanyaan user:\n${kbContext}\n---\n`;
						}
					} catch (kbErr) {
						console.warn('KB search failed:', kbErr);
					}
				} else if (useKB && rawInput && !isRelevant) {
					console.log('KB Search skipped: Tidak ada kata kunci SI-AWAS yang relevan.');
				}

				const payload = {
					system_instruction: { parts: [{ text: customSystemPrompt }] },
					contents: [
						...chatHistory,
						{ role: "user", parts: [...apiParts, { text: finalMessage }] }
					],
					generationConfig: {
						temperature: currentTemp,
						maxOutputTokens: currentMaxTokens
					}
				};

				// --- GOOGLE SEARCH RATE LIMITING LOGIC ---
				// Gemini 2.5: Limit 1500 search queries per DAY
				// Gemini 3.0: Limit 5000 search queries per MONTH

				let enableGoogleSearch = useGoogleSearch;
				const todayStr = new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD
				const currentMonthStr = todayStr.substring(0, 7); // YYYY-MM

				if (useGoogleSearch) {
					// --- GLOBAL RATE LIMITING VIA SUPABASE ---
					// Menggunakan RPC agar penghhitungan terpusat di server (Global Limit untuk semua user)
					try {
						let limitCategory = '';
						let periodKey = '';
						let maxLimit = 0;

						if (currentSelectedModel.includes('2.5')) {
							limitCategory = 'google_search_2.5';
							periodKey = todayStr; // Harian: YYYY-MM-DD
							maxLimit = 1500;
						} else if (currentSelectedModel.includes('gemini-3')) {
							limitCategory = 'google_search_3.0';
							periodKey = currentMonthStr; // Bulanan: YYYY-MM
							maxLimit = 5000;
						}

						if (limitCategory) {
							// Panggil Stored Function di Supabase
							const { data: isAllowed, error: limitError } = await _supabase
								.rpc('check_and_increment_limit', {
									p_category: limitCategory,
									p_period_key: periodKey,
									p_max_limit: maxLimit
								});

							if (limitError) {
								console.error("[LIMIT CHECK ERROR]", limitError);
								// Fallback: Jika server limit error, tetap izinkan (fail-open) atau blokir (fail-closed)?
								// Disini kita pilih safe-mode: jika error, anggap boleh dulu agar UX tidak rusak, tapi log warning.
								enableGoogleSearch = true;
							} else {
								// isAllowed returns true (masih dalam batas) or false (sudah lewat)
								if (isAllowed === false) {
									enableGoogleSearch = false;
									showToast(`Batas Global ${limitCategory.includes('2.5') ? 'Harian (1500)' : 'Bulanan (5000)'} tercapai. Search dinonaktifkan.`, 'error');
								} else {
									enableGoogleSearch = true;
								}
							}
						}
					} catch (e) {
						console.error("Error checking global limit:", e);
						// Fail-open agar user tetap bisa pakai jika koneksi limit bermasalah sesaat
						enableGoogleSearch = true;
					}
				}

				if (enableGoogleSearch) payload.tools = [{ google_search: {} }];

				if (enableGoogleSearch) payload.tools = [{ google_search: {} }];

				// askingConfig logic based on model version
				// Gemini 3.0 uses thinkingLevel (LOW, HIGH)
				// Gemini 2.5 uses thinkingBudget (token count)
				if (currentSelectedModel.includes('gemini-3')) {
					// Gemini 3 strictly uses thinkingLevel
					const thinkingLevelMap = { "1": "LOW", "2": "MEDIUM", "3": "HIGH" }; // MEDIUM supported on Flash, Pro will fallback or handle
					payload.generationConfig.thinkingConfig = {
						thinkingLevel: thinkingLevelMap[sliderVal] || "HIGH",
						includeThoughts: false // Set to true if you want to receive the thinking process text
					};
				} else if (currentSelectedModel.includes('2.5')) {
					// Gemini 2.5 uses thinkingBudget
					// Validation: Flash max ~24k, Pro max ~32k
					let budget = currentBudget;
					if (currentSelectedModel.includes('flash') && budget > 24576) {
						budget = 24576; // Cap for Flash
					}

					payload.generationConfig.thinkingConfig = {
						thinkingBudget: budget,
						includeThoughts: false
					};
				}

				// === TRUE STREAMING: gunakan streamGenerateContent ===
				const res = await fetch(`${PROXY_URL}?model=${currentSelectedModel}&action=streamGenerateContent&alt=sse`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${userToken}`,
						'apikey': SUPABASE_KEY
					},
					body: JSON.stringify(payload),
					signal: abortController.signal
				});

				if (!res.ok) {
					const errData = await res.json().catch(() => ({}));
					throw new Error(errData.error?.message || `HTTP ${res.status}`);
				}

				// Baca stream secara real-time
				const reader = res.body.getReader();
				const decoder = new TextDecoder();
				let fullText = "";
				let buffer = "";
				let isFirstChunk = true;
				const element = document.getElementById(currentLoadingMsgId);
				let lastRenderTime = 0;
				const RENDER_INTERVAL = 50; // Render setiap 50ms untuk performa optimal

				while (true) {
					const { done, value } = await reader.read();
					if (done) break;

					buffer += decoder.decode(value, { stream: true });

					// Parse SSE lines
					const lines = buffer.split('\n');
					buffer = lines.pop() || ""; // Simpan baris terakhir yang belum lengkap

					for (const line of lines) {
						const trimmed = line.trim();
						if (!trimmed || !trimmed.startsWith('data: ')) continue;

						const jsonStr = trimmed.slice(6); // Hapus prefix "data: "
						if (jsonStr === '[DONE]') continue;

						try {
							const chunk = JSON.parse(jsonStr);
							const parts = chunk.candidates?.[0]?.content?.parts || [];
							const textParts = parts.filter(p => p.text).map(p => p.text).join('');

							if (textParts) {
								if (isFirstChunk && element) {
									element.innerHTML = ''; // Hapus "Thinking..." saat chunk pertama tiba
									isFirstChunk = false;
								}
								fullText += textParts;
								currentStreamedText = fullText;

								// Throttle rendering untuk performa optimal
								const now = performance.now();
								if (now - lastRenderTime >= RENDER_INTERVAL) {
									if (element) {
										element.innerHTML = marked.parse(fullText);
										const container = document.getElementById('chatContainer');
										container.scrollTop = container.scrollHeight;
									}
									lastRenderTime = now;
								}
							}
						} catch (parseErr) {
							// Skip invalid JSON chunks (bisa terjadi di boundary)
						}
					}
				}

				// Render final setelah stream selesai
				if (element && fullText) {
					element.innerHTML = marked.parse(fullText);
					// Highlight code blocks
					element.querySelectorAll('pre code').forEach(block => {
						hljs.highlightElement(block);
					});
					const container = document.getElementById('chatContainer');
					container.scrollTop = container.scrollHeight;
				}

				if (fullText.length > 0) {
					chatHistory.push(
						{ role: "user", parts: [{ text: rawInput }] },
						{ role: "model", parts: [{ text: fullText }] }
					);
					await saveMsg(session.user.id, rawInput, fullText, fileCardsHTML);
				}

			} catch (err) {
				if (err.name === 'AbortError') {
					return;
				}
				console.error(err);
				const el = document.getElementById(currentLoadingMsgId);
				if (el) el.innerHTML = "Terjadi kesalahan koneksi atau limit API.";
			} finally {
				if (abortController && !abortController.signal.aborted) {
					setGeneratingState(false);
					currentLoadingMsgId = null;
				}
				abortController = null;
				typeWriterResolve = null;
			}
		}

		function appendMsg(role, text, timestamp, fileCardsHTML = "") {
			const area = document.getElementById('messagesArea');
			const isUser = role === 'user';
			const div = document.createElement('div');
			div.className = "w-full animate-in fade-in slide-in-from-bottom-2 duration-300 mb-2";

			const timeStr = timestamp
				? new Date(timestamp).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })
				: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

			const label = isUser ? 'ANDA' : `<div class="w-5 h-5 bg-gradient-to-r from-blue-600 to-cyan-400" style="-webkit-mask: url('icon/icon.png') no-repeat center; mask: url('icon/icon.png') no-repeat center; -webkit-mask-size: contain; mask-size: contain;"></div>`;

			div.innerHTML = `
		        <div class="w-full bg-slate-50 rounded-2xl p-4 shadow-sm group relative">
		            <div class="flex justify-between items-center border-b border-slate-100 pb-1 mb-1">
		                <span class="text-xs font-black uppercase tracking-widest ${isUser ? 'text-slate-600' : 'text-blue-600'}">${label}</span>
		                <span class="text-xs font-medium text-slate-400">${timeStr}</span>
		            </div>
		            <div class="prose max-w-none text-slate-600 text-[15px] font-medium">${marked.parse(text)}</div>
		            <div class="user-file-cards grid grid-cols-2 md:grid-cols-4 gap-2 empty:hidden mt-3">${fileCardsHTML}</div>
		        </div>`;
			area.appendChild(div);
		}

		function appendTypingBubble() {
			const area = document.getElementById('messagesArea');
			const msgId = `msg-${Date.now()}`;
			const timeStr = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
			const div = document.createElement('div');
			div.className = "w-full animate-in fade-in slide-in-from-bottom-2 duration-300 mb-2";
			div.innerHTML = `
		        <div class="w-full bg-slate-50 rounded-2xl p-4 shadow-sm group relative">
		            <div class="flex justify-between items-center border-b border-slate-100 pb-1 mb-1">
		                <span class="text-xs font-black uppercase tracking-widest">
		                    <div class="w-5 h-5 bg-gradient-to-r from-blue-600 to-cyan-400" style="-webkit-mask: url('icon/icon.png') no-repeat center; mask: url('icon/icon.png') no-repeat center; -webkit-mask-size: contain; mask-size: contain;"></div>
		                </span>
		                <span class="text-xs font-medium text-slate-400">${timeStr}</span>
		            </div>
		            <div id="${msgId}" class="prose max-w-none text-slate-600 text-[15px] font-medium min-h-[24px]">
		                <div class="flex items-baseline gap-1 text-[14px] text-slate-400">
		                    Thinking
		                    <div class="flex gap-1 translate-y-[1px]">
		                        <div class="typing-dot"></div>
		                        <div class="typing-dot"></div>
		                        <div class="typing-dot"></div>
		                    </div>
		                </div>
		            </div>
		        </div>`;
			area.appendChild(div);

			const container = document.getElementById('chatContainer');
			container.scrollTop = container.scrollHeight;
			return msgId;
		}

		async function saveMsg(uid, uText, aText, fileCardsHTML = "") {
			const payload = { id: currentSessionId, user_id: uid, timestamp: Date.now() };
			if (chatHistory.length <= 2) {
				let cleanTitle = aText.split('\n')[0].replace(/[*#_`]/g, '').trim();
				if (cleanTitle.length > 45) cleanTitle = cleanTitle.substring(0, 45).trim() + '...';
				payload.title = cleanTitle;
			}

			const finalUserText = fileCardsHTML ? uText + FILE_CARD_SEPARATOR + fileCardsHTML : uText;

			const { data: s } = await _supabase.from('chat_sessions').upsert(payload).select().single();
			await _supabase.from('chat_messages').insert([{ session_id: currentSessionId, role: 'user', content: finalUserText, timestamp: Date.now() }, { session_id: currentSessionId, role: 'model', content: aText, timestamp: Date.now() }]);
			loadHistory();
		}


		function saveToLocal(key, data) {
			try { localStorage.setItem(key, JSON.stringify(data)); } catch (e) { console.warn('LocalStorage full/error', e); }
		}

		function getFromLocal(key) {
			try { return JSON.parse(localStorage.getItem(key)); } catch (e) { return null; }
		}

		async function loadHistory() {
			const { data: { session } } = await _supabase.auth.getSession();
			if (!session) return;

			let sessions = [];
			const { data, error } = await _supabase.from('chat_sessions').select('*').eq('user_id', session.user.id).order('timestamp', { ascending: false });

			if (!error && data) {
				sessions = data;
				saveToLocal('offline_sessions_' + session.user.id, sessions);
			} else {
				console.warn('Offline/Error loading sessions, using cache:', error);
				sessions = getFromLocal('offline_sessions_' + session.user.id) || [];
			}

			const list = document.getElementById('historyList');
			list.innerHTML = '';
			const tmpl = document.getElementById('historyItemTemplate');

			// DATE GROUPING LOGIC
			let lastLabel = "";
			const now = new Date();
			const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
			const startOfYesterday = startOfToday - 86400000;
			const startOfLast7Days = startOfToday - (86400000 * 7);
			const startOfLast30Days = startOfToday - (86400000 * 30);

			const getLabel = (ts) => {
				if (!ts) return "Lebih Lama";
				if (ts >= startOfToday) return "Hari Ini";
				if (ts >= startOfYesterday) return "Kemarin";
				if (ts >= startOfLast7Days) return "7 Hari Terakhir";
				if (ts >= startOfLast30Days) return "30 Hari Terakhir";
				return "Lebih Lama";
			};

			sessions?.forEach(s => {
				const currentLabel = getLabel(s.timestamp);

				if (currentLabel !== lastLabel) {
					const header = document.createElement('div');
					header.className = "text-[10px] font-black text-slate-400 mt-5 mb-2 px-4 uppercase tracking-widest";
					header.innerText = currentLabel;
					list.appendChild(header);
					lastLabel = currentLabel;
				}

				const isActive = s.id === currentSessionId;
				const clone = tmpl.content.cloneNode(true);

				// Root Container
				const root = clone.querySelector('.history-item-root');
				if (isActive) {
					root.classList.remove('hover:bg-slate-50');
					root.classList.add('bg-blue-50/80');
				}

				// Title Button
				const titleBtn = clone.querySelector('.history-title-btn');
				titleBtn.innerText = s.title || "Percakapan Baru";
				if (isActive) {
					titleBtn.classList.remove('text-slate-600', 'font-medium');
					titleBtn.classList.add('text-blue-600', 'font-bold');
				}
				titleBtn.onclick = () => loadSession(s.id);

				// Menu Button
				const menuBtn = clone.querySelector('.history-menu-btn');
				if (isActive) {
					menuBtn.classList.remove('opacity-0');
					menuBtn.classList.add('opacity-100');
				}

				// Dropdown Logic
				const dropdown = clone.querySelector('.history-dropdown');
				const dropdownId = `menu-dropout-${s.id}`;
				dropdown.id = dropdownId;

				menuBtn.onclick = (e) => {
					e.stopPropagation();
					document.querySelectorAll('[id^="menu-dropout-"]').forEach(el => {
						if (el.id !== dropdownId) el.classList.add('hidden');
					});
					dropdown.classList.toggle('hidden');
				};

				// Rename & Delete Actions
				const renameBtn = clone.querySelector('.history-rename-btn');
				renameBtn.onclick = () => handleRenameClick(s.id, (s.title || "").replace(/'/g, "\\'"));

				const deleteBtn = clone.querySelector('.history-delete-btn');
				deleteBtn.onclick = () => handleDeleteClick(s.id);

				list.appendChild(clone);
			});

			lucide.createIcons();

			// Global listener to close dropdowns
			document.addEventListener('click', (e) => {
				if (!e.target.closest('[id^="menu-dropout-"]') && !e.target.closest('button')) {
					document.querySelectorAll('[id^="menu-dropout-"]').forEach(el => el.classList.add('hidden'));
				}
			});
		}

		// handleRenameClick dipindahkan ke bagian bawah file (menggunakan Modal)

		async function handleDeleteClick(id) {
			await _supabase.from('chat_messages').delete().eq('session_id', id);
			await _supabase.from('chat_sessions').delete().eq('id', id);

			// Clean from cache too
			const items = getFromLocal('offline_sessions_' + currentSessionId); // Wait, need user id here, but simpler to just reload
			localStorage.removeItem('offline_chat_' + id);

			if (currentSessionId === id) {
				currentSessionId = null;
				document.getElementById('messagesArea').innerHTML = '';
				chatHistory = [];
			}
			loadHistory();
		}

		async function loadSession(id, isInitialLoad = false) {
			currentSessionId = id;
			let msgs = [];
			const { data, error } = await _supabase.from('chat_messages').select('*').eq('session_id', id).order('timestamp', { ascending: true });

			if (!error && data) {
				msgs = data;
				saveToLocal('offline_chat_' + id, msgs);
			} else {
				console.warn('Offline/Error loading chat, using cache:', error);
				msgs = getFromLocal('offline_chat_' + id) || [];
			}

			document.getElementById('messagesArea').innerHTML = '';
			chatHistory = msgs.map(m => {
				let text = m.content;
				if (m.content.includes(FILE_CARD_SEPARATOR)) {
					text = m.content.split(FILE_CARD_SEPARATOR)[0];
				}
				return { role: m.role, parts: [{ text: text }] };
			});

			msgs.forEach(m => {
				let content = m.content;
				let fileCards = "";
				if (content.includes(FILE_CARD_SEPARATOR)) {
					const parts = content.split(FILE_CARD_SEPARATOR);
					content = parts[0];
					fileCards = parts[1];
				}
				appendMsg(m.role, content, m.timestamp, fileCards);
			});

			// Re-apply Highlight.js after rendering history
			hljs.highlightAll();

			loadHistory();

			if (!isInitialLoad) {
				const sidebar = document.getElementById('mainSidebar');
				if (sidebar && !sidebar.classList.contains('-translate-x-full')) {
					toggleSidebar(false);
				}
			}
		}

		// typeWriter tidak diperlukan lagi  streaming langsung menampilkan teks real-time
		function typeWriter(elementId, text) {
			return new Promise(resolve => {
				const element = document.getElementById(elementId);
				if (!element) { resolve(""); return; }
				element.innerHTML = marked.parse(text);
				element.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
				currentStreamedText = text;
				const container = document.getElementById('chatContainer');
				container.scrollTop = container.scrollHeight;
				resolve(text);
			});
		}

		function setGeneratingState(s) {
			isGenerating = s;
			const sendBtn = document.getElementById('sendBtn');
			const userInput = document.getElementById('userInput');
			const uploadBtn = document.getElementById('uploadBtn');

			userInput.disabled = s;
			uploadBtn.disabled = s;

			if (s) {
				sendBtn.innerHTML = '<i data-lucide="square" class="w-4 h-4 text-red-500 fill-current"></i>';
				userInput.style.cursor = 'not-allowed';
				uploadBtn.style.cursor = 'not-allowed';
			} else {
				sendBtn.innerHTML = '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 translate-x-0.5" fill="currentColor"><path d="M21.66,12a2,2,0,0,1-1.14,1.81L5.87,20.75A2.08,2.08,0,0,1,5,21a2,2,0,0,1-1.82-2.82L5.46,13H11a1,1,0,0,0,0-2H5.46L3.18,5.87A2,2,0,0,1,5.86,3.25h0l14.65,6.94A2,2,0,0,1,21.66,12Z"></path></svg>';
				userInput.style.cursor = 'auto';
				uploadBtn.style.cursor = 'pointer';
				setTimeout(() => userInput.focus(), 100);
			}
			lucide.createIcons();
		}

		function toggleSidebar(s) {
			const sb = document.getElementById('mainSidebar');
			const ov = document.getElementById('sidebarOverlay');
			if (s) {
				sb.classList.remove('-translate-x-full');
				ov.classList.remove('hidden');
				setTimeout(() => ov.classList.remove('opacity-0'), 10);
			} else {
				sb.classList.add('-translate-x-full');
				ov.classList.add('opacity-0');
				setTimeout(() => ov.classList.add('hidden'), 300);
			}
		}

		document.getElementById('menuBtn').onclick = () => toggleSidebar(true);

		const overlay = document.getElementById('sidebarOverlay');
		overlay.addEventListener('pointerdown', function (e) {
			e.preventDefault();
			toggleSidebar(false);
		});

		document.getElementById('settingsBtn').onclick = () => {
			document.getElementById('adminScreen').classList.replace('hidden', 'flex');
			fetchUsers();
		};

		document.getElementById('backFromAdmin').onclick = () => {
			document.getElementById('adminScreen').classList.replace('flex', 'hidden');
		};

		document.getElementById('newChatSidebarBtn').onclick = () => {
			currentSessionId = Date.now().toString();
			document.getElementById('messagesArea').innerHTML = '';
			chatHistory = [];
			toggleSidebar(false);
		};

		document.getElementById('sidebarLogoutBtn').onclick = () => {
			localStorage.removeItem('awas_settings_google');
			localStorage.removeItem('awas_settings_kb');
			localStorage.removeItem('awas_allow_upload');
			_supabase.auth.signOut().then(() => location.reload());
		};

		document.getElementById('loginForm').onsubmit = async (e) => {
			e.preventDefault();
			const loginBtn = document.getElementById('loginBtn');
			const loginBtnText = document.getElementById('loginBtnText');
			const loginError = document.getElementById('loginError');

			loginBtn.disabled = true;
			loginBtnText.innerHTML = '<div class="btn-spinner"></div>';
			loginError.classList.add('hidden');
			loginError.innerText = '';

			const { error } = await _supabase.auth.signInWithPassword({ email: emailInput.value, password: passwordInput.value });

			if (error) {
				loginBtnText.innerText = 'Masuk';
				loginBtn.disabled = false;
				loginError.innerText = 'Login Gagal';
				loginError.classList.remove('hidden');
			} else {
				location.reload();
			}
		};

		// =============================================
		// KNOWLEDGE BASE RAG FUNCTIONS
		// =============================================
		const KB_CHUNK_SIZE = 2000; // Chunk size bisa lebih besar karena satu bagian bisa panjang

		function splitTextIntoChunks(text, maxChunkSize = KB_CHUNK_SIZE) {
			// Strategi Baru: Chunking Per Bagian (Delimiter Based)
			// Memisahkan konten berdasarkan pemisah "-----"

			const cleanText = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

			// Pecah berdasarkan delimiter "-----"
			// Menggunakan regex agar fleksibel terhadap jumlah strip (min 3)
			const rawChunks = cleanText.split(/\n-+\n/);

			const chunks = [];

			for (const raw of rawChunks) {
				const trimmedChunk = raw.trim();

				// Abaikan chunk kosong
				if (trimmedChunk.length < 10) continue;

				// Jika chunk sangat panjang (lebih dari maxChunkSize),
				// Baru kita pecah lagi per paragraf agar embedding muat
				if (trimmedChunk.length > maxChunkSize) {
					const smallerParts = trimmedChunk.split(/\n\s*\n/);
					let currentPart = "";

					for (const part of smallerParts) {
						if ((currentPart + part).length > maxChunkSize) {
							if (currentPart.trim()) chunks.push(currentPart.trim());
							currentPart = part;
						} else {
							currentPart += "\n\n" + part;
						}
					}
					if (currentPart.trim()) chunks.push(currentPart.trim());
				} else {
					chunks.push(trimmedChunk);
				}
			}

			return chunks;
		}

		async function embedText(text) {
			const { data: { session } } = await _supabase.auth.getSession();
			if (!session) throw new Error('Sesi habis');

			const res = await fetch(`${PROXY_URL}?model=gemini-embedding-001&action=embedContent`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'Authorization': `Bearer ${session.access_token}`,
					'apikey': SUPABASE_KEY
				},
				body: JSON.stringify({
					content: { parts: [{ text }] },
					outputDimensionality: 768
				})
			});

			const responseText = await res.text();
			let data;
			try {
				data = JSON.parse(responseText);
			} catch (e) {
				throw new Error('Response embedding bukan JSON valid');
			}

			if (!res.ok) {
				throw new Error(data.error?.message || `Embedding gagal: HTTP ${res.status}`);
			}

			const values = data.embedding?.values;
			if (!values || !Array.isArray(values) || values.length === 0) {
				throw new Error('Response embedding tidak mengandung values');
			}

			return values;
		}

		async function uploadKnowledgeBase(event) {
			const file = event.target.files[0];
			if (!file) return;

			if (!file.name.endsWith('.txt')) {
				showToast('Hanya file .txt yang diperbolehkan', 'error');
				event.target.value = '';
				return;
			}

			const progressDiv = document.getElementById('kb-upload-progress');
			const progressText = document.getElementById('kb-progress-text');
			const progressBar = document.getElementById('kb-progress-bar');

			progressDiv.classList.remove('hidden');
			progressText.textContent = 'Membaca file...';
			progressBar.style.width = '5%';

			try {
				const text = await file.text();

				if (text.trim().length < 50) {
					throw new Error('File terlalu pendek (minimal 50 karakter)');
				}

				// Split teks menjadi chunks
				const chunks = splitTextIntoChunks(text);


				// Test embedding dengan chunk pertama dulu
				progressText.textContent = 'Menguji koneksi embedding...';
				progressBar.style.width = '8%';

				let testEmbedding;
				try {
					testEmbedding = await embedText(chunks[0]);
				} catch (testErr) {
					throw new Error(`Embedding test gagal: ${testErr.message}`);
				}

				if (!testEmbedding) {
					throw new Error('Embedding test mengembalikan null');
				}

				// Simpan dokumen
				progressText.textContent = 'Menyimpan dokumen...';
				progressBar.style.width = '10%';

				const { data: doc, error: docErr } = await _supabase
					.from('kb_documents')
					.insert({
						filename: file.name,
						content: text,
						chunk_count: chunks.length
					})
					.select()
					.single();

				if (docErr) throw new Error('Gagal simpan dokumen: ' + docErr.message);

				// Simpan chunk pertama yang sudah diembed
				let successCount = 0;
				let failCount = 0;

				const { error: firstChunkErr } = await _supabase.from('kb_chunks').insert({
					document_id: doc.id,
					chunk_text: chunks[0],
					chunk_index: 0,
					embedding: JSON.stringify(testEmbedding) // Kirim sebagai string format pgvector
				});

				if (firstChunkErr) {
					console.error('Insert chunk pertama gagal:', firstChunkErr);
					// Coba tanpa stringify
					const { error: retryErr } = await _supabase.from('kb_chunks').insert({
						document_id: doc.id,
						chunk_text: chunks[0],
						chunk_index: 0,
						embedding: testEmbedding // Kirim sebagai array langsung
					});
					if (retryErr) {
						throw new Error('Gagal simpan chunk ke database: ' + retryErr.message);
					}
				}
				successCount++;

				// Embed sisa chunks
				for (let i = 1; i < chunks.length; i++) {
					progressText.textContent = `Embedding ${i + 1}/${chunks.length}...`;
					progressBar.style.width = `${10 + (i / chunks.length) * 85}%`;

					try {
						const embedding = await embedText(chunks[i]);
						if (!embedding) {
							failCount++;
							continue;
						}

						const { error: chunkErr } = await _supabase.from('kb_chunks').insert({
							document_id: doc.id,
							chunk_text: chunks[i],
							chunk_index: i,
							embedding: embedding
						});

						if (chunkErr) {
							console.error(`Chunk ${i} insert gagal:`, chunkErr);
							failCount++;
						} else {
							successCount++;
						}
					} catch (embedErr) {
						console.error(`Chunk ${i} embedding gagal:`, embedErr.message);
						failCount++;
					}

					// Delay agar tidak kena rate limit
					if (i < chunks.length - 1) {
						await new Promise(r => setTimeout(r, 250));
					}
				}

				progressBar.style.width = '100%';

				if (successCount === 0) {
					// Hapus dokumen jika semua chunk gagal
					await _supabase.from('kb_documents').delete().eq('id', doc.id);
					throw new Error('Semua chunk gagal diproses!');
				}

				if (failCount > 0) {
					progressText.textContent = `Selesai (${successCount} OK, ${failCount} gagal)`;
					showToast(`"${file.name}": ${successCount}/${chunks.length} chunks berhasil`, 'success');
				} else {
					progressText.textContent = 'Selesai!';
					showToast(`"${file.name}" berhasil diupload! (${chunks.length} chunks)`, 'success');
				}

				loadKBDocuments();

				setTimeout(() => {
					progressDiv.classList.add('hidden');
					progressBar.style.width = '0%';
				}, 3000);

			} catch (e) {
				console.error('KB upload error:', e);
				showToast('Gagal: ' + e.message, 'error');
				progressDiv.classList.add('hidden');
				progressBar.style.width = '0%';
			} finally {
				event.target.value = '';
			}
		}

		async function loadKBDocuments() {
			const container = document.getElementById('kb-doc-list');
			if (!container) return;

			try {
				const { data: docs, error } = await _supabase
					.from('kb_documents')
					.select('*')
					.order('created_at', { ascending: false });

				if (error) throw error;

				container.innerHTML = '';
				if (!docs || docs.length === 0) {
					container.innerHTML = '<p class="text-xs text-slate-400 text-center py-2 font-medium">Belum ada dokumen knowledge base.</p>';
					return;
				}

				docs.forEach(doc => {
					const div = document.createElement('div');
					div.className = 'flex items-center justify-between bg-white p-3 rounded-xl border border-slate-100';
					div.innerHTML = `
						<div class="flex items-center gap-3 min-w-0 flex-1">
							<div class="w-8 h-8 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-600 shrink-0">
								<i data-lucide="file-text" class="w-4 h-4"></i>
							</div>
							<div class="min-w-0 flex-1">
								<p class="text-sm font-bold text-slate-700 truncate">${doc.filename}</p>
								<p class="text-[10px] font-medium text-slate-400">${doc.chunk_count || 0} chunks  ${new Date(doc.created_at).toLocaleDateString('id-ID')}</p>
							</div>
						</div>
						<button onclick="openUserActionModal('deleteKB', '${doc.id}')" class="p-2 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 transition-colors shrink-0 ml-2">
							<i data-lucide="trash-2" class="w-4 h-4"></i>
						</button>`;
					container.appendChild(div);
				});
				lucide.createIcons();
			} catch (e) {
				console.error('Load KB docs error:', e);
				container.innerHTML = '<p class="text-xs text-red-400 text-center py-2 font-medium">Gagal memuat dokumen.</p>';
			}
		}



		async function searchKnowledgeBase(query) {
			try {
				const embedding = await embedText(query);
				if (!embedding) return '';

				const { data: chunks, error } = await _supabase
					.rpc('match_kb_chunks', {
						query_embedding: embedding,
						match_threshold: 0.55,
						match_count: 5
					});

				if (error) {
					console.error('KB RPC error:', error);
					return '';
				}

				if (!chunks || chunks.length === 0) {
					console.log('%c KB Search: Tidak ada chunk yang relevan ditemukan', 'color: #f59e0b; font-weight: bold');
					return '';
				}

				// Log detail ke console
				console.group('%c Knowledge Base Search Results', 'color: #10b981; font-weight: bold; font-size: 13px');
				console.log(`Query: "${query}"`);
				console.log(`Chunks ditemukan: ${chunks.length}`);
				console.table(chunks.map((c, i) => ({
					'#': i + 1,
					'Relevansi': (c.similarity * 100).toFixed(1) + '%',
					'Panjang': c.chunk_text.length + ' chars',
					'Preview': c.chunk_text.substring(0, 80) + '...'
				})));

				const totalChars = chunks.reduce((sum, c) => sum + c.chunk_text.length, 0);
				console.log(`Total konteks: ${totalChars} karakter (~${Math.ceil(totalChars / 4)} tokens)`);
				console.groupEnd();

				// Gabungkan chunks tanpa label referensi agar AI menjawab natural
				return chunks
					.map(c => c.chunk_text)
					.join('\n\n');
			} catch (e) {
				console.error('KB search error:', e);
				return '';
			}
		}

		async function init() {
			lucide.createIcons();
			const cachedUpload = localStorage.getItem('awas_allow_upload');
			if (cachedUpload !== null) {
				applyUploadUIState(cachedUpload === 'true');
			}

			const { data: { session } } = await _supabase.auth.getSession();

			if (session) {
				document.getElementById('loginScreen').style.display = 'none';
				document.getElementById('appInterface').style.display = 'flex';
				document.getElementById('sidebarEmail').innerText = session.user.email;

				const settingsBtn = document.getElementById('settingsBtn');
				settingsBtn.style.display = 'none';

				loadAdminSettings().then(() => {
					lucide.createIcons();
					loadKBDocuments();
				});

				const { data: profile } = await _supabase.from('profiles').select('role').eq('id', session.user.id).single();

				if (profile && profile.role === 'admin') {
					settingsBtn.style.display = 'block';
				}

				const { data: sessions } = await _supabase.from('chat_sessions').select('*').eq('user_id', session.user.id).order('timestamp', { ascending: false }).limit(1);
				if (sessions && sessions.length > 0) {
					loadSession(sessions[0].id, true);
				} else {
					currentSessionId = Date.now().toString();
					loadHistory();
				}
			} else {
				document.getElementById('loginScreen').style.display = 'flex';
				document.getElementById('appInterface').style.display = 'none';
			}
			applyNativeKeyboardFix();

			// Fix Sidebar Glitch on Load
			setTimeout(() => {
				const sb = document.getElementById('mainSidebar');
				if (sb) {
					sb.style.visibility = '';
					sb.style.transform = '';
					sb.classList.remove('opacity-0');
					sb.classList.add('transition-transform', 'duration-300', 'ease-in-out');
				}
			}, 500);
		}

		document.addEventListener('click', (e) => {
			if (!e.target.closest('.history-item-container')) {
				document.querySelectorAll('.history-item-container.swiped-left').forEach(c => {
					c.classList.remove('swiped-left');
				});
			}
		});

		const userInput = document.getElementById('userInput');
		const inputWrapper = document.getElementById('inputWrapper');

		userInput.addEventListener('input', function () {
			this.style.height = 'auto';
			this.style.height = this.scrollHeight + 'px';

			const isLongText = this.scrollHeight > 45;
			if (isLongText) {
				inputWrapper.classList.remove('rounded-[28px]');
				inputWrapper.classList.add('rounded-[22px]');
			} else {
				inputWrapper.classList.add('rounded-[28px]');
				inputWrapper.classList.remove('rounded-[22px]');
			}
		});

		userInput.addEventListener('keydown', function (e) {
			if (e.key === 'Enter' && !e.shiftKey) {
				e.preventDefault();
				sendMessage(e);
			}
		});

		document.getElementById('chatForm').onsubmit = sendMessage;
		init();
		function toggleAddUserForm() {
			const form = document.getElementById('addUserForm');
			form.classList.toggle('hidden');
			if (!form.classList.contains('hidden')) {
				document.getElementById('newUserEmail').focus();
			}
		}

		function applyNativeKeyboardFix() {
			const inputs = document.querySelectorAll('input[type="text"], input[type="email"], input[type="password"], textarea');

			inputs.forEach(el => {
				el.addEventListener('blur', () => {
					window.scrollTo(0, 0);
				});
			});
		}

		async function fetchUsers() {
			const container = document.getElementById('userListContainer');
			// Only show loading if empty
			if (!container.hasChildNodes() || container.innerText.includes('Memuat')) {
				container.innerHTML = `<div class="text-center py-4"><span class="text-xs font-medium text-slate-400">Memuat data user...</span></div>`;
			}

			const { data: { session } } = await _supabase.auth.getSession();
			if (!session) return;

			try {
				// 1. Fetch User List (Auth) from Edge Function
				const res = await fetch(USER_MGMT_URL, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` },
					body: JSON.stringify({ action: 'list_users' })
				});
				const data = await res.json();
				if (data.error) throw new Error(data.error);

				// 2. Fetch Profiles (Settings) directly from DB
				const { data: profiles, error: profErr } = await _supabase.from('profiles').select('*');
				if (profErr) throw profErr;

				// Map profiles by ID
				const profileMap = {};
				profiles.forEach(p => profileMap[p.id] = p);

				container.innerHTML = '';
				if (!data.users || data.users.length === 0) {
					container.innerHTML = `<div class="text-center py-4"><span class="text-xs font-medium text-slate-400">Tidak ada user lain.</span></div>`;
					return;
				}

				data.users.forEach(u => {
					const isBanned = u.banned_until && new Date(u.banned_until) > new Date();
					const isMe = u.id === session.user.id;
					const profile = profileMap[u.id] || { use_google_search: true, use_knowledge_base: true, allow_file_upload: true };

					const div = document.createElement('div');
					div.className = "bg-white p-3 rounded-xl border border-slate-100 flex flex-col md:flex-row md:items-center justify-between gap-3";
					div.innerHTML = `
					    <div class="flex items-center gap-3 overflow-hidden min-w-0 flex-1">
					        <div class="w-8 h-8 rounded-full ${isBanned ? 'text-red-600' : 'text-green-600'} flex items-center justify-center shrink-0">
					            <i data-lucide="${isBanned ? 'lock' : 'user'}" class="w-4 h-4"></i>
					        </div>
					        <div class="min-w-0 flex-1">
					            <p class="text-sm font-bold text-slate-700 truncate">${u.email}</p>
					            <p class="text-[10px] font-medium text-slate-400 truncate">ID: ${u.id}</p>
					        </div>
					    </div>

					    <div class="flex items-center gap-2 self-end md:self-auto">
							<!-- FEATURE TOGGLES -->
							<button id="btn-gs-${u.id}" onclick="toggleUserFeature('${u.id}', 'use_google_search', ${!profile.use_google_search})" 
								class="p-2 rounded-lg transition-colors ${profile.use_google_search ? 'bg-blue-50 text-blue-600' : 'bg-slate-50 text-slate-400'}" title="Toggle Google Search">
								<i data-lucide="globe" class="w-4 h-4"></i>
							</button>
							<button id="btn-uf-${u.id}" onclick="toggleUserFeature('${u.id}', 'allow_file_upload', ${!profile.allow_file_upload})" 
								class="p-2 rounded-lg transition-colors ${profile.allow_file_upload ? 'bg-blue-50 text-blue-600' : 'bg-slate-50 text-slate-400'}" title="Toggle File Upload">
								<i data-lucide="paperclip" class="w-4 h-4"></i>
							</button>
							<button id="btn-kb-${u.id}" onclick="toggleUserFeature('${u.id}', 'use_knowledge_base', ${!profile.use_knowledge_base})" 
								class="p-2 rounded-lg transition-colors ${profile.use_knowledge_base ? 'bg-blue-50 text-blue-600' : 'bg-slate-50 text-slate-400'}" title="Toggle Knowledge Base">
								<i data-lucide="book-open" class="w-4 h-4"></i>
							</button>

							<div class="w-px h-6 bg-slate-200 mx-1"></div>

					        ${!isMe ? `
					        <button onclick="openUserActionModal('toggleBan', '${u.id}', '${u.email}', ${isBanned})" class="p-2 rounded-lg ${isBanned ? 'bg-green-50 text-green-600' : 'bg-slate-50 text-slate-400 hover:text-orange-600'} transition-colors" title="${isBanned ? 'Unfreeze' : 'Freeze'}">
					            <i data-lucide="${isBanned ? 'unlock' : 'lock'}" class="w-4 h-4"></i>
					        </button>
					        <button onclick="openUserActionModal('delete', '${u.id}', '${u.email}')" class="p-2 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 transition-colors" title="Delete">
					            <i data-lucide="trash-2" class="w-4 h-4"></i>
					        </button>
					        ` : `<div class="w-8"></div>`}
					    </div>
					`;
					container.appendChild(div);
				});
				lucide.createIcons();
			} catch (e) {
				console.error(e);
				container.innerHTML = `<div class="text-center py-4 text-red-500 font-bold text-xs">Gagal memuat user: ${e.message}</div>`;
			}
		}

		async function toggleUserFeature(userId, feature, newValue) {
			// IDENTIFY BUTTON
			let btnId = '';
			const activeClass = 'bg-blue-50 text-blue-600';
			const inactiveClass = 'bg-slate-50 text-slate-400';

			if (feature === 'use_google_search') {
				btnId = `btn-gs-${userId}`;
			} else if (feature === 'allow_file_upload') {
				btnId = `btn-uf-${userId}`;
			} else if (feature === 'use_knowledge_base') {
				btnId = `btn-kb-${userId}`;
			}

			const btn = document.getElementById(btnId);
			const originalClass = btn ? btn.className : '';
			const originalOnClick = btn ? btn.getAttribute('onclick') : '';

			// 1. OPTIMISTIC UPDATE UI
			if (btn) {
				if (newValue) {
					// Turn ON
					btn.className = `p-2 rounded-lg transition-colors ${activeClass}`;
				} else {
					// Turn OFF
					btn.className = `p-2 rounded-lg transition-colors ${inactiveClass}`;
				}
				// Update onclick agar bisa toggle balik tanpa reload
				btn.setAttribute('onclick', `toggleUserFeature('${userId}', '${feature}', ${!newValue})`);
			}

			// 2. BACKGROUND REQUEST
			try {
				const { error } = await _supabase
					.from('profiles')
					.update({ [feature]: newValue })
					.eq('id', userId);

				if (error) throw error;

				// UPDATE LOCAL STORAGE IF CURRENT USER
				const { data: { session } } = await _supabase.auth.getSession();
				if (session && session.user.id === userId) {
					if (feature === 'use_google_search') localStorage.setItem('awas_settings_google', newValue ? 'true' : 'false');
					if (feature === 'use_knowledge_base') localStorage.setItem('awas_settings_kb', newValue ? 'true' : 'false');
					if (feature === 'allow_file_upload') {
						localStorage.setItem('awas_allow_upload', newValue ? 'true' : 'false');
						applyUploadUIState(newValue);
					}
				}

			} catch (e) {
				console.error("Gagal update user feature:", e);
				showToast("Gagal update settings: " + e.message, "error");

				// REVERT UI
				if (btn) {
					btn.className = originalClass;
					btn.setAttribute('onclick', originalOnClick);
				}
			}
		}

		async function createNewUser(e) {
			const email = document.getElementById('newUserEmail').value;
			const password = document.getElementById('newUserPassword').value;

			if (!email || !password) return showToast("Email dan Password harus diisi!", "error");

			const btn = e.target;
			const originalHTML = btn.innerHTML;
			btn.innerHTML = '<div class="btn-spinner dark" style="margin:0 auto;"></div>';
			btn.disabled = true;

			try {
				const { data: { session } } = await _supabase.auth.getSession();
				const res = await fetch(USER_MGMT_URL, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${session.access_token}`
					},
					body: JSON.stringify({ action: 'create_user', email, password })
				});

				const data = await res.json();
				if (data.error) throw new Error(data.error);

				showToast("User berhasil dibuat!", "success");
				document.getElementById('newUserEmail').value = '';
				document.getElementById('newUserPassword').value = '';
				toggleAddUserForm();
				fetchUsers();

			} catch (err) {
				showToast("Gagal membuat user: " + err.message, "error");
			} finally {
				btn.innerHTML = originalHTML;
				btn.disabled = false;
			}
		}



		// --- RENAME LOGIC ---
		let currentRenameId = null;

		function handleRenameClick(id, currentTitle) {
			document.getElementById(`menu-dropout-${id}`)?.classList.add('hidden');
			currentRenameId = id;
			const modal = document.getElementById('renameModal');
			const content = document.getElementById('renameModalContent');
			const input = document.getElementById('renameInput');

			input.value = currentTitle;

			modal.classList.remove('hidden');
			requestAnimationFrame(() => {
				modal.classList.remove('opacity-0');
				content.classList.remove('scale-95');
				content.classList.add('scale-100');
			});
			setTimeout(() => input.focus(), 100);
		}

		function closeRenameModal() {
			const modal = document.getElementById('renameModal');
			const content = document.getElementById('renameModalContent');
			modal.classList.add('opacity-0');
			content.classList.remove('scale-100');
			content.classList.add('scale-95');
			setTimeout(() => {
				modal.classList.add('hidden');
				currentRenameId = null;
			}, 200);
		}

		async function submitRename() {
			const input = document.getElementById('renameInput');
			const newTitle = input.value.trim();

			if (!newTitle) {
				showToast("Nama tidak boleh kosong", "error");
				return;
			}

			if (currentRenameId) {
				const oldHtml = document.querySelector(`button[onclick="submitRename()"]`).innerHTML;
				document.querySelector(`button[onclick="submitRename()"]`).innerHTML = '<div class="btn-spinner" style="width:14px;height:14px;border-width:2px;"></div>';

				try {
					const { error } = await _supabase
						.from('chat_sessions')
						.update({ title: newTitle })
						.eq('id', currentRenameId);

					if (error) throw error;
					loadHistory();
					closeRenameModal();
				} catch (e) {
					showToast("Gagal update: " + e.message, "error");
				} finally {
					document.querySelector(`button[onclick="submitRename()"]`).innerHTML = oldHtml;
				}
			}
		}

		// --- DELETE LOGIC ---
		let currentDeleteId = null;

		function handleDeleteClick(id) {
			// Sembunyikan dropdown menu
			document.getElementById(`menu-dropout-${id}`)?.classList.add('hidden');

			currentDeleteId = id;
			const modal = document.getElementById('deleteModal');
			const content = document.getElementById('deleteModalContent');

			modal.classList.remove('hidden');
			requestAnimationFrame(() => {
				modal.classList.remove('opacity-0');
				content.classList.remove('scale-95');
				content.classList.add('scale-100');
			});
		}

		function closeDeleteModal() {
			const modal = document.getElementById('deleteModal');
			const content = document.getElementById('deleteModalContent');

			modal.classList.add('opacity-0');
			content.classList.remove('scale-100');
			content.classList.add('scale-95');

			setTimeout(() => {
				modal.classList.add('hidden');
				currentDeleteId = null;
			}, 200);
		}

		async function confirmDelete() {
			if (!currentDeleteId) return;

			const btn = document.querySelector(`button[onclick="confirmDelete()"]`);
			const oldHtml = btn.innerHTML;
			btn.innerHTML = '<div class="btn-spinner" style="width:14px;height:14px;border-width:2px;"></div>';
			btn.disabled = true;

			try {
				await _supabase.from('chat_messages').delete().eq('session_id', currentDeleteId);
				await _supabase.from('chat_sessions').delete().eq('id', currentDeleteId);

				if (currentSessionId === currentDeleteId) {
					// Jika yang dihapus adalah chat yang sedang dibuka
					// Langsung inisialisasi sesi baru agar chat berikutnya tersimpan
					currentSessionId = Date.now().toString();
					document.getElementById('messagesArea').innerHTML = '';
					chatHistory = [];
					toggleSidebar(false);
				}
				loadHistory();
				closeDeleteModal();
			} catch (e) {
				showToast("Gagal menghapus: " + e.message, "error");
			} finally {
				btn.innerHTML = oldHtml;
				btn.disabled = false;
			}
		}

		// --- ACTION MODAL LOGIC (User & KB) ---
		let currentUserAction = null;

		function openUserActionModal(type, uid, identifier, isBanned) {
			currentUserAction = { type, uid, identifier, isBanned };

			const modal = document.getElementById('userActionModal');
			const content = document.getElementById('userActionModalContent');
			const title = document.getElementById('userActionTitle');
			const msg = document.getElementById('userActionMessage');
			const btn = document.getElementById('userActionConfirmBtn');

			// Reset styles
			btn.className = "flex-1 py-2.5 rounded-xl text-xs font-bold transition-colors";

			if (type === 'delete') {
				title.innerText = "Hapus User?";
				msg.innerText = `Anda yakin ingin menghapus user ${identifier}? Data tidak bisa dikembalikan.`;
				btn.innerText = "Hapus";
				btn.classList.add("bg-red-50", "text-red-600", "hover:bg-red-100");
			} else if (type === 'toggleBan') {
				const actionText = isBanned ? "Aktifkan" : "Bekukan";
				title.innerText = `${actionText} User?`;
				msg.innerText = `Anda yakin ingin membuat user ${identifier} menjadi ${isBanned ? 'AKTIF' : 'DIBEKUKAN'}?`;
				btn.innerText = actionText;

				if (isBanned) {
					btn.classList.add("bg-green-50", "text-green-600", "hover:bg-green-100");
				} else {
					btn.classList.add("bg-orange-50", "text-orange-600", "hover:bg-orange-100");
				}
			} else if (type === 'deleteKB') {
				title.innerText = "Hapus Dokumen?";
				msg.innerText = "Anda yakin ingin menghapus dokumen Knowledge Base ini? Semua data terkait akan hilang.";
				btn.innerText = "Hapus";
				btn.classList.add("bg-red-50", "text-red-600", "hover:bg-red-100");
			}

			modal.classList.remove('hidden');
			requestAnimationFrame(() => {
				modal.classList.remove('opacity-0');
				content.classList.remove('scale-95');
				content.classList.add('scale-100');
			});
		}

		function closeUserActionModal() {
			const modal = document.getElementById('userActionModal');
			const content = document.getElementById('userActionModalContent');

			modal.classList.add('opacity-0');
			content.classList.remove('scale-100');
			content.classList.add('scale-95');

			setTimeout(() => {
				modal.classList.add('hidden');
				currentUserAction = null;
			}, 200);
		}

		async function confirmUserAction() {
			if (!currentUserAction) return;

			const { type, uid, isBanned } = currentUserAction;
			const btn = document.getElementById('userActionConfirmBtn');
			const oldHtml = btn.innerHTML;
			btn.innerHTML = '<div class="btn-spinner" style="width:14px;height:14px;border-width:2px;"></div>';
			btn.disabled = true;

			try {
				if (type === 'delete') {
					await performDeleteUser(uid);
				} else if (type === 'toggleBan') {
					await performToggleBanUser(uid, isBanned);
				} else if (type === 'deleteKB') {
					await performDeleteKBDocument(uid);
				}
				closeUserActionModal();
				if (type === 'deleteKB') loadKBDocuments();
				else fetchUsers();
			} catch (e) {
				showToast("Gagal: " + e.message, "error");
			} finally {
				btn.innerHTML = oldHtml;
				btn.disabled = false;
			}
		}

		async function performDeleteUser(userId) {
			const { data: { session } } = await _supabase.auth.getSession();
			const res = await fetch(USER_MGMT_URL, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'Authorization': `Bearer ${session.access_token}`
				},
				body: JSON.stringify({ action: 'delete_user', userId })
			});

			const data = await res.json();
			if (data.error) throw new Error(data.error);
		}

		async function performToggleBanUser(userId, isCurrentlyBanned) {
			const duration = isCurrentlyBanned ? '0s' : '876600h'; // 100 years or reset
			const { data: { session } } = await _supabase.auth.getSession();
			const res = await fetch(USER_MGMT_URL, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'Authorization': `Bearer ${session.access_token}`
				},
				body: JSON.stringify({ action: 'toggle_ban_user', userId, banDuration: duration })
			});

			const data = await res.json();
			if (data.error) throw new Error(data.error);
		}

		async function performDeleteKBDocument(docId) {
			const { error } = await _supabase.from('kb_documents').delete().eq('id', docId);
			if (error) throw error;
			showToast('Dokumen berhasil dihapus', 'success');
		}

		// Close modals logic
		window.onclick = function (event) {
			if (event.target == document.getElementById('renameModal')) closeRenameModal();
			if (event.target == document.getElementById('deleteModal')) closeDeleteModal();
		}

		document.getElementById('renameInput').addEventListener('keydown', (e) => {
			if (e.key === 'Enter') submitRename();
			if (e.key === 'Escape') closeRenameModal();
		});

		// Keydown ESC for all modals
		document.addEventListener('keydown', (e) => {
			if (e.key === 'Escape') {
				closeRenameModal();
				closeDeleteModal();
			}
		});
	</script>
	<script>
		if ('serviceWorker' in navigator) {
			window.addEventListener('load', () => {
				navigator.serviceWorker.register('./sw.js')
					.then(registration => {
						console.log('ServiceWorker registration successful with scope: ', registration.scope);
					})
					.catch(error => {
						console.log('ServiceWorker registration failed: ', error);
					});
			});
		}
	</script>
</body>

</html>
