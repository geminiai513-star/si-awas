<!DOCTYPE html>
<html lang="id">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<title>ALISA AI</title>
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="default">
	<meta name="theme-color" content="#ffffff">
	<meta name="apple-mobile-web-app-title" content="ALISA AI">
	<link rel="apple-touch-icon" href="icon/icon-512.png">
	<link rel="icon" type="image/png" href="icon/icon-512.png">
	<script src="https://cdn.tailwindcss.com"></script>
	<script src="https://unpkg.com/lucide@latest"></script>
	<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
	<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
	<link
		href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono&family=Outfit:wght@400..900&display=swap"
		rel="stylesheet">
	<style>
		html,
		body {
		    margin: 0;
		    padding: 0;
		    height: 100%;
		    width: 100%;
		    overflow: hidden;
		    background-color: #ffffff;
		    font-family: 'Inter', sans-serif;
		    -webkit-text-size-adjust: none;
		    touch-action: none;
		    -webkit-user-select: none;
		    user-select: none;
		    -webkit-tap-highlight-color: transparent;
		    position: fixed;
		}
		
		#appInterface {
		    width: 100%;
		    height: 100%;
		    display: none;
		    flex-direction: column;
		    background-color: #ffffff;
		    position: absolute;
		    top: 0;
		    left: 0;
		    right: 0;
		    bottom: 0;
		}
		
		main {
		    flex: 1 1 auto;
		    overflow-y: auto;
		    -webkit-overflow-scrolling: touch;
		    background-color: #ffffff;
		    position: relative;
		    overscroll-behavior: contain;
		    transform: translateZ(0);
		    -webkit-transform: translateZ(0);
		    backface-visibility: hidden;
		    -webkit-backface-visibility: hidden;
		    will-change: transform;
		}

		/* Global disable drag and selection */
		*,
		*::before,
		*::after {
			-webkit-user-drag: none;
			-khtml-user-drag: none;
			-moz-user-drag: none;
			-o-user-drag: none;
			user-drag: none;
			-webkit-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
		}

		/* Allow selection only in specific areas */
		.prose,
		.prose *,
		input,
		textarea {
			-webkit-user-select: text;
			-moz-user-select: text;
			-ms-user-select: text;
			user-select: text;
		}

		/* Prevent interaction with images and icons */
		img,
		svg {
			pointer-events: none;
		}

		/* Allow interaction with content images */
		.prose img {
			pointer-events: auto;
		}

		header {
			flex: 0 0 auto;
			background: white;
			border-bottom: 1px solid #f1f5f9;
			padding-top: env(safe-area-inset-top, 0px);
			z-index: 100;
		}

		footer {
			flex: 0 0 auto;
			background-color: #ffffff;
			z-index: 100;
			padding-bottom: 12px;
			border-top: none;
		}

		.footer-content {
			width: 100%;
			max-width: 48rem;
			margin: 0 auto;
			padding: 12px 1rem;
		}

		#userInput {
			width: 100%;
			background: transparent;
			border: none;
			outline: none;
			resize: none;
			padding: 12px 8px;
			font-size: 16px;
			font-weight: 500;
			color: #1f2937;
			line-height: 20px;
			max-height: 150px;
			display: block;
		}

		#userInput::placeholder {
			font-size: 15px;
			color: #94a3b8;
		}

		#loginScreen {
			position: fixed;
			inset: 0;
			background: white;
			z-index: 100;
			display: none;
			align-items: center;
			justify-content: center;
			padding: 2rem;
		}

		code {
			font-family: 'JetBrains Mono', monospace;
		}

		.prose pre {
			background: #f3f4f6 !important;
			padding: 1rem !important;
			border-radius: 1rem !important;
			margin: 0.75rem 0;
			overflow-x: auto;

		}

		.prose table {
			display: block;
			width: 100%;
			overflow-x: auto;
			border-collapse: collapse;
			margin: 0.75rem 0;
		}

		.prose code {
			background-color: #f1f5f9 !important;
			color: #475569 !important;
			padding: 2px 5px !important;
			border-radius: 4px !important;
			font-weight: 600 !important;
			font-size: 0.85em !important;
			font-family: 'JetBrains Mono', monospace !important;
			vertical-align: 1px;
		}

		.prose pre code {
			background-color: transparent !important;
			padding: 0 !important;
			font-weight: 500 !important;
		}

		.prose-container {
		    overflow-x: visible;
		}
		
		.prose ul, .prose ol {
		    padding-left: 2.2rem;
		    margin-bottom: 0.75rem;
		    list-style-position: outside;
		}
		
		.prose li {
		    margin-bottom: 0.2rem;
		}

		.prose ul {
			list-style-type: disc;
		}

		.prose ol {
			list-style-type: decimal;
		}

		.prose th,
		.prose td {
			border: 1px solid #e5e7eb;
			padding: 0.5rem 0.75rem;
			font-size: 14px !important;
		}

		.prose p {
			margin-bottom: 0.5rem;
		}

		::-webkit-scrollbar {
			display: none;
			width: 0;
			height: 0;
			background: transparent;
		}

		html,
		body,
		* {
			-ms-overflow-style: none;
			scrollbar-width: none;
		}

		.custom-scroll {
			scrollbar-width: none;
			-ms-overflow-style: none;
		}

		.content-width {
			width: 100%;
			max-width: 48rem;
			margin: 0 auto;
			padding: 0 1rem;
		}

		textarea:focus,
		input:focus {
			outline: none !important;
			box-shadow: none !important;
			border: none !important;
		}

		@keyframes appearance {

			0%,
			100% {
				opacity: 0.3;
				transform: scale(0.8);
			}

			50% {
				opacity: 1;
				transform: scale(1);
			}
		}

		.typing-indicator {
			display: flex;
			align-items: center;
			gap: 4px;
			height: 22px;
			margin-top: 2px;
		}

		.typing-dot {
			width: 4px;
			height: 4px;
			background-color: #94a3b8;
			border-radius: 50%;
			animation: appearance 1.4s infinite ease-in-out;
		}

		.typing-dot:nth-child(1) {
			animation-delay: 0s;
		}

		.typing-dot:nth-child(2) {
			animation-delay: 0.2s;
		}

		.typing-dot:nth-child(3) {
			animation-delay: 0.4s;
		}

		.media-container>* {
			margin-top: 0 !important;
		}
		
		#mainSidebar {
		    display: flex;
		    flex-direction: column;
		    overscroll-behavior: contain;
		}
		
		#historyList {
		    flex: 1 1 auto;
		    overflow-y: auto;
		    -webkit-overflow-scrolling: touch;
		    overscroll-behavior-y: contain;
		}
		
		.sidebar-bottom-controls {
		    flex: 0 0 auto;
		    background-color: #ffffff;
		    border-top: 1px solid #f8fafc; 
		    padding: 12px 1rem;
		    padding-bottom: 26px; 
		}
		
		#loadingOverlay {
		    position: fixed;
		    top: 0;
		    left: 0;
		    width: 100%;
		    height: 100%;
		    background: #ffffff;
		    z-index: 9999;
		    display: flex;
		    align-items: center;
		    justify-content: center;
		    touch-action: none;
		    user-select: none;
		    -webkit-user-select: none;
		    overscroll-behavior: none;
		    pointer-events: all;
		    transition: opacity 0.4s ease-out, visibility 0.4s;
		}
		
		#loadingOverlay img {
		    max-width: 80px;
		    max-height: 80px;
		    object-contain: contain;
		    pointer-events: none;
		}
	</style>
</head>

<body class="text-slate-900">
	
	<!-- Loading Spiner -->
	<div id="loadingOverlay">
	    <img src="icon/icon.GIF" class="w-20 h-20 object-contain">
	</div>
	
	<!-- Sidebar Overlay -->
	<div id="sidebarOverlay"
		class="fixed inset-0 bg-black/20 z-[150] hidden backdrop-blur-sm transition-opacity opacity-0"></div>

	<!-- Sidebar -->
	<div id="mainSidebar"
    class="fixed inset-y-0 left-0 w-[280px] bg-white z-[160] transform -translate-x-full transition-transform duration-300 ease-in-out flex flex-col border-r border-slate-100 shadow-2xl">
    
	    <div class="h-16 flex items-center px-4 border-b border-slate-50 shrink-0">
	        <div class="flex items-center gap-3 w-full">
	            <div class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-600 font-bold shadow-sm shrink-0">
	                <i data-lucide="user" class="w-5 h-5"></i>
	            </div>
	            <div class="flex-1 min-w-0">
	                <p id="sidebarEmail" class="text-[14px] font-bold text-slate-600 truncate font-sans leading-tight">
	                    user@example.com</p>
	            </div>
	        </div>
	    </div>
	
	    <div class="flex-1 overflow-y-auto custom-scroll p-3 space-y-4" id="historyList"></div>
	
	    <div class="sidebar-bottom-controls">
	        <div class="space-y-2">
	            <button id="newChatSidebarBtn"
	                class="w-full flex items-center justify-start gap-3 px-4 py-3 text-slate-700 bg-slate-50 rounded-xl transition-all group active:scale-[0.98]">
	                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
	                    stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
	                    class="text-current transition-colors opacity-60 group-hover:opacity-100">
	                    <path d="M2.992 16.342a2 2 0 0 1 .094 1.167l-1.065 3.29a1 1 0 0 0 1.236 1.168l3.413-.998a2 2 0 0 1 1.099.092 10 10 0 1 0-4.777-4.719" />
	                    <path d="M8 12h8" />
	                    <path d="M12 8v8" />
	                </svg>
	                <span class="font-bold text-sm tracking-wide">Percakapan Baru</span>
	            </button>
	            <button id="sidebarLogoutBtn"
	                class="w-full flex items-center justify-start gap-3 px-4 py-3 text-slate-500 bg-slate-50 rounded-xl transition-all group active:scale-[0.98] hover:text-red-600">
	                <i data-lucide="log-out" stroke-width="2.5"
	                    class="w-[18px] h-[18px] text-current transition-colors opacity-60 group-hover:opacity-100"></i>
	                <span class="font-bold text-sm tracking-wide">Keluar</span>
	            </button>
	        </div>
	    </div>
	</div>
	
	<!-- Login Screen -->
	<div id="loginScreen" class="fixed inset-0 bg-white z-[100] flex items-center justify-center p-6">
		<div
			class="w-full max-w-[360px] bg-white rounded-[32px] px-8 py-8 flex flex-col items-center shadow-[0_8px_30px_rgb(0,0,0,0.08)]">
			<div class="mb-8 flex items-center justify-center">
				<img src="icon/icon.png" alt="Logo" class="w-16 h-16 object-contain">
			</div>
			<form id="loginForm" class="w-full space-y-4">
			    <input type="email" id="emailInput" placeholder="Email" required onblur="window.scrollTo(0,0)"
			        class="w-full px-5 py-4 bg-gray-50 rounded-2xl text-sm font-semibold border-none outline-none focus:ring-0">
			    <input type="password" id="passwordInput" placeholder="Password" required onblur="window.scrollTo(0,0)"
			        class="w-full px-5 py-4 bg-gray-50 rounded-2xl text-sm font-semibold border-none outline-none focus:ring-0">
			    <button type="submit" id="loginBtn"
			        class="w-full py-4 bg-black text-white rounded-2xl font-bold text-sm active:scale-95 transition-all mt-2 uppercase">
			        Masuk
			    </button>
			    <div id="loginError" class="text-red-500 text-[11px] font-bold hidden text-center uppercase tracking-wider mt-2"></div>
			</form>
			<div id="loginError" class="text-red-500 text-sm mt-6 font-bold hidden text-center uppercase"></div>
		</div>
	</div>

	<div id="appInterface">
		<header class="h-16 px-4 md:px-8 flex items-center">
		    <div class="w-full flex justify-between items-center">
		        <div class="flex items-center gap-3">
		            <img src="icon/icon.png" alt="Logo" class="w-10 h-10 object-contain">
		        </div>
		        <div class="flex items-center gap-1">
		            <button id="voiceBtn"
		                class="p-2.5 hover:bg-slate-50 text-slate-400 rounded-xl transition-all active:scale-95">
		                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-audio-lines"><path d="M2 10v3"/><path d="M6 6v11"/><path d="M10 3v18"/><path d="M14 8v7"/><path d="M18 5v13"/><path d="M22 10v3"/></svg>
		            </button>
		            <button id="settingsBtn"
		                class="p-2.5 hover:bg-slate-50 text-slate-400 rounded-xl transition-all active:scale-95">
		                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings-2"><path d="M14 17H5"/><path d="M19 7h-9"/><circle cx="17" cy="17" r="3"/><circle cx="7" cy="7" r="3"/></svg>
		            </button>
		            <button id="menuBtn"
		                class="p-2.5 hover:bg-slate-50 text-slate-400 rounded-xl transition-all active:scale-95 ml-1">
		                <i data-lucide="menu" class="w-6 h-6"></i>
		            </button>
		        </div>
		    </div>
		</header>

		<main id="chatContainer" class="custom-scroll">
			<div class="content-width pt-4 md:pt-8 pb-8">
				<div id="messagesArea" class="space-y-4"></div>
			</div>
		</main>

		<footer>
		    <div class="footer-content">
		        <div id="file-preview-container" class="grid grid-cols-2 md:grid-cols-4 gap-2 empty:hidden mb-4"></div>
		        
		        <form id="chatForm" class="w-full">
		            <div id="inputWrapper" class="relative flex items-center bg-slate-50 rounded-full px-1 py-1.5 transition-colors duration-200">
		                <input type="file" id="file-input" multiple accept="image/*,application/pdf,.docx,.xlsx,.xls,.pptx,.js,.css,.java,.html,.xml,.py,.sql,.ts,.cpp,.h,.hpp,.lua,.swift" class="hidden" onchange="handleFileSelect(event)">
		                
		                <button type="button" id="uploadBtn" onclick="document.getElementById('file-input').click()" class="p-2 text-slate-400 hover:text-slate-600 transition-colors shrink-0">
		                    <i data-lucide="plus" class="w-6 h-6"></i>
		                </button>
		                <textarea id="userInput" placeholder="Tulis pesan..." rows="1" class="flex-1 w-full bg-transparent border-none outline-none resize-none px-2 text-sm font-medium text-slate-900 leading-[24px] max-h-[150px] block placeholder:text-slate-400"></textarea>
		                <button type="submit" id="sendBtn" class="p-2 text-slate-800 hover:text-indigo-600 transition-colors shrink-0">
		                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="currentColor">
		                        <path d="M21.66,12a2,2,0,0,1-1.14,1.81L5.87,20.75A2.08,2.08,0,0,1,5,21a2,2,0,0,1-1.82-2.82L5.46,13H11a1,1,0,0,0,0-2H5.46L3.18,5.87A2,2,0,0,1,5.86,3.25h0l14.65,6.94A2,2,0,0,1,21.66,12Z"></path>
		                    </svg>
		                </button>
		            </div>
		        </form>
		    </div>
		</footer>
	</div>
	
	<!-- ADMIN SCREEN -->
	<div id="adminScreen" class="fixed inset-0 bg-white z-[200] hidden flex-col">
	    <header class="h-16 px-4 md:px-8 flex items-center border-b border-slate-100 shrink-0 relative">
	        <div class="flex items-center z-10">
	            <button id="backFromAdmin" class="p-2 -ml-2 text-slate-400 hover:text-slate-600 transition-all active:scale-90">
	                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left"><path d="m15 18-6-6 6-6"/></svg>
	            </button>
	        </div>
	        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
	            <h2 class="text-sm font-black text-slate-800 uppercase tracking-widest">Admin Control</h2>
	        </div>
	    </header>
	
	    <main id="adminScroller" class="flex-1 overflow-y-auto bg-white custom-scroll">
	        <div class="content-width pt-4 md:pt-8 pb-8 space-y-4">
	            <div class="w-full bg-slate-50 rounded-2xl p-5 shadow-sm border-none" id="model-dropdown">
	                <div class="mb-4">
	                    <span class="text-xs font-black text-slate-500 uppercase tracking-widest">Model AI</span>
	                </div>
	                <div class="space-y-4">
	                    <div class="relative">
	                        <button type="button" id="dropdown-trigger" class="w-full bg-gray-100 rounded-xl px-5 py-3 text-[15px] font-bold text-slate-700 shadow-sm flex items-center justify-between outline-none">
	                            <span id="selected-model-text">Gemini 3 Flash</span>
	                            <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 transition-transform duration-200" id="dropdown-icon"></i>
	                        </button>
	                        <div id="dropdown-menu" class="hidden absolute left-0 right-0 mt-2 bg-white rounded-2xl shadow-xl border border-slate-100 p-2 z-[210]">
	                            <div class="flex flex-col">
	                                <div class="dropdown-option py-3 px-4 rounded-xl hover:bg-slate-50 cursor-pointer text-sm font-medium text-slate-800" data-value="gemini-2.5-pro">Gemini 2.5 Pro</div>
	                                <div class="dropdown-option py-3 px-4 rounded-xl hover:bg-slate-50 cursor-pointer text-sm font-medium text-slate-800" data-value="gemini-2.5-flash">Gemini 2.5 Flash</div>
	                                <div class="dropdown-option py-3 px-4 rounded-xl hover:bg-slate-50 cursor-pointer text-sm font-medium text-slate-800" data-value="gemini-2.5-flash-lite">Gemini 2.5 Flash Lite</div>
	                                <div class="dropdown-option py-3 px-4 rounded-xl hover:bg-slate-50 cursor-pointer text-sm font-medium text-slate-800" data-value="gemini-3-flash-preview">Gemini 3 Flash</div>
	                                <div class="dropdown-option py-3 px-4 rounded-xl hover:bg-slate-50 cursor-pointer text-sm font-medium text-slate-800" data-value="gemini-3-pro-preview">Gemini 3 Pro</div>
	                                <div class="dropdown-option py-3 px-4 rounded-xl hover:bg-slate-50 cursor-pointer text-sm font-medium text-slate-800" data-value="gemini-3-deep-think-preview">Gemini 3 Deep Think</div>
	                            </div>
	                        </div>
	                    </div>
	
	                    <div class="relative">
	                        <button type="button" id="voice-trigger" class="w-full bg-gray-100 rounded-xl px-5 py-3 text-[15px] font-bold text-slate-700 shadow-sm flex items-center justify-between outline-none">
	                            <span id="selected-voice-text">Kore (Default)</span>
	                            <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 transition-transform duration-200" id="voice-icon"></i>
	                        </button>
	                        <div id="voice-menu" class="hidden absolute left-0 right-0 mt-2 bg-white rounded-2xl shadow-xl border border-slate-100 p-2 z-[210]">
	                            <div class="flex flex-col max-h-48 overflow-y-auto">
	                                <div class="voice-option py-3 px-4 rounded-xl hover:bg-slate-50 cursor-pointer text-sm font-medium text-slate-800" data-value="Kore">Kore (Default)</div>
	                                <div class="voice-option py-3 px-4 rounded-xl hover:bg-slate-50 cursor-pointer text-sm font-medium text-slate-800" data-value="Aoede">Aoede</div>
	                                <div class="voice-option py-3 px-4 rounded-xl hover:bg-slate-50 cursor-pointer text-sm font-medium text-slate-800" data-value="Zephyr">Zephyr</div>
	                                <div class="voice-option py-3 px-4 rounded-xl hover:bg-slate-50 cursor-pointer text-sm font-medium text-slate-800" data-value="Leda">Leda</div>
	                                <div class="voice-option py-3 px-4 rounded-xl hover:bg-slate-50 cursor-pointer text-sm font-medium text-slate-800" data-value="Fenrir">Fenrir</div>
	                            </div>
	                        </div>
	                    </div>
	                </div>
	            </div>
	
	            <div class="w-full bg-slate-50 rounded-2xl p-5 shadow-sm border-none">
	                <div class="mb-6">
	                    <span class="text-xs font-black text-slate-500 uppercase tracking-widest">Parameter AI</span>
	                </div>
	                <div class="space-y-6">
	                    <div>
	                        <div class="flex justify-between items-center mb-2">
	                            <span class="text-[11px] font-bold text-slate-400 uppercase tracking-wider">Temperature</span>
	                            <span id="label-temp" class="text-[11px] font-black text-slate-600">1.0</span>
	                        </div>
	                        <input type="range" id="settings-temp" min="0" max="2" step="0.1" class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-600">
	                    </div>
	
	                    <div>
	                        <div class="flex justify-between items-center mb-2">
	                            <span class="text-[11px] font-bold text-slate-400 uppercase tracking-wider">Max Tokens</span>
	                            <span id="label-tokens" class="text-[11px] font-black text-slate-600">65536</span>
	                        </div>
	                        <input type="range" id="settings-tokens" min="1024" max="128000" step="1024" class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-600">
	                    </div>
	
	                    <div>
	                        <div class="flex justify-between items-center mb-2">
	                            <span class="text-[11px] font-bold text-slate-400 uppercase tracking-wider">Thinking Budget</span>
	                            <span id="label-thinking" class="text-[11px] font-black text-slate-600">MEDIUM</span>
	                        </div>
	                        <input type="range" id="settings-thinking" min="1" max="3" step="1" class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-600">
	                    </div>
	                </div>
	            </div>
	
	            <div class="w-full bg-slate-50 rounded-2xl p-5 shadow-sm border-none">
	                <div class="mb-4">
	                    <span class="text-xs font-black text-slate-500 uppercase tracking-widest">System Prompt</span>
	                </div>
	                <textarea id="systemPromptInput" rows="4" onblur="window.scrollTo(0,0)" class="w-full bg-gray-100 rounded-xl px-4 py-3 text-[15px] leading-relaxed font-medium text-slate-600 outline-none focus:ring-1 focus:ring-slate-200 transition-all resize-none"></textarea>
	            </div>
	        </div>
	    </main>
	
	    <footer class="bg-white shrink-0 h-6 mb-[env(safe-area-inset-bottom,0px)]"></footer>
	</div>
	
	<!-- VOICE SCREEN -->
	<div id="voiceScreen" class="fixed inset-0 bg-white z-[250] hidden flex-col">
	    <header class="h-16 px-4 md:px-8 flex items-center border-none shrink-0 relative">
	        <div class="flex items-center z-10">
	            <button id="backFromVoice" class="p-2 -ml-2 text-slate-400 hover:text-slate-600 transition-all active:scale-90">
	                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left"><path d="m15 18-6-6 6-6"/></svg>
	            </button>
	        </div>
	        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
	            <h2 class="text-sm font-black text-slate-800 uppercase tracking-widest">Live Voice</h2>
	        </div>
	    </header>
	
	    <main class="flex-1 w-full max-w-3xl mx-auto px-4 py-0 flex flex-col items-center justify-center overflow-hidden relative">
		    <div id="voice-visual-box" class="w-full h-full relative flex items-center justify-center overflow-hidden">
		        <canvas id="voice-canvas" class="block"></canvas>
		        <video id="voice-large-video" autoplay playsinline muted 
		            class="hidden absolute inset-0 w-full h-full object-cover rounded-[2rem] shadow-xl bg-slate-900 border-none z-20">
		        </video>
		        <canvas id="voice-frame-canvas" style="display:none;"></canvas>
		    </div>
		</main>
	
	    <footer class="w-full shrink-0 bg-white">
	        <div class="max-w-4xl mx-auto px-6 pb-8 pt-4 flex flex-col items-center gap-6">
	            <div id="voice-timer" class="text-slate-300 font-mono text-xs tracking-[0.3em] font-bold">00:00:00</div>
	            <div class="flex justify-center items-center gap-6 md:gap-10">
	                <button id="switchCameraBtn" class="w-14 h-14 md:w-16 md:h-16 flex items-center justify-center bg-slate-50 text-slate-500 rounded-full active:scale-90 transition-all border border-slate-100 shadow-sm shrink-0">
	                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-switch-camera"><path d="M11 19H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h5"/><path d="M13 5h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-5"/><circle cx="12" cy="12" r="3"/><path d="m18 22-3-3 3-3"/><path d="m6 2 3 3-3 3"/></svg>
	                </button>
	
	                <button id="endCallBtn" class="w-14 h-14 md:w-16 md:h-16 flex items-center justify-center bg-red-50 text-red-500 rounded-full active:scale-90 transition-all border border-red-100 shadow-sm shrink-0">
	                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-phone-off"><path d="M10.1 13.9a14 14 0 0 0 3.732 2.668 1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2 18 18 0 0 1-12.728-5.272"/><path d="M22 2 2 22"/><path d="M4.76 13.582A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 .244.473"/></svg>
	                </button>
	
	                <button id="cameraToggleBtn" class="w-14 h-14 md:w-16 md:h-16 flex items-center justify-center bg-slate-50 text-slate-500 rounded-full active:scale-90 transition-all border border-slate-100 shadow-sm shrink-0">
	                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-camera"><path d="M13.997 4a2 2 0 0 1 1.76 1.05l.486.9A2 2 0 0 0 18.003 7H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1.997a2 2 0 0 0 1.759-1.048l.489-.904A2 2 0 0 1 10.004 4z"/><circle cx="12" cy="13" r="3"/></svg>
	                </button>
	            </div>
	        </div>
	    </footer>
	</div>
	<script>
		const SUPABASE_URL = "https://wluwdfbvkyafscotpils.supabase.co";
		const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsdXdkZmJ2a3lhZnNjb3RwaWxzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMjgwNjIsImV4cCI6MjA4MzcwNDA2Mn0.RpCI9gd2v8_K6aEp2rKLTv3OWf952kTWkdlxo8NfozU";
		const PROXY_URL = `${SUPABASE_URL}/functions/v1/gemini-proxy`;
		const YOUTUBE_PROXY_URL = `${SUPABASE_URL}/functions/v1/youtube-proxy`;
		const IMAGE_MODEL_NAME = "gemini-2.5-flash-image";
		const STORAGE_KEY = "sinta_chat_sessions";
		const ACTIVE_SESSION_KEY = "sinta_active_session_id";

		const STREAM_SPEED = 8;
		const STREAM_CHUNK_SIZE = 5;

		const MAIN_SYSTEM_PROMPT = "Anda adalah ALISA, Asisten Inspektorat Provinsi Lampung yang ramah, Profesional dan sangat membantu, selalu berikan informasi yang akurat dan terbaru. PENTING!!! jangan pernah membuat gambar dan mencari video youtube untuk permintaan user gunkan sebijak mungkin jika kamu benar benar membutuhkannya saja.";
		const IMAGE_GEN_PROMPT = "Untuk Membuat Gunakan tag [image]english description[/image].";
		const VIDEO_GEN_PROMPT = "Untuk Mencari video youtube Gunakan tag [youtube]query pencarian spesifik[/youtube].";

		const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

		const loginScreen = document.getElementById('loginScreen');
		const appInterface = document.getElementById('appInterface');
		const loginForm = document.getElementById('loginForm');
		const loginError = document.getElementById('loginError');

		const chatForm = document.getElementById('chatForm');
		const userInput = document.getElementById('userInput');
		const chatContainer = document.getElementById('chatContainer');
		const messagesArea = document.getElementById('messagesArea');
		const sendBtn = document.getElementById('sendBtn');
		const menuBtn = document.getElementById('menuBtn');
		const sidebar = document.getElementById('mainSidebar');
		const overlay = document.getElementById('sidebarOverlay');
		const sidebarEmail = document.getElementById('sidebarEmail');
		const newChatSidebarBtn = document.getElementById('newChatSidebarBtn');

		const historyListEl = document.getElementById('historyList');

		let chatHistory = [];
		let currentSessionId = null;
		let typingBubble = null;
		let isGenerating = false;
		let abortController = null;
		
		let pendingFiles = [];
		
		let currentVoice = localStorage.getItem('alisa_voice') || 'Kore';
		let voiceWs, voiceInCtx, voiceOutCtx, voiceAnalyser, aiAnalyser, voiceDataArray, voiceStream;
		let isAISpeaking = false, voiceNextTime = 0, voiceSessionId = 0, voiceInterrupted = false;
		let voiceTimerInterval, voiceCamStream, voiceCamInterval, isVoiceCamOn = false, facingMode = 'user';
		let activeVoiceSources = [], energyCounter = 0;

		const DB_NAME = "Sinta_Images_DB";
		const DB_VERSION = 1;
		const STORE_NAME = "images";
		let dbInstance = null;
		
		const settingsBtn = document.getElementById('settingsBtn');
		const adminScreen = document.getElementById('adminScreen');
		const backFromAdmin = document.getElementById('backFromAdmin');
		const thinkingMap = { "1": 4000, "2": 16000, "3": 32000 };
		let currentSelectedModel = localStorage.getItem('alisa_model') || "gemini-3-flash-preview";
		
		function saveAdminSettings() {
		    localStorage.setItem('alisa_model', currentSelectedModel);
		    localStorage.setItem('alisa_thinking', document.getElementById('settings-thinking').value);
		    localStorage.setItem('alisa_prompt', document.getElementById('systemPromptInput').value);
		    localStorage.setItem('alisa_temp', document.getElementById('settings-temp').value);
		    localStorage.setItem('alisa_tokens', document.getElementById('settings-tokens').value);
		}
		
		if (settingsBtn && adminScreen) {
		    settingsBtn.addEventListener('click', () => {
		        adminScreen.classList.remove('hidden');
		        adminScreen.classList.add('flex');
		    });
		}
		
		if (backFromAdmin && adminScreen) {
		    backFromAdmin.addEventListener('click', () => {
		        adminScreen.classList.add('hidden');
		        adminScreen.classList.remove('flex');
		        saveAdminSettings();
		    });
		}
		
		document.querySelectorAll('.dropdown-option').forEach(option => {
		    option.addEventListener('click', function() {
		        currentSelectedModel = this.getAttribute('data-value');
		        document.getElementById('selected-model-text').innerText = this.innerText;
		        document.getElementById('dropdown-menu').classList.add('hidden');
		        document.getElementById('dropdown-icon').style.transform = 'rotate(0deg)';
		        saveAdminSettings();
		    });
		});
		
		document.getElementById('dropdown-trigger').addEventListener('click', () => {
		    const menu = document.getElementById('dropdown-menu');
		    const icon = document.getElementById('dropdown-icon');
		    const isHidden = menu.classList.toggle('hidden');
		    icon.style.transform = isHidden ? 'rotate(0deg)' : 'rotate(180deg)';
		});
		
		window.addEventListener('click', (e) => {
		    const modelMenu = document.getElementById('dropdown-menu');
		    const modelIcon = document.getElementById('dropdown-icon');
		    if (!e.target.closest('#model-dropdown')) {
		        modelMenu.classList.add('hidden');
		        if (modelIcon) modelIcon.style.transform = 'rotate(0deg)';
		    }
		
		    const voiceMenu = document.getElementById('voice-menu');
		    const voiceIcon = document.getElementById('voice-icon');
		    if (!e.target.closest('#voice-trigger')) {
		        if (voiceMenu && !voiceMenu.classList.contains('hidden')) {
		            voiceMenu.classList.add('hidden');
		            if (voiceIcon) voiceIcon.style.transform = 'rotate(0deg)';
		        }
		    }
		});
		
		document.getElementById('settings-thinking').addEventListener('input', function() {
		    const labels = ["LOW", "MEDIUM", "HIGH"];
		    document.getElementById('label-thinking').innerText = labels[this.value - 1];
		    saveAdminSettings();
		});
		
		document.getElementById('settings-temp').addEventListener('input', function() {
		    document.getElementById('label-temp').innerText = this.value;
		    saveAdminSettings();
		});
		
		document.getElementById('settings-tokens').addEventListener('input', function() {
		    document.getElementById('label-tokens').innerText = this.value;
		    saveAdminSettings();
		});
		
		const voiceBtn = document.getElementById('voiceBtn');
		const voiceScreen = document.getElementById('voiceScreen');
		const backFromVoice = document.getElementById('backFromVoice');
		
		if (voiceBtn && voiceScreen) {
		    voiceBtn.addEventListener('click', () => {
		        voiceScreen.classList.remove('hidden');
		        voiceScreen.classList.add('flex');
		    });
		}
		
		if (backFromVoice && voiceScreen) {
		    backFromVoice.addEventListener('click', () => {
		        voiceScreen.classList.add('hidden');
		        voiceScreen.classList.remove('flex');
		    });
		}
						
		async function sendMessage(e) {
		    if (e) e.preventDefault();
		    if (isGenerating) {
		        if (abortController) abortController.abort();
		        setGeneratingState(false);
		        return;
		    }
		
		    const rawInput = userInput.value.trim();
		    if (!rawInput && pendingFiles.length === 0) return;
		
		    const filesToProcess = [...pendingFiles];
		    let fileMetadata = filesToProcess.map(f => ({ name: f.name, size: f.size }));
		    let fileCardsHTML = "";
		    filesToProcess.forEach(f => {
		        fileCardsHTML += getFileCardHTML(f.name, f.size);
		    });
		
		    const dynamicMainPrompt = document.getElementById('systemPromptInput').value || MAIN_SYSTEM_PROMPT;
		    const sliderVal = document.getElementById('settings-thinking').value;
		    const currentBudget = thinkingMap[sliderVal] || 16000;
		    const currentTemp = parseFloat(document.getElementById('settings-temp').value) || 1.0;
		    const currentMaxTokens = parseInt(document.getElementById('settings-tokens').value) || 65536;
		
		    const { data: { session } } = await _supabase.auth.getSession();
		    if (!session) return;
		    const userToken = session.access_token;
		
		    userInput.blur();
		    userInput.value = '';
		    userInput.style.height = 'auto';
		    userInput.disabled = true;
		    setGeneratingState(true);
		    abortController = new AbortController();
		
		    let apiParts = [];
		    let textContext = "";
		    pendingFiles = [];
		    renderPreviews();
		
		    for (const f of filesToProcess) {
		        const ext = f.name.split('.').pop().toLowerCase();
		        if (f.mime.startsWith('image/') || f.mime === 'application/pdf') {
		            const cleanBase64 = f.base64.includes(',') ? f.base64.split(',')[1] : f.base64;
		            apiParts.push({ inline_data: { mime_type: f.mime, data: cleanBase64 } });
		        } else {
		            textContext += await (['docx', 'xlsx', 'xls', 'pptx'].includes(ext) ? extractTextFromOffice(f) : readCodeFile(f));
		        }
		    }
		
		    const finalPrompt = rawInput + (textContext ? "\n\nKONTEKS DOKUMEN:\n" + textContext : "");
		    const userMessageParts = apiParts.length > 0 ? [...apiParts, { text: finalPrompt }] : [{ text: finalPrompt }];
		    
		    chatHistory.push({ role: "user", parts: userMessageParts, fileMetadata: fileMetadata });
		    
		    appendMessageToUI('user', rawInput, true, false, fileCardsHTML);
		    
		    saveCurrentSession();
		    showTyping();
		
		    const combinedSystemInstruction = `${dynamicMainPrompt}\n\n${IMAGE_GEN_PROMPT}\n\n${VIDEO_GEN_PROMPT}`;
		
		    try {
		        const payload = {
		            system_instruction: { parts: [{ text: combinedSystemInstruction }] },
		            contents: chatHistory.map(h => ({ role: h.role, parts: h.parts })),
		            tools: [{ google_search: {} }],
		            generation_config: { 
		                temperature: currentTemp,
		                max_output_tokens: currentMaxTokens 
		            }
		        };
		
		        if (currentSelectedModel.includes('think')) {
		            payload.thinking_config = { include_thoughts: true, thinking_budget_tokens: currentBudget };
		        }
		
		        const response = await fetch(PROXY_URL + `?model=${currentSelectedModel}&action=generateContent`, {
		            method: 'POST',
		            headers: {
		                'Content-Type': 'application/json',
		                'apikey': SUPABASE_KEY,
		                'Authorization': `Bearer ${userToken}`
		            },
		            signal: abortController.signal,
		            body: JSON.stringify(payload)
		        });
		
		        const data = await response.json();
		        if (!response.ok) throw new Error(data.error?.message || `HTTP ${response.status}`);
		        
		        const parts = data.candidates?.[0]?.content?.parts || [];
		        let finalResponse = "";
		        parts.forEach(part => { if (part.text && !part.thought) finalResponse += part.text; });
		        
		        hideTyping();
		        
		        if (finalResponse) {
		            const mediaSplitRegex = /(\[image\][\s\S]*?\[\/image\]|\[youtube\][\s\S]*?\[\/youtube\])/gi;
		            const resParts = finalResponse.split(mediaSplitRegex);
		            const aiContainerTop = appendMessageToUI('model', "");
		            let currentProseEl = aiContainerTop;
		            const messageBody = aiContainerTop.parentElement;
		            let proseUsed = false;
		            
		            chatHistory.push({ role: "model", parts: [{ text: "" }] });
		            
		            for (let i = 0; i < resParts.length; i++) {
		                if (!isGenerating) break;
		                const part = resParts[i];
		                if (!part.trim()) continue;
		                
		                const imgMatch = part.match(/\[image\]([\s\S]*?)\[\/image\]/i);
		                const vidMatch = part.match(/\[youtube\]([\s\S]*?)\[\/youtube\]/i);
		                
		                if (imgMatch) {
		                    const mediaDiv = document.createElement('div');
		                    mediaDiv.className = "media-container w-full flex flex-col";
		                    messageBody.appendChild(mediaDiv);
		                    await generateImage(imgMatch[1].trim(), mediaDiv);
		                } else if (vidMatch) {
		                    const mediaDiv = document.createElement('div');
		                    mediaDiv.className = "media-container w-full flex flex-col";
		                    messageBody.appendChild(mediaDiv);
		                    await generateYoutubeVideo(vidMatch[1].trim(), mediaDiv);
		                } else {
		                    if (i > 0) {
		                        const div = document.createElement('div');
		                        div.className = "w-full prose-container prose max-w-none text-slate-600 text-[15px] leading-relaxed font-medium";
		                        messageBody.appendChild(div);
		                        currentProseEl = div;
		                    }
		                    const streamedText = await streamText(currentProseEl, part);
		                    if (streamedText) {
		                        proseUsed = true;
		                        const lastMsg = chatHistory[chatHistory.length - 1];
		                        lastMsg.parts[0].text += (lastMsg.parts[0].text ? "\n\n" : "") + streamedText;
		                        saveCurrentSession();
		                    }
		                }
		            }
		            if (!proseUsed && aiContainerTop) aiContainerTop.remove();
		
		            if (chatHistory.length === 2) {
		                const userText = chatHistory[0].parts.find(p => p.text)?.text.split("\n\nKONTEKS DOKUMEN:")[0] || "File Lampiran";
		                const aiText = chatHistory[1].parts[0].text;
		                const newTitle = await generateAiTitle(userText, aiText);
		                const sessions = getAllSessions();
		                const idx = sessions.findIndex(s => s.id === currentSessionId);
		                if (idx >= 0) {
		                    sessions[idx].title = newTitle;
		                    localStorage.setItem(STORAGE_KEY, JSON.stringify(sessions));
		                    loadSidebarHistory();
		                }
		            }
		        }
		    } catch (error) {
		        hideTyping();
		        if (error.name !== 'AbortError') {
		            appendMessageToUI('error', "Gagal menghubungi AI. Silakan coba lagi.");
		        }
		    } finally {
		        setGeneratingState(false);
		        userInput.disabled = false;
		        abortController = null;
		    }
		}
		
		async function generateAiTitle(userMsg, aiMsg) {
		    const { data: { session } } = await _supabase.auth.getSession();
		    if (!session) return "Percakapan Baru";
		    try {
		        const response = await fetch(PROXY_URL + "?model=gemini-2.5-flash-lite&action=generateContent", {
		            method: 'POST',
		            headers: {
		                'Content-Type': 'application/json',
		                'apikey': SUPABASE_KEY,
		                'Authorization': `Bearer ${session.access_token}`
		            },
		            body: JSON.stringify({
		                contents: [{
		                    role: "user",
		                    parts: [{ 
		                        text: `Buat judul singkat (2-4 kata) sesuai dengan konteks pembicaraan. Tanpa tanda petik atau kata 'Percakapan'.\n\nUser: ${userMsg}\nAI: ${aiMsg}` 
		                    }]
		                }],
		                generation_config: { temperature: 0.6, max_output_tokens: 20 }
		            })
		        });
		        const data = await response.json();
		        const generatedTitle = data.candidates?.[0]?.content?.parts?.[0]?.text;
		        return generatedTitle ? generatedTitle.replace(/["'*./]/g, '').trim() : userMsg.substring(0, 30);
		    } catch (e) {
		        return userMsg.substring(0, 30);
		    }
		}

		function initDB() {
			return new Promise((resolve, reject) => {
				if (dbInstance) return resolve(dbInstance);
				const request = indexedDB.open(DB_NAME, DB_VERSION);
				request.onupgradeneeded = (event) => {
					const db = event.target.result;
					if (!db.objectStoreNames.contains(STORE_NAME)) {
						db.createObjectStore(STORE_NAME, { keyPath: "id" });
					}
				};
				request.onsuccess = (event) => {
					dbInstance = event.target.result;
					resolve(dbInstance);
				};
				request.onerror = (event) => reject("DB Error: " + event.target.error);
			});
		}

		async function saveImageToIDB(id, blob) {
			const db = await initDB();
			return new Promise((resolve, reject) => {
				const tx = db.transaction(STORE_NAME, "readwrite");
				const store = tx.objectStore(STORE_NAME);
				const request = store.put({ id, blob, timestamp: Date.now() });
				request.onsuccess = () => resolve(id);
				request.onerror = () => reject(request.error);
			});
		}

		async function getImageFromIDB(id) {
			const db = await initDB();
			return new Promise((resolve, reject) => {
				const tx = db.transaction(STORE_NAME, "readonly");
				const store = tx.objectStore(STORE_NAME);
				const request = store.get(id);
				request.onsuccess = (e) => {
					resolve(e.target.result ? e.target.result.blob : null);
				};
				request.onerror = () => resolve(null);
			});
		}

		async function deleteImageFromIDB(id) {
			const db = await initDB();
			return new Promise((resolve, reject) => {
				const tx = db.transaction(STORE_NAME, "readwrite");
				const store = tx.objectStore(STORE_NAME);
				store.delete(id);
				tx.oncomplete = () => resolve();
			});
		}

		lucide.createIcons();
		
		marked.setOptions({
			gfm: true,
			breaks: true,
			headerIds: false,
			mangle: false
		});

		function showApp() {
			loginScreen.style.display = 'none';
			appInterface.style.display = 'flex';

			requestAnimationFrame(() => {
				chatContainer.scrollTop = chatContainer.scrollHeight;
				requestAnimationFrame(() => {
					chatContainer.scrollTop = chatContainer.scrollHeight;
				});
			});
		}

		function scrollBottom(force = false, behavior = 'auto') {
			if (!chatContainer) return;

			if (behavior === 'auto') {
				chatContainer.scrollTop = chatContainer.scrollHeight;
			} else {
				chatContainer.scrollTo({
					top: chatContainer.scrollHeight,
					behavior: behavior
				});
			}
		}

		loginForm.addEventListener('submit', async (e) => {
		    e.preventDefault();
		    const btn = document.getElementById('loginBtn');
		    const errorEl = document.getElementById('loginError');
		    const originalText = btn.innerHTML;
		
		    btn.disabled = true;
		    btn.innerHTML = `<svg class="animate-spin h-5 w-5 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
		    errorEl.classList.add('hidden');
		
		    try {
		        const { error } = await _supabase.auth.signInWithPassword({
		            email: emailInput.value,
		            password: passwordInput.value
		        });
		
		        if (error) throw error;
		
		        setTimeout(() => {
		            sidebarEmail.innerText = emailInput.value;
		            showApp();
		        }, 2000);
		    } catch (err) {
		        errorEl.innerText = err.message === "Invalid login credentials" ? "EMAIL ATAU PASSWORD SALAH" : err.message.toUpperCase();
		        errorEl.classList.remove('hidden');
		        btn.disabled = false;
		        btn.innerHTML = originalText;
		    }
		});

		function renderHistory() {
		    messagesArea.innerHTML = '';
		    chatHistory.forEach(msg => {
		        const role = msg.role === 'user' ? 'user' : 'model';
		        let textToShow = "";
		        let cardsHTML = "";
		
		        if (msg.role === 'user') {
		            const textPart = msg.parts.find(p => p.text);
		            if (textPart) {
		                textToShow = textPart.text.split("\n\nKONTEKS DOKUMEN:")[0].trim();
		            }
		            if (msg.fileMetadata) {
		                msg.fileMetadata.forEach(f => {
		                    cardsHTML += getFileCardHTML(f.name, f.size);
		                });
		            }
		        } else {
		            textToShow = msg.parts[0].text;
		        }
		
		        appendMessageToUI(role, textToShow, false, false, cardsHTML);
		    });
		}

		function saveCurrentSession() {
		    try {
		        const sessions = getAllSessions();
		        const existingIndex = sessions.findIndex(s => s.id === currentSessionId);
		        
		        let title = "Percakapan Baru";
		        
		        if (existingIndex >= 0 && sessions[existingIndex].title && sessions[existingIndex].title !== "Percakapan Baru") {
		            const oldTitle = sessions[existingIndex].title;
		            const firstMsg = chatHistory[0]?.parts.find(p => p.text)?.text.split("\n\nKONTEKS DOKUMEN:")[0] || "";
		            const defaultTitleFallback = firstMsg.substring(0, 30);
		            
		            if (oldTitle !== defaultTitleFallback && oldTitle !== "Lampiran Dokumen") {
		                title = oldTitle;
		            } else {
		                const userText = firstMsg.trim();
		                if (userText) title = userText.substring(0, 30) + (userText.length > 30 ? "..." : "");
		                else if (chatHistory[0]?.fileMetadata) title = "Lampiran Dokumen";
		            }
		        } else {
		            const firstUserMsg = chatHistory.find(m => m.role === 'user');
		            if (firstUserMsg && firstUserMsg.parts) {
		                const textPart = firstUserMsg.parts.find(p => p.text);
		                if (textPart) {
		                    let cleanTitle = textPart.text.split("\n\nKONTEKS DOKUMEN:")[0].trim();
		                    if (!cleanTitle) cleanTitle = "Lampiran Dokumen";
		                    title = cleanTitle.substring(0, 30) + (cleanTitle.length > 30 ? "..." : "");
		                }
		            }
		        }
		
		        const cleanedHistory = chatHistory.map(msg => ({
		            role: msg.role,
		            fileMetadata: msg.fileMetadata || null,
		            parts: msg.parts.map(part => {
		                if (part.inline_data || part.data) return { text: "" };
		                return part;
		            })
		        }));
		
		        const sessionData = {
		            id: currentSessionId,
		            title: title,
		            timestamp: existingIndex >= 0 ? sessions[existingIndex].timestamp : Date.now(),
		            history: cleanedHistory
		        };
		
		        if (existingIndex >= 0) sessions[existingIndex] = sessionData;
		        else sessions.unshift(sessionData);
		
		        localStorage.setItem(STORAGE_KEY, JSON.stringify(sessions));
		        loadSidebarHistory();
		    } catch (e) {
		        console.error("Save Error", e);
		    }
		}

		userInput.addEventListener('input', function () {
			this.style.height = 'auto';
			const newHeight = Math.min(this.scrollHeight, 150);
			this.style.height = newHeight + 'px';

			const wrapper = document.getElementById('inputWrapper');
			if (this.scrollHeight > 50) {
				wrapper.classList.remove('rounded-full');
				wrapper.classList.add('rounded-[24px]');
			} else {
				wrapper.classList.remove('rounded-[24px]');
				wrapper.classList.add('rounded-full');
			}

			this.style.overflowY = this.scrollHeight > 150 ? 'auto' : 'hidden';
		});

		userInput.addEventListener('blur', () => {
		    window.scrollTo(0, 0);
		});
		
		if (window.visualViewport) {
		    window.visualViewport.addEventListener('resize', () => {
		        if (document.activeElement.tagName === 'TEXTAREA' && !sidebar.classList.contains('-translate-x-full') === false) {
		            requestAnimationFrame(() => {
		                scrollBottom(true, 'auto');
		                chatContainer.style.display = 'none';
		                chatContainer.offsetHeight; 
		                chatContainer.style.display = 'block';
		            });
		        }
		    });
		}

		userInput.addEventListener('keydown', function (e) {
			if (e.key === 'Enter' && !e.shiftKey) {
				e.preventDefault();
				if (!isGenerating && this.value.trim()) {
					sendMessage();
				}
			}
		});
		
		window.addEventListener('resize', () => {
		    const screen = document.getElementById('voiceScreen');
		    const box = document.getElementById('voice-visual-box');
		    
		    if (screen && !screen.classList.contains('hidden')) {
		        box.style.transition = 'none';
		        box.style.opacity = '0';
		        
		        clearTimeout(window.voiceResizeTimeout);
		        window.voiceResizeTimeout = setTimeout(() => {
		            resizeVoiceCanvas();
		            requestAnimationFrame(() => {
		                requestAnimationFrame(() => {
		                    box.style.transition = 'opacity 0.4s ease-in-out';
		                    box.style.opacity = '1';
		                });
		            });
		        }, 1100);
		    }
		});

		function getFileCardHTML(name, size) {
		    const ext = name.split('.').pop().toLowerCase();
		    const visual = getFileIcon(ext);
		    return `
		        <div class="bg-gray-100 rounded-2xl p-3 flex items-center gap-2 relative w-full min-h-[64px] border-none animate-in fade-in slide-in-from-bottom-1">
		            <div class="w-10 h-10 flex-none flex items-center justify-center overflow-hidden shrink-0">${visual}</div>
		            <div class="flex-1 flex flex-col justify-center min-w-0 h-10">
		                <p class="text-[12px] font-bold text-gray-700 truncate leading-none mb-1 m-0 p-0">${name}</p>
		                <p class="text-[10px] text-gray-400 font-medium leading-none m-0 p-0">${size}</p>
		            </div>
		        </div>`;
		}

		function appendMessageToUI(role, text, animate = true, isRawHtml = false, fileCardsHTML = "") {
		    const isUser = role === 'user';
		    const isError = role === 'error';
		    const timeStr = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
		    const nameLabel = isUser ? 'ANDA' : (isError ? 'SYSTEM ERROR' : 'ALISA');
		    const nameColorClass = isUser ? 'text-slate-600' : (isError ? 'text-red-600' : 'text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-cyan-500');
		
		    const div = document.createElement('div');
		    div.className = `w-full ${animate ? 'animate-in fade-in slide-in-from-bottom-2 duration-300' : ''} mb-2`;
		
		    div.innerHTML = `
		        <div class="w-full bg-slate-50 rounded-2xl p-4 ${!isUser && !isError ? 'pb-6' : ''} shadow-sm border-none group relative">
		            <div class="flex justify-between items-center border-b border-slate-100 pb-1 mb-0.5">
		                <span class="text-xs font-black ${nameColorClass} uppercase tracking-widest">${nameLabel}</span>
		                <span class="text-xs font-bold text-slate-300 uppercase">${timeStr}</span>
		            </div>
		            <div class="w-full prose-container prose max-w-none text-slate-600 text-[15px] leading-relaxed font-medium">
		                ${isError ? `<div class="text-red-600 text-xs font-mono whitespace-pre-wrap">${text}</div>` : (isRawHtml ? text : parseMessageText(text))}
		            </div>
		            <div class="user-file-cards grid grid-cols-2 md:grid-cols-4 gap-2 empty:hidden mt-3">${fileCardsHTML}</div>
		            <div class="media-container w-full mt-2 empty:hidden gap-3 flex flex-col"></div>
		            <div class="prose-container-bottom w-full prose prose-container max-w-none text-slate-600 text-[15px] leading-relaxed font-medium mt-4 empty:hidden"></div>
		            ${!isUser && !isError ? `
		                <button class="copy-btn absolute bottom-2 right-2 p-1 text-slate-400 hover:text-slate-600 rounded-md opacity-0 group-hover:opacity-100 transition-opacity" title="Salin pesan">
		                    <i data-lucide="copy" class="w-3 h-3"></i>
		                </button>
		            ` : ''}
		        </div>
		    `;
		
		    messagesArea.appendChild(div);
		    lucide.createIcons();
		    if (window.hljs) div.querySelectorAll('pre code').forEach(hljs.highlightElement);
		    if (animate) scrollBottom(true, 'auto');
		    resolveIdbImages(div, animate);
		
		    return div.querySelector('.prose-container');
		}

		function resolveIdbImages(container, animate = false) {
			container.querySelectorAll('img').forEach(async (img) => {
				const src = img.getAttribute('src');
				if (src && src.startsWith('idb://')) {
					const id = src.replace('idb://', '');
					try {
						const blob = await getImageFromIDB(id);
						if (blob) {
							const url = URL.createObjectURL(blob);
							img.src = url;
							img.onload = () => {
								if (animate) scrollBottom(true, 'auto');
							};
						} else {
						}
					} catch (e) {
						console.error("IDB Image Load Error", e);
					}
				}
			});
		}

		async function streamText(element, text) {
			let cursor = 0;
			while (cursor < text.length) {
				if (!isGenerating) break;
				cursor += STREAM_CHUNK_SIZE;
				element.innerHTML = parseMessageText(text.substring(0, cursor));
				scrollBottom(true, 'auto');
				await new Promise(resolve => setTimeout(resolve, STREAM_SPEED));
			}
			let finalText = text.substring(0, cursor);
			if (isGenerating) {
				finalText = text;
				element.innerHTML = parseMessageText(text);
			}
			if (window.hljs) element.querySelectorAll('pre code').forEach(hljs.highlightElement);
			lucide.createIcons();
			scrollBottom(true, 'auto');
			return finalText;
		}

		function getYoutubeEmbedHTML(videoId) {
			return `
				<div class="relative w-full my-4 rounded-xl overflow-hidden border border-slate-100 shadow-sm aspect-video bg-black">
					<iframe
						width="100%"
						height="100%"
						src="https://www.youtube.com/embed/${videoId}"
						title="YouTube video player"
						frameborder="0"
						allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
						referrerpolicy="strict-origin-when-cross-origin"
						allowfullscreen>
					</iframe>
				</div>`;
		}

		function parseMessageText(text) {
			text = text.replace(/<div class="relative.*?src=".*?\/embed\/([a-zA-Z0-9_-]+)".*?<\/div>/g, '\n\n[VIDEO_EMBED:$1]\n\n');
			const videos = [];
			text = text.replace(/\[VIDEO_EMBED:([a-zA-Z0-9_-]+)\]/g, (match, id) => {
				videos.push(id);
				return `!!!VIDEO_PLACEHOLDER_${videos.length - 1}!!!`;
			});
			let html = marked.parse(text);
			videos.forEach((id, index) => {
				html = html.replace(new RegExp(`!!!VIDEO_PLACEHOLDER_${index}!!!`, 'g'), getYoutubeEmbedHTML(id));
				html = html.replace(new RegExp(`<p>!!!VIDEO_PLACEHOLDER_${index}!!!</p>`, 'g'), getYoutubeEmbedHTML(id));
			});

			return html;
		}

		function showTyping() {
			const timeStr = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
			typingBubble = document.createElement('div');
			typingBubble.className = "w-full animate-in fade-in slide-in-from-bottom-2 duration-300 mb-2";
			typingBubble.innerHTML = `
		        <div class="w-full bg-slate-50 rounded-2xl p-4 shadow-sm border-none">
		            <div class="flex justify-between items-center border-b border-slate-100 pb-1 mb-0.5">
		                <span class="text-xs font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-cyan-500 uppercase tracking-widest">ALISA</span>
		                <span class="text-xs font-bold text-slate-300 uppercase">${timeStr}</span>
		            </div>
		            <div class="typing-indicator">
						<span class="text-[13px] font-medium text-slate-400">Thinking</span>
		                <div class="typing-dot !w-1 !h-1 mt-1"></div>
		                <div class="typing-dot !w-1 !h-1 mt-1"></div>
		                <div class="typing-dot !w-1 !h-1 mt-1"></div>
		            </div>
		        </div>
		    `;
			messagesArea.appendChild(typingBubble);
			scrollBottom(true, 'auto');
		}

		function hideTyping() {
			if (typingBubble) {
				typingBubble.remove();
				typingBubble = null;
			}
		}

		function setGeneratingState(state) {
			isGenerating = state;
			if (state) {
				sendBtn.innerHTML = '<i data-lucide="square" class="w-4 h-4 text-red-500" fill="currentColor"></i>';
				sendBtn.className = 'p-2.5 bg-slate-100 text-red-500 rounded-full shrink-0 flex items-center justify-center min-w-[40px] h-[40px] hover:bg-slate-200 transition-colors';
			} else {
				sendBtn.innerHTML = '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="currentColor"><path d="M21.66,12a2,2,0,0,1-1.14,1.81L5.87,20.75A2.08,2.08,0,0,1,5,21a2,2,0,0,1-1.82-2.82L5.46,13H11a1,1,0,0,0,0-2H5.46L3.18,5.87A2,2,0,0,1,5.86,3.25h0l14.65,6.94A2,2,0,0,1,21.66,12Z"></path></svg>';
				sendBtn.className = 'p-2 text-slate-800 hover:text-indigo-600 transition-colors shrink-0';
			}
			lucide.createIcons();
		}
		
		function formatBytes(bytes, decimals = 2) {
		    if (bytes === 0) return '0 Bytes';
		    const k = 1024;
		    const dm = decimals < 0 ? 0 : decimals;
		    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
		    const i = Math.floor(Math.log(bytes) / Math.log(k));
		    return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
		}
		
		function getFileIcon(extension) {
		    const icons = {
		        'pdf': 'pdf-file-icon.svg',
		        'docx': 'docx-file-icon.svg',
		        'xlsx': 'excel-file-icon.svg',
		        'xls': 'excel-file-icon.svg',
		        'pptx': 'ppt-file-icon.svg',
		        'js': 'javascript-file-icon.svg',
		        'css': 'css-file-icon.svg',
		        'java': 'java-file-icon.svg',
		        'html': 'html-file-icon.svg',
		        'xml': 'xml-file-icon.svg',
		        'py': 'python-file-icon.svg',
		        'sql': 'sql-file-icon.svg',
		        'ts': 'typescript-file-icon.svg',
		        'lua': 'lua-file-icon.svg',
		        'cpp': 'cpp-file-icon.svg',
		        'h': 'cpp-file-icon.svg',
		        'hpp': 'cpp-file-icon.svg',
		        'swift': 'swift-file-icon.svg',
		        'jpg': 'image-file-icon.svg',
		        'jpeg': 'image-file-icon.svg',
		        'png': 'image-file-icon.svg',
		        'gif': 'image-file-icon.svg',
		        'webp': 'image-file-icon.svg',
		        'heic': 'image-file-icon.svg',
		        'heif': 'image-file-icon.svg'
		    };
		    const iconFile = icons[extension] || 'default-file-icon.svg';
		    return `<img src="icon/${iconFile}" class="w-7 h-7 object-contain">`;
		}
		
		function convertToBase64(file) {
		    return new Promise((resolve, reject) => {
		        const reader = new FileReader();
		        reader.readAsDataURL(file);
		        reader.onload = () => resolve(reader.result);
		        reader.onerror = error => reject(error);
		    });
		}
		
		async function extractTextFromOffice(file) {
		    const ext = file.name.split('.').pop().toLowerCase();
		    try {
		        if (ext === 'docx') {
		            const ab = await file.rawFile.arrayBuffer();
		            const res = await mammoth.extractRawText({ arrayBuffer: ab });
		            return `\n[FILE WORD: ${file.name}]\n${res.value}\n`;
		        }
		        if (['xlsx', 'xls'].includes(ext)) {
		            const ab = await file.rawFile.arrayBuffer();
		            const wb = XLSX.read(ab, { type: 'array' });
		            const text = wb.SheetNames.map(n => `\n-- Sheet: ${n} --\n${XLSX.utils.sheet_to_csv(wb.Sheets[n])}`).join('');
		            return `\n[FILE EXCEL: ${file.name}]\n${text}\n`;
		        }
		        if (ext === 'pptx') {
		            const zip = new JSZip();
		            const content = await zip.loadAsync(file.rawFile);
		            let text = `\n[FILE POWERPOINT: ${file.name}]\n`;
		            const slides = Object.keys(content.files).filter(n => n.startsWith("ppt/slides/slide") && n.endsWith(".xml")).sort();
		            for (const f of slides) {
		                const xml = await content.files[f].async("text");
		                const nodes = new DOMParser().parseFromString(xml, "text/xml").getElementsByTagName("a:t");
		                text += `\n[SLIDE]\n${Array.from(nodes).map(n => n.textContent).join(" ")}\n`;
		            }
		            return text;
		        }
		    } catch (e) { return `\n[Gagal membaca ${file.name}]\n`; }
		    return '';
		}
		
		async function readCodeFile(file) {
		    try {
		        const text = await file.rawFile.text();
		        return `\n[ISI FILE ${file.name.toUpperCase()}]:\n${text}\n`;
		    } catch (e) { return `\n[Gagal membaca isi file ${file.name}]\n`; }
		}
		
		async function handleFileSelect(event) {
		    const files = Array.from(event.target.files);
		    if (!files.length) return;
		    if (pendingFiles.length + files.length > 4) {
		        alert("Maksimal 4 file dalam satu pengiriman.");
		        event.target.value = '';
		        return;
		    }
		    try {
		        for (const file of files) {
		            const base64 = await convertToBase64(file);
		            let mimeType = file.type || '';
		            const ext = file.name ? file.name.split('.').pop().toLowerCase() : '';
		            if (!mimeType && ['jpg', 'jpeg', 'png', 'gif', 'webp', 'heic', 'heif'].includes(ext)) {
		                mimeType = 'image/jpeg';
		            }
		            pendingFiles.push({
		                name: file.name || "File",
		                size: formatBytes(file.size),
		                type: mimeType,
		                base64: base64.split(',')[1],
		                mime: mimeType,
		                rawFile: file
		            });
		        }
		    } catch (e) {
		        console.error(e);
		    } finally {
		        renderPreviews();
		        event.target.value = '';
		    }
		}
		
		function renderPreviews() {
		    const container = document.getElementById('file-preview-container');
		    if (!container) return;
		    container.innerHTML = '';
		    pendingFiles.forEach((file, index) => {
		        const ext = file.name ? file.name.split('.').pop().toLowerCase() : '';
		        const isImage = (file.type && typeof file.type === 'string' && file.type.startsWith('image/')) || 
		                        ['jpg', 'jpeg', 'png', 'gif', 'webp', 'heic', 'heif'].includes(ext);
		        const visual = isImage 
		            ? `<img src="data:${file.mime || 'image/jpeg'};base64,${file.base64}" class="w-full h-full object-cover rounded-lg">` 
		            : getFileIcon(ext);
		        const card = document.createElement('div');
		        card.className = "bg-gray-100 rounded-2xl p-3 flex items-center gap-2 relative w-full min-h-[64px] border-none";
		        card.innerHTML = `
		            <div class="w-10 h-10 flex-none flex items-center justify-center overflow-hidden shrink-0">${visual}</div>
		            <div class="flex-1 flex flex-col justify-center min-w-0 h-10">
		                <p class="text-[12px] font-bold text-gray-700 truncate leading-none mb-1 m-0 p-0">${file.name}</p>
		                <p class="text-[10px] text-gray-400 font-medium leading-none m-0 p-0">${file.size}</p>
		            </div>
		            <button onclick="removeFile(${index})" class="absolute -top-3 -right-3 w-7 h-7 flex items-center justify-center border-none p-0 cursor-pointer outline-none bg-transparent">
		                <svg fill="#d1d5db" viewBox="0 0 24 24" class="w-full h-full"><path d="M12 4c-4.419 0-8 3.582-8 8s3.581 8 8 8 8-3.582 8-8-3.581-8-8-8zm3.707 10.293c.391.391.391 1.023 0 1.414-.195.195-.451.293-.707.293s-.512-.098-.707-.293l-2.293-2.293-2.293 2.293c-.195.195-.451.293-.707.293s-.512-.098-.707-.293c-.391-.391-.391-1.023 0-1.414l2.293-2.293-2.293-2.293c-.391-.391-.391-1.023 0-1.414s1.023-.391 1.414 0l2.293 2.293 2.293-2.293c.391-.391 1.023-.391 1.414 0s.391 1.023 0 1.414l-2.293 2.293 2.293 2.293z"></path></svg>
		            </button>`;
		        container.appendChild(card);
		    });
		}
		
		function removeFile(index) {
		    pendingFiles.splice(index, 1);
		    renderPreviews();
		}

		async function generateImage(prompt, targetContainer = null) {
			const { data: { session } } = await _supabase.auth.getSession();
			if (!session) return;

			const userToken = session.access_token;
			let loaderId = `loader-${Date.now()}`;
			if (targetContainer) {
				const loaderHTML = `
				    <div id="${loaderId}" class="mt-2 flex items-center gap-1.5 animate-in fade-in duration-300">
				        <i data-lucide="loader-2" class="w-3.5 h-3.5 animate-spin text-blue-600"></i>
				        <span class="text-[13px] font-medium text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-cyan-500">Membuat Gambar</span>
				        <div class="flex gap-0.5 items-center pt-1">
				            <span class="w-1 h-1 bg-blue-400 rounded-full animate-bounce"></span>
				            <span class="w-1 h-1 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></span>
				            <span class="w-1 h-1 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
				        </div>
				    </div>
				`;
				targetContainer.insertAdjacentHTML('beforeend', loaderHTML);
				lucide.createIcons();
				scrollBottom(true, 'auto');
			} else {
				showTyping();
			}

			const response = await fetch(PROXY_URL + `?model=${IMAGE_MODEL_NAME}&action=generateContent`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'apikey': SUPABASE_KEY,
					'Authorization': `Bearer ${userToken}`
				},
				signal: abortController.signal,
				body: JSON.stringify({
					contents: [{ role: "user", parts: [{ text: prompt }] }],
					generationConfig: {
						response_modalities: ["IMAGE"]
					}
				})
			});

			const data = await response.json();
			if (!response.ok) throw new Error(data.error?.message || `HTTP ${response.status}`);

			let base64Image = null;
			let mimeType = "image/jpeg";
			const parts = data.candidates?.[0]?.content?.parts || [];
			const imagePart = parts.find(p => p.inlineData);

			if (imagePart) {
				base64Image = imagePart.inlineData.data;
				mimeType = imagePart.inlineData.mimeType || mimeType;
			} else {
				throw new Error("No image data found in response.");
			}

			const fileName = `sinta_gen_${Date.now()}`;
			let imageUrl = `idb://${fileName}`;

			try {
				const byteCharacters = atob(base64Image);
				const byteNumbers = new Array(byteCharacters.length);
				for (let i = 0; i < byteCharacters.length; i++) {
					byteNumbers[i] = byteCharacters.charCodeAt(i);
				}
				const byteArray = new Uint8Array(byteNumbers);
				const blob = new Blob([byteArray], { type: mimeType });
				await saveImageToIDB(fileName, blob);
			} catch (writeError) {
				imageUrl = `data:${mimeType};base64,${base64Image}`;
			}

			hideTyping();
			const imageHTML = `<div class="relative w-full my-4 rounded-xl overflow-hidden border border-slate-100 shadow-sm group"><img src="${imageUrl}" alt="Generated Image" class="w-full h-auto block"><button onclick="downloadImageFromBtn(this, event)" class="absolute top-1 right-1 p-1 bg-black/50 hover:bg-black/70 rounded-full text-white backdrop-blur-sm transition-all opacity-0 group-hover:opacity-100 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-down-to-line"><path d="M12 17V3"/><path d="m6 11 6 6 6-6"/><path d="M19 21H5"/></svg></button></div>`;

			if (targetContainer) {
				const loader = document.getElementById(loaderId);
				if (loader) loader.outerHTML = imageHTML;
				else targetContainer.insertAdjacentHTML('beforeend', imageHTML);
				resolveIdbImages(targetContainer, true);
				if (isGenerating) {
					const lastMsgIndex = chatHistory.findLastIndex(m => m.role === 'model');
					if (lastMsgIndex !== -1) {
						chatHistory[lastMsgIndex].parts[0].text += `\n${imageHTML}`;
						saveCurrentSession();
					}
				}
			} else {
				const container = appendMessageToUI('model', imageHTML, true, true);
				if (isGenerating) {
					chatHistory.push({ role: "model", parts: [{ text: imageHTML }] });
					saveCurrentSession();
				}
			}
			scrollBottom(true, 'auto');
		}

		async function generateYoutubeVideo(query, targetContainer = null) {
			const { data: { session } } = await _supabase.auth.getSession();
			if (!session) return;

			const userToken = session.access_token;
			let loaderId = `vid-loader-${Date.now()}`;

			if (targetContainer) {
				const loaderHTML = `
				    <div id="${loaderId}" class="mt-2 flex items-center gap-1.5 animate-in fade-in duration-300">
				        <i data-lucide="loader-2" class="w-3.5 h-3.5 animate-spin text-blue-600"></i>
				        <span class="text-[13px] font-medium text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-cyan-500">Mencari Youtube Video</span>
				        <div class="flex gap-0.5 items-center pt-1">
				            <span class="w-1 h-1 bg-blue-400 rounded-full animate-bounce"></span>
				            <span class="w-1 h-1 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></span>
				            <span class="w-1 h-1 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
				        </div>
				    </div>
				`;
				targetContainer.insertAdjacentHTML('beforeend', loaderHTML);
				lucide.createIcons();
				scrollBottom(true, 'auto');
			}

			try {
				const response = await fetch(YOUTUBE_PROXY_URL, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'apikey': SUPABASE_KEY,
						'Authorization': `Bearer ${userToken}`
					},
					body: JSON.stringify({ query: query })
				});

				const data = await response.json();
				if (!response.ok) {
					const errorMsg = (typeof data.error === 'object' && data.error !== null)
						? (data.error.message || JSON.stringify(data.error))
						: (data.error || 'Failed to fetch video');
					throw new Error(errorMsg);
				}

				const items = data.items || [];
				let videoHTML = '';
				var videoToken = '';

				if (items.length > 0) {
					const videoId = items[0].id.videoId;
					videoHTML = getYoutubeEmbedHTML(videoId);
					videoToken = `\n\n[VIDEO_EMBED:${videoId}]\n\n`;
				} else {
					videoHTML = `<div class="mt-2 text-xs text-red-500 font-bold bg-red-50 p-2 rounded-lg border border-red-100">Video tidak ditemukan.</div>`;
					videoToken = videoHTML;
				}

				if (targetContainer) {
					const loader = document.getElementById(loaderId);
					if (loader) loader.outerHTML = videoHTML;
					else targetContainer.insertAdjacentHTML('beforeend', videoHTML);

					if (isGenerating) {
						const lastMsgIndex = chatHistory.findLastIndex(m => m.role === 'model');
						if (lastMsgIndex !== -1) {
							chatHistory[lastMsgIndex].parts[0].text += videoToken;
							saveCurrentSession();
						}
					}
				} else {
					if (isGenerating) {
						chatHistory.push({ role: "model", parts: [{ text: videoToken }] });
						saveCurrentSession();
					}
				}
				scrollBottom(true, 'auto');

			} catch (error) {
				console.error("Youtube Error:", error);
				if (targetContainer) {
					const loader = document.getElementById(loaderId);
					if (loader) loader.innerHTML = `<span class="text-red-500">Gagal memuat video: ${error.message}</span>`;
				}
			}
		}
		
		async function uploadImageToSupabase(base64Data, fileName, mimeType) {
			const byteCharacters = atob(base64Data);
			const byteNumbers = new Array(byteCharacters.length);
			for (let i = 0; i < byteCharacters.length; i++) {
				byteNumbers[i] = byteCharacters.charCodeAt(i);
			}
			const byteArray = new Uint8Array(byteNumbers);
			const blob = new Blob([byteArray], { type: mimeType });
			const filePath = `ai_generated/${fileName}`;

			const { data, error } = await _supabase.storage
				.from('aura_media')
				.upload(filePath, blob, {
					contentType: mimeType,
					upsert: false
				});

			if (error) throw error;

			const { data: { publicUrl } } = _supabase.storage
				.from('aura_media')
				.getPublicUrl(filePath);

			return publicUrl;
		}

		sendBtn.addEventListener('pointerdown', (e) => {
			if (isGenerating || userInput.value.trim()) {
				e.preventDefault();
				sendMessage(e);
			}
		});

		chatForm.addEventListener('submit', (e) => {
			e.preventDefault();
			sendMessage(e);
		});



		const sidebarLogoutBtn = document.getElementById('sidebarLogoutBtn');
		if (sidebarLogoutBtn) {
			sidebarLogoutBtn.addEventListener('click', async () => {
				if (confirm("Keluar dari akun?")) {
					const { error } = await _supabase.auth.signOut();
					if (!error) {
						localStorage.removeItem(STORAGE_KEY);
						localStorage.removeItem(ACTIVE_SESSION_KEY);
						location.reload();
					}
				}
			});
		}

		document.addEventListener('touchstart', function (event) {
			if (event.touches.length > 1) {
				event.preventDefault();
			}
		}, { passive: false });

		let lastTouchEnd = 0;
		document.addEventListener('touchend', function (event) {
			const now = (new Date()).getTime();
			if (now - lastTouchEnd <= 300) {
				event.preventDefault();
			}
			lastTouchEnd = now;
		}, false);

		document.addEventListener('gesturestart', function (event) {
			event.preventDefault();
		});

		function toggleSidebar(show) {
		    if (show) {
		        if (document.activeElement && (document.activeElement.tagName === 'TEXTAREA' || document.activeElement.tagName === 'INPUT')) {
		            document.activeElement.blur();
		        }
		        
		        sidebar.classList.remove('-translate-x-full');
		        overlay.classList.remove('hidden');
		        setTimeout(() => overlay.classList.remove('opacity-0'), 10);
		    } else {
		        sidebar.classList.add('-translate-x-full');
		        overlay.classList.add('opacity-0');
		        setTimeout(() => overlay.classList.add('hidden'), 300);
		    }
		}

		if (menuBtn) {
			menuBtn.addEventListener('click', () => toggleSidebar(true));
		}
		if (overlay) {
			overlay.addEventListener('click', () => toggleSidebar(false));
		}

		if (newChatSidebarBtn) {
			newChatSidebarBtn.addEventListener('click', () => {
				startNewSession();
				toggleSidebar(false);
			});
		}

		function startNewSession() {
			currentSessionId = Date.now().toString();
			chatHistory = [];
			messagesArea.innerHTML = '';
			localStorage.setItem(ACTIVE_SESSION_KEY, currentSessionId);
			loadSidebarHistory();
		}

		function loadSession(id) {
			const sessions = getAllSessions();
			const session = sessions.find(s => s.id === id);
			if (session) {
				currentSessionId = id;
				chatHistory = session.history || [];
				localStorage.setItem(ACTIVE_SESSION_KEY, currentSessionId);
				renderHistory();
				loadSidebarHistory();
				toggleSidebar(false);
			} else {
				startNewSession();
			}
		}

		async function deleteSession(id, event) {
			if (event) event.stopPropagation();
			const sessions = getAllSessions();
			const sessionToDelete = sessions.find(s => s.id === id);
			if (sessionToDelete && sessionToDelete.history) {
				const idList = [];
				const regex = /idb:\/\/([a-zA-Z0-9_]+)/g;
				sessionToDelete.history.forEach(msg => {
					if (msg.parts && msg.parts[0] && msg.parts[0].text) {
						const text = msg.parts[0].text;
						let match;
						while ((match = regex.exec(text)) !== null) {
							idList.push(match[1]);
						}
					}
				});

				if (idList.length > 0) {
					for (const imgId of idList) {
						await deleteImageFromIDB(imgId).catch(err => console.error("Del IDB err:", err));
					}
				}
			}

			const newSessions = sessions.filter(s => s.id !== id);
			saveAllSessions(newSessions);

			loadSidebarHistory();

			if (newSessions.length === 0) {
				toggleSidebar(false);
			}

			if (id === currentSessionId) {
				startNewSession();
			}
		}

		function getAllSessions() {
			const stored = localStorage.getItem(STORAGE_KEY);
			return stored ? JSON.parse(stored) : [];
		}

		function saveAllSessions(sessions) {
			localStorage.setItem(STORAGE_KEY, JSON.stringify(sessions));
		}

		let swipeStartX = 0;
		let swipeCurrentEl = null;
		let swipeOpenId = null;

		function loadSidebarHistory() {
		    const sessions = getAllSessions();
		    sessions.sort((a, b) => b.timestamp - a.timestamp);
		
		    if (!historyListEl) return;
		    historyListEl.innerHTML = '';
		
		    if (sessions.length === 0) {
		        historyListEl.innerHTML = '<div class="text-center text-xs text-slate-400 mt-4">Belum ada riwayat.</div>';
		        return;
		    }
		
		    const groups = {
		        'Hari Ini': [],
		        'Kemarin': [],
		        '7 Hari Terakhir': [],
		        'Bulan Ini': [],
		        'Lebih Lama': []
		    };
		
		    const now = new Date();
		    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
		    const yesterday = new Date(today);
		    yesterday.setDate(yesterday.getDate() - 1);
		    const last7Days = new Date(today);
		    last7Days.setDate(last7Days.getDate() - 7);
		    const thisMonth = new Date(today.getFullYear(), today.getMonth(), 1);
		
		    sessions.forEach(session => {
		        const date = new Date(session.timestamp);
		        const compareDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
		
		        if (compareDate.getTime() === today.getTime()) {
		            groups['Hari Ini'].push(session);
		        } else if (compareDate.getTime() === yesterday.getTime()) {
		            groups['Kemarin'].push(session);
		        } else if (date >= last7Days) {
		            groups['7 Hari Terakhir'].push(session);
		        } else if (date >= thisMonth) {
		            groups['Bulan Ini'].push(session);
		        } else {
		            groups['Lebih Lama'].push(session);
		        }
		    });
		
		    Object.entries(groups).forEach(([label, groupSessions]) => {
		        if (groupSessions.length > 0) {
		            const groupDiv = document.createElement('div');
		            groupDiv.className = "mb-1";
		
		            const header = document.createElement('h3');
		            header.className = "px-3 text-[11px] font-black text-slate-300 mb-0.5 uppercase tracking-tighter";
		            header.innerText = label;
		            groupDiv.appendChild(header);
		
		            const listDiv = document.createElement('div');
		            listDiv.className = "space-y-0";
		
		            groupSessions.forEach(session => {
		                const isActive = session.id === currentSessionId;
		                const item = document.createElement('div');
		                item.className = "w-full h-[32px] relative overflow-hidden select-none";
		
		                const itemId = session.id;
		                item.innerHTML = `
		                    <div class="absolute inset-y-0.5 right-1 w-[45px] bg-red-50 rounded-lg flex items-center justify-center z-0" 
		                        onclick="deleteSession('${itemId}', event)">
		                        <i data-lucide="trash-2" class="w-3.5 h-3.5 text-red-500"></i>
		                    </div>
		
		                    <div class="w-full h-full bg-white absolute top-0 left-0 z-10 flex items-center px-3 transition-transform duration-200 ease-out cursor-pointer"
		                        id="swipe-content-${itemId}"
		                        onclick="handleSwipeClick('${itemId}')"
		                        ontouchstart="swipeStart(event, '${itemId}')"
		                        ontouchmove="swipeMove(event)"
		                        ontouchend="swipeEnd(event)"
		                        onmousedown="mouseSwipeStart(event, '${itemId}')">
		                            <span class="truncate text-sm ${isActive ? 'text-slate-900 font-bold' : 'text-slate-600 font-medium'} w-full">
		                                ${session.title}
		                            </span>
		                    </div>
		                `;
		                listDiv.appendChild(item);
		            });
		
		            groupDiv.appendChild(listDiv);
		            historyListEl.appendChild(groupDiv);
		        }
		    });
		
		    lucide.createIcons();
			
			document.querySelectorAll('.dropdown-option').forEach(option => {
			    option.addEventListener('click', function() {
			        currentSelectedModel = this.getAttribute('data-value');
			        document.getElementById('selected-model-text').innerText = this.innerText;
			        document.getElementById('dropdown-menu').classList.add('hidden');
			        document.getElementById('dropdown-icon').style.transform = 'rotate(0deg)';
			    });
			});
		
			document.getElementById('settings-thinking').addEventListener('input', function() {
			    const labels = ["LOW", "MEDIUM", "HIGH"];
			    document.getElementById('label-thinking').innerText = labels[this.value - 1];
			});
		}

		function unify(e) { return e.changedTouches ? e.changedTouches[0] : e; }

		let isDragging = false;
		let dragThresholdMet = false;

		function swipeStart(e, id) {
			swipeStartX = e.touches[0].clientX;
			swipeCurrentEl = document.getElementById(`swipe-content-${id}`);
			handleSwipeStartCommon(id);
		}

		function swipeMove(e) {
			if (!swipeCurrentEl) return;
			const currentX = e.touches[0].clientX;
			handleSwipeMoveCommon(currentX);
		}

		function swipeEnd(e) {
			handleSwipeEndCommon();
		}

		function mouseSwipeStart(e, id) {
			e.preventDefault();
			isDragging = true;
			dragThresholdMet = false;
			swipeStartX = e.clientX;
			swipeCurrentEl = document.getElementById(`swipe-content-${id}`);

			document.addEventListener('mousemove', mouseSwipeMove);
			document.addEventListener('mouseup', mouseSwipeEnd);

			handleSwipeStartCommon(id);
		}

		function mouseSwipeMove(e) {
			if (!isDragging || !swipeCurrentEl) return;
			handleSwipeMoveCommon(e.clientX);
		}

		function mouseSwipeEnd(e) {
			isDragging = false;
			document.removeEventListener('mousemove', mouseSwipeMove);
			document.removeEventListener('mouseup', mouseSwipeEnd);
			handleSwipeEndCommon();
		}

		function handleSwipeStartCommon(id) {
			if (swipeOpenId === id) {
				swipeCurrentEl = null;
				return;
			}

			if (swipeOpenId && swipeOpenId !== id) {
				const openEl = document.getElementById(`swipe-content-${swipeOpenId}`);
				if (openEl) openEl.style.transform = 'translateX(0)';
				swipeOpenId = null;
			}

			if (swipeCurrentEl) {
				swipeCurrentEl.style.transition = 'none';
			}
		}

		function handleSwipeMoveCommon(currentX) {
			const diff = currentX - swipeStartX;
			if (Math.abs(diff) > 5) dragThresholdMet = true;

			let newX = diff;
			if (newX < -60) newX = -60;
			if (newX > 0) newX = 0;

			swipeCurrentEl.style.transform = `translateX(${newX}px)`;
		}

		function handleSwipeEndCommon() {
			if (!swipeCurrentEl) return;
			swipeCurrentEl.style.transition = 'transform 0.2s ease-out';

			const currentTransform = swipeCurrentEl.style.transform;
			const translateX = parseInt(currentTransform.replace('translateX(', '').replace('px)', '') || '0');
			if (translateX < -30) {
				swipeCurrentEl.style.transform = 'translateX(-60px)';
				swipeOpenId = swipeCurrentEl.id.replace('swipe-content-', '');
			} else {
				swipeCurrentEl.style.transform = 'translateX(0)';
				if (swipeOpenId === swipeCurrentEl.id.replace('swipe-content-', '')) {
					swipeOpenId = null;
				}
			}
			swipeCurrentEl = null;
		}

		function handleSwipeClick(id) {
			if (dragThresholdMet) {
				dragThresholdMet = false;
				return;
			}

			const el = document.getElementById(`swipe-content-${id}`);
			if (swipeOpenId === id) {
				el.style.transform = 'translateX(0)';
				swipeOpenId = null;
			} else {
				loadSession(id);
			}
		}



		async function downloadImageFromBtn(btn, event) {
			if (event) event.stopPropagation();
			const img = btn.parentElement.querySelector('img');
			const url = img.src;

			const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

			if (isIOS) {
				if (navigator.share && url.startsWith('blob:')) {
					try {
						const blob = await fetch(url).then(r => r.blob());
						const file = new File([blob], `sinta_generated_${Date.now()}.png`, { type: blob.type });
						await navigator.share({
							files: [file]
						});
					} catch (err) {
						window.open(url, '_blank');
					}
				} else {
					window.open(url, '_blank');
				}
			} else {
				const a = document.createElement('a');
				a.href = url;
				a.download = `sinta_generated_${Date.now()}.png`;
				document.body.appendChild(a);
				a.click();
				document.body.removeChild(a);
			}
		}

		window.loadSession = loadSession;
		window.deleteSession = deleteSession;
		window.swipeStart = swipeStart;
		window.swipeMove = swipeMove;
		window.swipeEnd = swipeEnd;
		window.handleSwipeClick = handleSwipeClick;
		window.mouseSwipeStart = mouseSwipeStart;
		window.downloadImageFromBtn = downloadImageFromBtn;

		document.addEventListener('click', function (event) {
			if (swipeOpenId && !event.target.closest(`#swipe-content-${swipeOpenId}`) && !event.target.closest('.bg-red-500')) {
				const openEl = document.getElementById(`swipe-content-${swipeOpenId}`);
				if (openEl) openEl.style.transform = 'translateX(0)';
				swipeOpenId = null;
			}
		});
		
		function openVoiceMode() {
		    const screen = document.getElementById('voiceScreen');
		    if (!screen) return;
		    
		    isAISpeaking = false;
		    voiceNextTime = 0;
		    voiceInterrupted = false;
		    activeVoiceSources = [];
		    energyCounter = 0;
		    
		    screen.classList.remove('hidden');
		    screen.classList.add('flex');
		
		    setTimeout(() => {
		        resizeVoiceCanvas();
		        initVoiceSession();
		    }, 200);
		}
				
		async function initVoiceAudio() {
		    if (voiceInCtx) await voiceInCtx.close();
		    if (voiceOutCtx) await voiceOutCtx.close();
		
		    voiceInCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
		    voiceOutCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 24000 });
		    
		    await voiceInCtx.resume();
		    await voiceOutCtx.resume();
		    
		    aiAnalyser = voiceOutCtx.createAnalyser();
		    aiAnalyser.fftSize = 1024;
		    aiAnalyser.connect(voiceOutCtx.destination);
		    
		    try {
		        if (voiceStream) {
		            voiceStream.getTracks().forEach(t => t.stop());
		        }
		        
		        voiceStream = await navigator.mediaDevices.getUserMedia({ audio: true });
		        const source = voiceInCtx.createMediaStreamSource(voiceStream);
		        
		        voiceAnalyser = voiceInCtx.createAnalyser();
		        voiceAnalyser.fftSize = 1024;
		        voiceDataArray = new Uint8Array(voiceAnalyser.frequencyBinCount);
		        source.connect(voiceAnalyser);
		
		        const workletJS = `
		            class P extends AudioWorkletProcessor {
		                process(inputs) { if (inputs[0][0]) this.port.postMessage(inputs[0][0]); return true; }
		            }; registerProcessor('p', P);
		        `;
		        const url = 'data:application/javascript,' + encodeURIComponent(workletJS);
		        await voiceInCtx.audioWorklet.addModule(url);
		
		        const node = new AudioWorkletNode(voiceInCtx, 'p');
		        node.port.onmessage = (e) => {
		            if (voiceWs && voiceWs.readyState === WebSocket.OPEN) {
		                let sum = 0;
		                for (let i = 0; i < e.data.length; i++) sum += Math.abs(e.data[i]);
		                let energy = sum / e.data.length;
		
		                if (isAISpeaking && energy > 0.04) {
		                    energyCounter++;
		                    if (energyCounter > 8) {
		                        interruptVoice();
		                        energyCounter = 0;
		                    }
		                } else { energyCounter = 1; }
		
		                if (energy > 0.01 && voiceInterrupted) {
		                    voiceInterrupted = false;
		                    voiceSessionId++;
		                }
		
		                if (!voiceInterrupted && !isAISpeaking) {
		                    const int16 = new Int16Array(e.data.length);
		                    for (let i = 0; i < e.data.length; i++) int16[i] = e.data[i] * 0x7FFF;
		                    voiceWs.send(JSON.stringify({
		                        type: 'audio',
		                        data: {
		                            data: btoa(String.fromCharCode(...new Uint8Array(int16.buffer))),
		                            mimeType: 'audio/pcm;rate=16000'
		                        }
		                    }));
		                }
		            }
		        };
		        source.connect(node);
		    } catch (err) {
		        alert("Gagal akses mikrofon");
		    }
		}
				
		async function initVoiceSession() {
		    if (voiceWs) {
		        voiceWs.close();
		        voiceWs = null;
		    }
		
		    voiceNextTime = 0;
		    voiceInterrupted = false;
		    isAISpeaking = false;
		    activeVoiceSources = [];
		    energyCounter = 0;
		    voiceSessionId = Date.now();
		
		    const historyContext = chatHistory.map(h => `${h.role === 'model' ? 'ALISA' : 'User'}: ${h.parts[0].text}`).slice(-6).join('\n');
		    const fullPrompt = `${document.getElementById('systemPromptInput').value || MAIN_SYSTEM_PROMPT}\n\nKonteks Percakapan:\n${historyContext}`;
		
		    await initVoiceAudio();
		
		    try {
		        voiceWs = new WebSocket('wss://gemini-proxy-408925499207.asia-southeast2.run.app');
		        
		        voiceWs.onopen = () => {
		            startVoiceTimer();
		            voiceWs.send(JSON.stringify({
		                type: 'setup',
		                config: {
		                    responseModalities: ['AUDIO'],
		                    speechConfig: {
		                        voiceConfig: {
		                            prebuiltVoiceConfig: { voiceName: currentVoice }
		                        }
		                    },
		                    systemInstruction: fullPrompt,
		                    tools: [{ googleSearch: {} }]
		                }
		            }));
		        };
		
		        voiceWs.onmessage = (e) => {
		            if (!voiceWs || voiceInterrupted) return;
		            const res = JSON.parse(e.data);
		            if (res.type === 'gemini_msg') {
		                const modelTurn = res.data.serverContent?.modelTurn;
		                if (modelTurn && modelTurn.parts) {
		                    modelTurn.parts.forEach(p => {
		                        if (p.inlineData) {
		                            isAISpeaking = true;
		                            playVoiceAudio(p.inlineData.data, voiceSessionId);
		                        }
		                        if (p.text) syncVoiceToChat('assistant', p.text);
		                    });
		                }
		            }
		        };
		
		        voiceWs.onclose = () => {
		            if (!document.getElementById('voiceScreen').classList.contains('hidden')) {
		                console.log("Reconnecting voice...");
		            }
		        };
		            
		        startVoiceVisualizer();
		        
		    } catch (err) {
		        closeVoiceMode();
		    }
		}
		
		function playVoiceAudio(base64, sid) {
		    if (sid !== voiceSessionId || voiceInterrupted) return;
		    const binary = atob(base64);
		    const bytes = new Uint8Array(binary.length);
		    for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
		    const int16 = new Int16Array(bytes.buffer);
		    const buf = voiceOutCtx.createBuffer(1, int16.length, 24000);
		    const data = buf.getChannelData(0);
		    for (let i = 0; i < int16.length; i++) data[i] = int16[i] / 32768.0;
		    const source = voiceOutCtx.createBufferSource();
		    source.buffer = buf;
		    source.connect(aiAnalyser);
		    const now = voiceOutCtx.currentTime;
		    if (voiceNextTime < now) voiceNextTime = now;
		    source.start(voiceNextTime);
		    voiceNextTime += buf.duration;
		    activeVoiceSources.push(source);
		    source.onended = () => {
		        activeVoiceSources = activeVoiceSources.filter(s => s !== source);
		        if (activeVoiceSources.length === 0) isAISpeaking = false;
		    };
		}
		
		function interruptVoice() {
		    isAISpeaking = false;
		    voiceInterrupted = true;
		    voiceSessionId++;
		    activeVoiceSources.forEach(s => { try { s.stop(); s.disconnect(); } catch(e){} });
		    activeVoiceSources = [];
		    if (voiceWs && voiceWs.readyState === WebSocket.OPEN) voiceWs.send(JSON.stringify({ type: 'cancel' }));
		}
		
		function syncVoiceToChat(role, text) {
		    const lastMsg = chatHistory[chatHistory.length - 1];
		    if (lastMsg && lastMsg.role === (role === 'assistant' ? 'model' : 'user') && lastMsg._isVoice) {
		        lastMsg.parts[0].text += " " + text;
		    } else {
		        chatHistory.push({ role: role === 'assistant' ? 'model' : 'user', parts: [{ text }], _isVoice: true });
		        appendMessageToUI(role === 'assistant' ? 'model' : 'user', text);
		    }
		}
		
		function startVoiceTimer() {
		    let sec = 0;
		    const el = document.getElementById('voice-timer');
		    if (!el) return;
		    clearInterval(voiceTimerInterval);
		    voiceTimerInterval = setInterval(() => {
		        sec++;
		        const hrs = Math.floor(sec / 3600).toString().padStart(2, '0');
		        const mins = Math.floor((sec % 3600) / 60).toString().padStart(2, '0');
		        const secs = (sec % 60).toString().padStart(2, '0');
		        if (el) el.innerText = `${hrs}:${mins}:${secs}`;
		    }, 1000);
		}
		
		function closeVoiceMode() {
		    if (voiceWs) { 
		        voiceWs.onmessage = null; 
		        voiceWs.close(); 
		        voiceWs = null; 
		    }
		    if (voiceStream) { 
		        voiceStream.getTracks().forEach(t => t.stop()); 
		        voiceStream = null; 
		    }
		    if (voiceInCtx) { 
		        voiceInCtx.close(); 
		        voiceInCtx = null; 
		    }
		    if (voiceOutCtx) { 
		        voiceOutCtx.close(); 
		        voiceOutCtx = null; 
		    }
		    stopVoiceCamera();
		    clearInterval(voiceTimerInterval);
		    isAISpeaking = false;
		    voiceInterrupted = false;
		    activeVoiceSources = [];
		    energyCounter = 0;
		    
		    const screen = document.getElementById('voiceScreen');
		    if (screen) { 
		        screen.classList.add('hidden'); 
		        screen.classList.remove('flex'); 
		    }
		}
		
		async function switchCamera() {
		    if (!isVoiceCamOn) return;
		    facingMode = (facingMode === 'user') ? 'environment' : 'user';
		    if (voiceCamStream) voiceCamStream.getTracks().forEach(t => t.stop());
		    isVoiceCamOn = false;
		    await toggleVoiceCamera();
		}
		
		async function toggleVoiceCamera() {
		    const btn = document.getElementById('cameraToggleBtn');
		    const video = document.getElementById('voice-large-video');
		    const canvas = document.getElementById('voice-canvas');
		    const box = document.getElementById('voice-visual-box');
		
		    if (!isVoiceCamOn) {
		        try {
		            voiceCamStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode } });
		            video.srcObject = voiceCamStream;
		            video.classList.remove('hidden');
		            canvas.classList.add('hidden');
		            box.classList.add('shadow-xl', 'rounded-[2rem]');
		            isVoiceCamOn = true;
		            btn.classList.replace('text-slate-500', 'text-blue-600');
		            if (voiceCamInterval) clearInterval(voiceCamInterval);
		            voiceCamInterval = setInterval(sendVoiceFrame, 1000);
		        } catch (e) { alert("Gagal Kamera"); }
		    } else { stopVoiceCamera(); }
		}
		
		function stopVoiceCamera() {
		    if (voiceCamStream) voiceCamStream.getTracks().forEach(t => t.stop());
		    clearInterval(voiceCamInterval);
		    const btn = document.getElementById('cameraToggleBtn');
		    const box = document.getElementById('voice-visual-box');
		    if (btn) btn.classList.replace('text-blue-600', 'text-slate-500');
		    document.getElementById('voice-large-video').classList.add('hidden');
		    document.getElementById('voice-canvas').classList.remove('hidden');
		    box.classList.remove('shadow-xl', 'rounded-[2rem]');
		    isVoiceCamOn = false;
		}
		
		function sendVoiceFrame() {
		    if (voiceWs && voiceWs.readyState === WebSocket.OPEN && isVoiceCamOn) {
		        const video = document.getElementById('voice-large-video');
		        const frameCanvas = document.getElementById('voice-frame-canvas');
		        const ctx = frameCanvas.getContext('2d');
		        if (video.videoWidth > 0) {
		            frameCanvas.width = 320;
		            frameCanvas.height = (video.videoHeight / video.videoWidth) * 320;
		            ctx.drawImage(video, 0, 0, frameCanvas.width, frameCanvas.height);
		            const base64 = frameCanvas.toDataURL('image/jpeg', 0.5).split(',')[1];
		            voiceWs.send(JSON.stringify({ type: 'image', data: { mimeType: "image/jpeg", data: base64 } }));
		        }
		    }
		}
		
		function resizeVoiceCanvas() {
		    const canvas = document.getElementById('voice-canvas');
		    const container = document.getElementById('voice-visual-box');
		    if (!canvas || !container) return;
		    
		    const dpr = window.devicePixelRatio || 1;
		    const rect = container.getBoundingClientRect();
		    
		    const size = Math.min(rect.width, rect.height) * 0.82;
		    
		    canvas.style.width = size + 'px';
		    canvas.style.height = size + 'px';
		    canvas.width = size * dpr;
		    canvas.height = size * dpr;
		}
		
		function startVoiceVisualizer() {
		    const canvas = document.getElementById('voice-canvas');
		    const ctx = canvas.getContext('2d');
		    let currentVol = 0;
		
		    function draw() {
		        if (document.getElementById('voiceScreen').classList.contains('hidden')) return;
		        requestAnimationFrame(draw);
		        
		        const w = canvas.width, h = canvas.height;
		        ctx.clearRect(0, 0, w, h);
		
		        const activeAn = isAISpeaking ? aiAnalyser : voiceAnalyser;
		        if (!activeAn) return;
		
		        activeAn.getByteFrequencyData(voiceDataArray);
		        
		        let sum = 0;
		        for (let i = 10; i < 150; i++) sum += voiceDataArray[i];
		        let targetVol = sum / 140;
		        
		        currentVol += (targetVol - currentVol) * 0.1;
		        
		        const centerX = w / 2, centerY = h / 2;
		        const baseRadius = Math.min(w, h) / 8;
		        
		        const maxRadius = (Math.min(w, h) / 2) - 20;
		        
		        let dynamicRadius = baseRadius + (currentVol * (maxRadius / 150));
		        if (dynamicRadius > maxRadius) dynamicRadius = maxRadius;
		        if (dynamicRadius < baseRadius) dynamicRadius = baseRadius;
		
		        ctx.beginPath();
		        ctx.arc(centerX, centerY, dynamicRadius, 0, Math.PI * 2);
		        
		        const grad = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, dynamicRadius);
		        grad.addColorStop(0, '#f8fafc');
		        grad.addColorStop(0.8, '#f1f5f9');
		        grad.addColorStop(1, '#e2e8f0');
		        
		        ctx.fillStyle = grad;
		        ctx.shadowBlur = 40;
		        ctx.shadowColor = 'rgba(0,0,0,0.04)';
		        ctx.fill();
		        
		        ctx.strokeStyle = '#f1f5f9';
		        ctx.lineWidth = 1.5;
		        ctx.stroke();
		    }
		    draw();
		}
		
		async function init() {
		    const loadingOverlay = document.getElementById('loadingOverlay');
		    const { data: { session } } = await _supabase.auth.getSession();
		
		    if (!session) {
		        if (loadingOverlay) loadingOverlay.remove();
		        loginScreen.style.display = 'flex';
		    } else {
		        if (session.user && session.user.email) sidebarEmail.innerText = session.user.email;
		        
		        setTimeout(() => {
		            if (loadingOverlay) {
		                loadingOverlay.style.opacity = '0';
		                loadingOverlay.style.visibility = 'hidden';
		                
		                setTimeout(() => {
		                    showApp();
		                    loadingOverlay.remove();
		                }, 500);
		            } else {
		                showApp();
		            }
		        }, 2000);
		    }
		
		    const savedLevel = localStorage.getItem('alisa_thinking') || "2";
		    const savedPrompt = localStorage.getItem('alisa_prompt') || MAIN_SYSTEM_PROMPT;
		    const savedModel = localStorage.getItem('alisa_model') || "gemini-3-flash-preview";
		    const savedTemp = localStorage.getItem('alisa_temp') || "1.0";
		    const savedTokens = localStorage.getItem('alisa_tokens') || "65536";
		    const savedVoice = localStorage.getItem('alisa_voice') || "Kore";
		
		    document.getElementById('settings-thinking').value = savedLevel;
		    document.getElementById('label-thinking').innerText = ["LOW", "MEDIUM", "HIGH"][savedLevel - 1];
		    document.getElementById('systemPromptInput').value = savedPrompt;
		    document.getElementById('settings-temp').value = savedTemp;
		    document.getElementById('label-temp').innerText = savedTemp;
		    document.getElementById('settings-tokens').value = savedTokens;
		    document.getElementById('label-tokens').innerText = savedTokens;
		    
		    currentSelectedModel = savedModel;
		    const modelMapping = {
		        "gemini-2.5-pro": "Gemini 2.5 Pro",
		        "gemini-2.5-flash": "Gemini 2.5 Flash",
		        "gemini-2.5-flash-lite": "Gemini 2.5 Flash Lite",
		        "gemini-3-flash-preview": "Gemini 3 Flash",
		        "gemini-3-pro-preview": "Gemini 3 Pro",
		        "gemini-3-deep-think-preview": "Gemini 3 Deep Think"
		    };
		    const modelLabelEl = document.getElementById('selected-model-text');
		    if (modelLabelEl) modelLabelEl.innerText = modelMapping[savedModel] || "Gemini 3 Flash";
		
		    currentVoice = savedVoice;
		    const voiceLabelEl = document.getElementById('selected-voice-text');
		    if (voiceLabelEl) {
		        const vMap = { "Kore": "Kore (Default)", "Aoede": "Aoede", "Zephyr": "Zephyr", "Leda": "Leda", "Fenrir": "Fenrir" };
		        voiceLabelEl.innerText = vMap[savedVoice] || "Kore (Default)";
		    }
		
		    document.getElementById('voice-trigger').onclick = (e) => {
		        e.stopPropagation();
		        const menu = document.getElementById('voice-menu');
		        const icon = document.getElementById('voice-icon');
		        const isHidden = menu.classList.toggle('hidden');
		        if (icon) {
		            icon.style.transform = isHidden ? 'rotate(0deg)' : 'rotate(180deg)';
		        }
		    };
		    
		    document.querySelectorAll('.voice-option').forEach(opt => {
		        opt.onclick = function(e) {
		            e.stopPropagation();
		            currentVoice = this.getAttribute('data-value');
		            document.getElementById('selected-voice-text').innerText = this.innerText;
		            document.getElementById('voice-menu').classList.add('hidden');
		            saveAdminSettings();
		        };
		    });
		
		    document.getElementById('voiceBtn').onclick = openVoiceMode;
		    document.getElementById('backFromVoice').onclick = closeVoiceMode;
		    document.getElementById('endCallBtn').onclick = closeVoiceMode;
		    document.getElementById('cameraToggleBtn').onclick = toggleVoiceCamera;
		    document.getElementById('switchCameraBtn').onclick = switchCamera;
		
		    const savedActiveID = localStorage.getItem(ACTIVE_SESSION_KEY);
		    if (savedActiveID) {
		        currentSessionId = savedActiveID;
		        loadSession(currentSessionId);
		    } else {
		        startNewSession();
		    }
		    
		    loadSidebarHistory();
		
		    const chatContainer = document.getElementById('chatContainer');
		    const adminScroller = document.getElementById('adminScroller');
		
		    const setupPreventStick = (el) => {
		        if (!el) return;
		        el.addEventListener('touchstart', () => {
		            const top = el.scrollTop;
		            const totalScroll = el.scrollHeight;
		            const currentScroll = top + el.offsetHeight;
		            if (top === 0) {
		                el.scrollTop = 1;
		            } else if (currentScroll >= totalScroll) {
		                el.scrollTop = top - 1;
		            }
		        }, { passive: true });
		    };
		
		    setupPreventStick(chatContainer);
		    setupPreventStick(adminScroller);
		}
		init();
	</script>
</body>

</html>
